<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoCog Research (Multilingual)</title>
    
    <!-- MediaPipe Vision (Face Landmarker) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.mjs" type="module"></script>
    <script>
        // –ó–∞–≥ru–∑–∫–∞ MediaPipe –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è non-module —Å–∫—Ä–∏–ø—Ç–æ–≤
        import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.mjs')
            .then(vision => {
                window.FilesetResolver = vision.FilesetResolver;
                window.FaceLandmarker = vision.FaceLandmarker;
                window.ImageSegmenter = vision.ImageSegmenter;
                console.log('[MediaPipe] Vision modules loaded (FaceLandmarker + ImageSegmenter)');
            })
            .catch(err => console.error('[MediaPipe] Load error:', err));
    </script>
    
    <!-- CDN WebGazer -->
    <script src="https://cdn.jsdelivr.net/npm/webgazer@3.3.0/dist/webgazer.min.js"></script>
    
    <!-- PreCheck Analyzer Module (v2.0 MediaPipe Face Landmarker) -->
    <script src="js/precheck-analyzer.js?v=2.1.1"></script>
    <!-- Face Segmenter Module (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —á–∞—Å—Ç–µ–π –ª–∏—Ü–∞) -->
    <script src="js/face-segmenter.js?v=1.2.1"></script>
    <!-- QC Metrics Module -->
    <script src="js/qc-metrics.js?v=1.0.2"></script>
    <!-- –≠–º–æ—Ü–∏–∏ -->
    <script src="js/emotions.js"></script>
    <!-- –ú–∞—Å–∫–∏ -->
    <script src="js/face-mask-collector.js"></script>

    
    <style>
        /* CSS - –°—Ç–∏–ª–∏ */
        :root {
            --primary: #2563EB;
            --primary-hover: #1D4ED8;
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #111827;
            --text-secondary: #4B5563;
            --border: #E5E7EB;
            --input-bg: #F9FAFB;
            --header-bg: #FFFFFF;
            --success: #16a34a;
            --warning: #f59e0b;
            --error: #dc2626;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding-top: 70px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--header-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .id-badge {
            font-family: 'Monaco', monospace; font-size: 12px; background: #EFF6FF;
            color: var(--primary); padding: 6px 12px; border-radius: 6px;
            border: 1px solid #BFDBFE; display: none; cursor: pointer; margin-right: 15px;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ */
        .lang-switch {
            display: flex; gap: 5px; font-size: 13px; font-weight: 600;
        }
        .lang-btn {
            cursor: pointer; padding: 4px 8px; border-radius: 4px; color: var(--text-secondary);
            transition: all 0.2s;
        }
        .lang-btn.active {
            background-color: var(--primary); color: white;
        }

        .container {
            background-color: var(--card-bg); width: 100%; max-width: 680px;
            padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-top: 20px; margin-bottom: 40px; position: relative;
        }

        .step { display: none; animation: fadeIn 0.4s ease; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 28px; margin-bottom: 10px; text-align: center; }
        h2 { font-size: 24px; margin-bottom: 20px; text-align: center; }
        h3 { font-size: 14px; margin-top: 25px; margin-bottom: 15px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            background-color: var(--primary); color: white; border: none; padding: 16px 28px;
            border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;
            transition: all 0.2s; margin-top: 20px;
        }
        .btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { background-color: #E5E7EB; color: #9CA3AF; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: transparent; color: var(--text-secondary); margin-top: 10px; border: 1px solid var(--border); }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
        .form-group select, .form-group input {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 15px; background-color: var(--input-bg); box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .form-group select.error, .form-group input.error {
            border-color: var(--error);
            background-color: #FEF2F2;
        }
        .form-group select[aria-invalid="true"], .form-group input[aria-invalid="true"] {
            border-color: var(--error);
            background-color: #FEF2F2;
        }
        .error-message, .field-error {
            color: var(--error);
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }

        .consent-box { background: #F8FAFC; padding: 20px; border-radius: 12px; height: 200px; overflow-y: auto; font-size: 14px; margin-bottom: 20px; border: 1px solid var(--border); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; border: 2px solid var(--border); border-radius: 12px; }

        /* –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ */
        .calibration-area {
            height: 350px; background: #F8FAFC; border: 2px dashed var(--border);
            border-radius: 12px; position: relative; overflow: hidden;
        }
        
        .calib-point {
            width: 30px; height: 30px; background-color: #DC2626;
            position: absolute; transition: all 0.5s ease; cursor: pointer; z-index: 20;
            filter: drop-shadow(0 0 6px rgba(220, 38, 38, 0.6));
        }
        .calib-point.circle { border-radius: 50%; clip-path: none; }
        .calib-point.square { border-radius: 4px; clip-path: none; transform: rotate(45deg); }
        .calib-point.star {
            border-radius: 0; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            background-color: #DC2626;
        }

        #webgazerVideoContainer {
            position: fixed !important; top: 70px !important; left: 10px !important;
            width: 160px !important; height: 120px !important;
            border-radius: 8px; border: 2px solid var(--primary); opacity: 0.8; z-index: 50;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ç–æ—á–∫—É WebGazer (–æ–Ω–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –º—ã—à—å—é) */
        #webgazerGazeDot {
            display: none !important;
        }
        
        /* –ù–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∑–≥–ª—è–¥–∞ */
        #customGazeDot {
            position: fixed;
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 0, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            display: none;
        }

        .face-status { font-weight: bold; margin-top: 10px; font-size: 14px; }
        .status-ok { color: var(--success); }
        .status-err { color: var(--error); }

        /* –¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ —Ñ–∏–≥—É—Ä–∞–º–∏ */
        .tracking-test-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a2e;
            z-index: 2000;
            display: none;
        }
        
        .tracking-test-area.active {
            display: block;
        }
        
        .test-shape {
            position: absolute;
            width: 50px;
            height: 50px;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .test-shape.circle {
            background: #FF6B6B;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
        }
        
        .test-shape.square {
            background: #4ECDC4;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.6);
        }
        
        .test-shape.triangle {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid #FFE66D;
            background: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 230, 109, 0.6));
        }
        
        .test-progress {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            z-index: 2001;
            text-align: center;
        }
        
        .test-progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 10px;
        }
        
        .test-progress-fill {
            height: 100%;
            background: #4ECDC4;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* Fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ */
        .fullscreen-calibration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a2e;
            z-index: 2000;
            display: none;
        }
        
        .fullscreen-calibration.active {
            display: block;
        }
        
        .fullscreen-calib-point {
            width: 40px;
            height: 40px;
            background-color: #DC2626;
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2001;
            filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.8));
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        
        .fullscreen-calib-point:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .calib-instruction {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 2002;
        }
        
        .calib-progress {
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        /* pre-check */
        .precheck-container {
            margin: 25px 0;
        }

        .camera-preview {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 360px;
            margin: 0 auto 25px;
            border-radius: 12px;
            overflow: hidden;
            background: #1a1a2e;
            border: 3px solid #E5E7EB;
            transition: border-color 0.3s ease;
        }

        .camera-preview.green-border {
            border-color: var(--success) !important;
        }

        .camera-preview.red-border {
            border-color: var(--error) !important;
        }

        #precheckVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .face-guide {
            position: absolute;
            top: 20%;
            left: 20%;
            right: 20%;
            bottom: 20%;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            pointer-events: none;
            transition: border-color 0.3s ease;
        }

        .guide-text {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (pre-check) */
        .indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .indicator .icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #9CA3AF;
        }

        .indicator .label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
            margin-bottom: 6px;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: #9CA3AF;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .indicator .status {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
            text-align: center;
            min-height: 16px;
            color: #9CA3AF;
        }

        /* –°—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (pre-check) */
        .indicator.passed .progress-bar {
            background-color: rgba(16, 163, 74, 0.7);
        }

        .indicator.passed .icon {
            color: var(--success);
        }

        .indicator.passed .status {
            color: var(--success);
        }

        .indicator.failed .progress-bar {
            background-color: rgba(239, 68, 68, 0.7);
        }

        .indicator.failed .icon {
            color: var(--error);
        }

        .indicator.failed .status {
            color: var(--error);
        }

        /* –°—Ç–∞—Ç—É—Å –ø—Ä–µ—á–µ–∫–∞ - –±–ª–æ–∫ */
        .precheck-status {
            text-align: center;
            margin: 20px 0;
            padding: 18px;
            border-radius: 8px;
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            animation: fadeIn 0.4s ease;
            transition: all 0.3s ease;
        }

        .precheck-status.success-bg {
            background: #F0F9FF;
            border-color: #BBF7D0;
            color: #166534;
        }

        .precheck-status.error-bg {
            background: #FEF2F2;
            border-color: #FECACA;
            color: #991B1B;
        }

        .precheck-status.waiting-bg {
            background: #FFFBEB;
            border-color: #FDE68A;
            color: #92400E;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å–Ω–æ–≥–æ –±–ª–æ–∫–∞ */
        .precheck-status .status-message {
            font-size: 15px;
            font-weight: 500;
            margin: 0;
            line-height: 1.4;
            color: inherit;
        }

        .precheck-status .status-message.success,
        .precheck-status .status-message.error,
        .precheck-status .status-message.waiting {
            background: transparent !important;
            border: none !important;
            color: inherit !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        .status-header {
            text-align: center;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 16px;
            display: block;
            color: inherit;
        }

        .tips-list {
            text-align: left;
            margin: 10px 0 0 0;
            padding-left: 20px;
            color: inherit;
        }

        .tip-item {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 6px;
            color: inherit;
        }

        .precheck-status.error-bg .tip-item {
            color: #991B1B;
        }

        .precheck-status.error-bg .tips-subtitle {
            text-align: left;
            color: #991B1B;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .precheck-status.success-bg .tip-item {
            color: #166534;
        }

        .precheck-status.waiting-bg .tip-item {
            color: #92400E;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ */
        .tips-list {
            text-align: left;
            margin: 10px 0 0 0;
            padding-left: 20px;
            color: inherit;
            list-style-type: none;
        }

        .tip-item {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
            color: inherit;
            position: relative;
            padding-left: 16px;
        }

        .tip-item::before {
            content: "";
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .precheck-status.error-bg .tip-item::before {
            background-color: #991B1B; /* –ö—Ä–∞—Å–Ω—ã–π */
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-buttons .btn {
            flex: 1;
            margin-top: 0;
        }
    </style>
</head>
<body>

    <!-- Fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ -->
    <div id="fullscreenCalibration" class="fullscreen-calibration">
        <div class="calib-instruction">
            <span id="calibInstructionText">üëÜ –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É, —Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–µ—ë</span>
            <div class="calib-progress">
                <span id="calibProgressText">–¢–æ—á–∫–∞ 1 –∏–∑ 9</span>
            </div>
        </div>
        <div id="fullscreenCalibPoint" class="fullscreen-calib-point"></div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Ç–µ—Å—Ç–∞ —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ —Ñ–∏–≥—É—Ä–∞–º–∏ (fullscreen) -->
    <div id="trackingTestArea" class="tracking-test-area">
        <div class="test-progress">
            <span id="testProgressText">–°–ª–µ–¥–∏—Ç–µ –≥–ª–∞–∑–∞–º–∏ –∑–∞ —Ñ–∏–≥—É—Ä–æ–π</span>
            <div class="test-progress-bar">
                <div class="test-progress-fill" id="testProgressFill" style="width: 0%"></div>
            </div>
        </div>
        <div id="testShape" class="test-shape circle"></div>
    </div>

    <!-- –ù–∞—à–∞ —Ç–æ—á–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∑–≥–ª—è–¥–∞ -->
    <div id="customGazeDot"></div>

    <!-- –®–∞–ø–∫–∞ -->
    <div class="top-bar">
        <div style="font-weight: bold; color: var(--text-main);">EmoCog Research</div>
        <div style="display: flex; align-items: center;">
            <div id="idDisplay" class="id-badge" onclick="copyIds()" title="Copy ID">ID: ...</div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
            <div class="lang-switch">
                <div class="lang-btn active" id="langRu" onclick="setLanguage('ru')">RU</div>
                <div style="color:#E5E7EB">|</div>
                <div class="lang-btn" id="langEn" onclick="setLanguage('en')">EN</div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- –®–ê–ì 1: –õ—ç–Ω–¥–∏–Ω–≥ -->
        <div id="step1" class="step active">
            <h1 data-i18n="welcome_title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
            <p style="text-align: center;" data-i18n="welcome_subtitle">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ –≤–Ω–∏–º–∞–Ω–∏—è –∏ —ç–º–æ—Ü–∏–π</p>
            
            <div style="background: #FEF2F2; padding: 15px; border-radius: 8px; border: 1px solid #FECACA; margin: 20px 0;">
                <strong style="color: #991B1B;" data-i18n="warning_title">‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong>
                <ul style="margin: 10px 0 0 20px; color: #7F1D1D; font-size: 14px;">
                    <li data-i18n="warning_1">–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–µ–±-–∫–∞–º–µ—Ä–∞</li>
                    <li data-i18n="warning_2">–î–∞–Ω–Ω—ã–µ –æ –≤–∑–≥–ª—è–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</li>
                    <li data-i18n="warning_3">–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ –≤–∞—à–µ–≥–æ –ª–∏—Ü–∞</li>
                </ul>
            </div>

            <button class="btn" onclick="nextStep(2)" data-i18n="btn_start">–ù–∞—á–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</button>
        </div>

        <!-- –®–ê–ì 2: –°–æ–≥–ª–∞—Å–∏–µ -->
        <div id="step2" class="step">
            <h2 data-i18n="consent_header">–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ</h2>
            <div class="consent-box">
                <h4 data-i18n="consent_1_title">1. –¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h4>
                <p data-i18n="consent_1_text">–ú—ã –ø—Ä–æ–≤–æ–¥–∏–º –Ω–∞—É—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π. –í–∞—à–µ —É—á–∞—Å—Ç–∏–µ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –ª—é–¥–∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
                <h4 data-i18n="consent_2_title">2. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</h4>
                <p data-i18n="consent_2_text">–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
                <p><a href="https://docs.google.com/document/d/1ILmtItogsXz78ozzsKLNkmWnRVm990MvSryaDPSbxzg/edit?usp=sharing" target="_blank" data-i18n="consent_link">–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—Å–∏—è</a></p>
            </div>
            <label class="checkbox-wrapper">
                <input type="checkbox" id="consentCheck" onchange="toggleConsent()">
                <span data-i18n="consent_checkbox">–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞), –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç, –∏ —è —Å–æ–≥–ª–∞—Å–µ–Ω(–∞).</span>
            </label>
            <button class="btn" id="consentBtn" disabled onclick="generateIdsAndProceed()" data-i18n="btn_confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>

        <!-- –®–ê–ì 3: Email -->
        <div id="step3" class="step">
            <h2 data-i18n="reg_title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <p data-i18n="reg_desc">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Email –¥–ª—è —Å–≤—è–∑–∏.</p>
            
            <div class="form-group">
                <label data-i18n="email_label">Email</label>
                <input type="email" id="userEmail" placeholder="name@example.com" onblur="validateEmailField()">
            </div>
            
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                <span id="generatedIdPreview"></span>
            </div>

            <button class="btn" onclick="collectTechDataAndProceed()" data-i18n="btn_next" id="step3NextBtn">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–ê–ì 4: –ê–Ω–∫–µ—Ç–∞ -->
         <div id="step4" class="step">
            <h2 data-i18n="form_title">–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <form id="userForm" onchange="checkForm()">
                <h3 data-i18n="form_section_user">üë§ –û –≤–∞—Å</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_age">–í–æ–∑—Ä–∞—Å—Ç</label>
                        <input type="number" id="age" min="18" max="99" onblur="checkForm()" oninput="checkForm()">
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_gender">–ü–æ–ª</label>
                        <select id="gender">
                            <option value="" disabled selected data-i18n="opt_select">–í—ã–±—Ä–∞—Ç—å...</option>
                            <option value="m" data-i18n="opt_m">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="f" data-i18n="opt_f">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_lang">–†–æ–¥–Ω–æ–π —è–∑—ã–∫</label>
                        <select id="language">
                            <option value="ru" data-i18n="opt_ru">ru—Å—Å–∫–∏–π</option>
                            <option value="en" data-i18n="opt_en">English</option>
                            <option value="other" data-i18n="opt_other">–îru–≥–æ–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_edu">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</label>
                        <select id="education">
                            <option value="student" data-i18n="opt_edu_school">–°—Ä–µ–¥–Ω–µ–µ</option>
                            <option value="student" data-i18n="opt_edu_student">–°—Ç—É–¥–µ–Ω—Ç</option>
                            <option value="higher" data-i18n="opt_edu_higher">–í—ã—Å—à–µ–µ</option>
                            <option value="degree" data-i18n="opt_edu_degree">–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å</option>
                        </select>
                    </div>
                </div>

                <h3 data-i18n="form_section_tech">üëÅÔ∏è –ó—Ä–µ–Ω–∏–µ –∏ –û–±–æru–¥–æ–≤–∞–Ω–∏–µ</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_vision">–ó—Ä–µ–Ω–∏–µ</label>
                        <select id="vision">
                            <option value="normal" data-i18n="opt_vis_norm">–ù–æ—Ä–º–∞</option>
                            <option value="glasses" data-i18n="opt_vis_glass">–û—á–∫–∏</option>
                            <option value="lenses" data-i18n="opt_vis_lens">–õ–∏–Ω–∑—ã</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_pathology">–ü–∞—Ç–æ–ª–æ–≥–∏–∏</label>
                        <select id="visionIssues">
                            <option value="none" data-i18n="opt_path_none">–ù–µ—Ç</option>
                            <option value="hemianopsia" data-i18n="opt_path_hemi">–ì–µ–º–∏–∞–Ω–æ–ø—Å–∏—è</option>
                            <option value="scotoma" data-i18n="opt_path_scot">–°–∫–æ—Ç–æ–º–∞</option>
                            <option value="colorblind" data-i18n="opt_path_color">–î–∞–ª—å—Ç–æ–Ω–∏–∑–º</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_hand">–í–µ–¥—É—â–∞—è ru–∫–∞</label>
                        <select id="hand">
                            <option value="right" data-i18n="opt_hand_r">–ü—Ä–∞–≤–∞—è</option>
                            <option value="left" data-i18n="opt_hand_l">–õ–µ–≤–∞—è</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_device">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–≤–æ–¥–∞</label>
                        <select id="inputDevice">
                            <option value="mouse" data-i18n="opt_dev_mouse">–ú—ã—à—å</option>
                            <option value="touchpad" data-i18n="opt_dev_touch">–¢–∞—á–ø–∞–¥</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_keyboard">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞</label>
                         <select id="keyboardType">
                            <option value="internal" data-i18n="opt_kb_int">–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è</option>
                            <option value="external" data-i18n="opt_kb_ext">–í–Ω–µ—à–Ω—è—è</option>
                        </select>
                    </div>
                </div>
            </form>
            <button class="btn" id="formBtn" disabled onclick="if (!document.getElementById('formBtn').disabled) nextStep(5);" data-i18n="btn_next">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–ê–ì 5: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã (pre-check) -->
        <div id="step5" class="step">
            <h2 data-i18n="calib_title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã</h2>
            <p data-i18n="calib_desc">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –∑–∞—Ç–µ–º –Ω–∞—á–Ω—ë–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.</p>
            
            <div id="precheckContainer" class="precheck-container">
                <!-- –ü—Ä–µ–≤—å—é –∫–∞–º–µ—Ä—ã -->
                <div id="cameraPreview" class="camera-preview">
                    <video id="precheckVideo" autoplay playsinline muted></video>
                    <canvas id="overlayCanvas"></canvas>
                    <div class="face-guide"></div>
                    <div class="guide-text" data-i18n="guide_text">–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ –ª–∏—Ü–æ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏</div>
                </div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
                <div class="indicators">
                    <div class="indicator" id="LightIndicator">
                        <div class="icon">üí°</div>
                        <div class="label" data-i18n="label_light">–û—Å–≤–µ—â–µ–Ω–∏–µ</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="LightProgress"></div>
                        </div>
                        <div class="status" id="LightStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                    
                    <div class="indicator" id="FaceIndicator">
                        <div class="icon">üë§</div>
                        <div class="label" data-i18n="label_face">–õ–∏—Ü–æ</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="FaceProgress"></div>
                        </div>
                        <div class="status" id="FaceStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                    
                    <div class="indicator" id="PoseIndicator">
                        <div class="icon">üéØ</div>
                        <div class="label" data-i18n="label_pose">–ü–æ–∑–∞ –≥–æ–ª–æ–≤—ã</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="PoseProgress"></div>
                        </div>
                        <div class="status" id="PoseStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                    
                    <div class="indicator" id="VisibilityIndicator">
                        <div class="icon">üëÅÔ∏è</div>
                        <div class="label" data-i18n="label_visibility">–í–∏–¥–∏–º–æ—Å—Ç—å –ª–∏—Ü–∞</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="VisibilityProgress"></div>
                        </div>
                        <div class="status" id="VisibilityStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="precheck-status">
                    <p class="status-message" id="statusMessage" data-i18n="precheck_initial">
                        –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É" —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µru
                    </p>
                </div>
            </div>
            
            <!-- –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å (—Å–∫—Ä—ã—Ç–∞ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ) -->
            <div id="calibArea" style="display: none;">
                <div class="calibration-area">
                    <div class="calib-point circle" id="calibPoint" style="top: 50%; left: 50%; display: none;"></div>
                    
                    <div id="loadingMsg" style="position: absolute; top: 40%; width: 100%; text-align: center; color: var(--text-secondary);">
                        <div style="margin-bottom: 10px;" data-i18n="msg_press_btn">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏...</div>
                    </div>
                    
                    <div id="faceStatusMsg" style="position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 12px; display:none;">
                        <span data-i18n="status_label">–°—Ç–∞—Ç—É—Å:</span> <span id="faceStatusText">...</span> <br>
                        <span data-i18n="points_label">–ó–∞–ø–∏—Å–∞–Ω–æ —Ç–æ—á–µ–∫:</span> <span id="pointsCounter">0</span>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-buttons">
                <button class="btn" id="startPrecheckBtn" onclick="startPreCheck()" data-i18n="btn_start_precheck">
                    üé• –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                </button>
                <button class="btn" id="startCalibBtn" style="display: none;" onclick="startWebGazerCalibration()" data-i18n="btn_start_calib">
                    ‚úÖ –ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                </button>
            </div>
        </div>

        <!-- –®–ê–ì 6: –§–∏–Ω–∞–ª -->
        <div id="step6" class="step">
            <h2 data-i18n="final_title">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p data-i18n="final_desc">–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ. –î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.</p>
            
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ QC —Å—Ç–∞—Ç—É—Å–∞ -->
            <div id="qcStatusBlock">
                <div style="background: #F0FDF4; padding: 15px; border-radius: 8px; border: 1px solid #BBF7D0; color: #166534; margin-bottom: 20px;">
                    <span data-i18n="qc_passed">‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã (QC Passed)</span>
                </div>
            </div>
            
            <button class="btn" onclick="downloadData()" data-i18n="btn_download">üì• –°–∫–∞—á–∞—Ç—å JSON</button>
            <button class="btn btn-secondary" onclick="location.reload()" data-i18n="btn_restart">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>

    </div>

    <script>
        const BACKEND_CONFIG = {
            BASE_URL: 'http://localhost:5000', 
            ENDPOINTS: {
                ANALYZE_FRAME: '/api/analyze-frame'
            },
            SEND_INTERVAL: 300, // –æ—Ç–ø–∞—Ä–≤–ª—è–µ–º –∫–∞–¥—Ä—ã –∫–∞–∂–¥—ã–µ 300–º—Å
            MAX_FRAME: 60, // –º–∞–∫—Å–∏–º—É–º 60 –∫–∞–¥—Ä–æ–≤
            COMPRESSION_QUALITY: 0.7 // –∫–∞—á–µ—Å—Ç–≤–æ JPEG –¥–ª—è —Å–∂–∞—Ç–∏—è
        };

        // --- –°–õ–û–í–ê–†–¨ (TRANSLATIONS) ---
        const translations = {
            ru: {
                welcome_title: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
                welcome_subtitle: "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ –≤–Ω–∏–º–∞–Ω–∏—è –∏ —ç–º–æ—Ü–∏–π",
                warning_title: "‚ö†Ô∏è –í–∞–∂–Ω–æ:",
                warning_1: "–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–µ–±-–∫–∞–º–µ—Ä–∞",
                warning_2: "–î–∞–Ω–Ω—ã–µ –æ –≤–∑–≥–ª—è–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ",
                warning_3: "–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ –≤–∞—à–µ–≥–æ –ª–∏—Ü–∞",
                btn_start: "–ù–∞—á–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ",
                consent_header: "–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ",
                consent_1_title: "1. –¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
                consent_1_text: "–ú—ã –ø—Ä–æ–≤–æ–¥–∏–º –Ω–∞—É—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π. –í–∞—à–µ —É—á–∞—Å—Ç–∏–µ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –ª—é–¥–∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.",
                consent_2_title: "2. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å",
                consent_2_text: "–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.",
                consent_link: "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—Å–∏—è",
                consent_checkbox: "–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞), –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç, –∏ —è —Å–æ–≥–ª–∞—Å–µ–Ω(–∞).",
                btn_confirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                reg_title: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞",
                reg_desc: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Email.",
                email_label: "Email",
                btn_next: "–î–∞–ª–µ–µ",
                form_title: "–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞",
                form_section_user: "üë§ –û –≤–∞—Å",
                label_age: "–í–æ–∑—Ä–∞—Å—Ç",
                label_gender: "–ü–æ–ª",
                opt_select: "–í—ã–±—Ä–∞—Ç—å...",
                opt_m: "–ú—É–∂—Å–∫–æ–π",
                opt_f: "–ñ–µ–Ω—Å–∫–∏–π",
                label_lang: "–†–æ–¥–Ω–æ–π —è–∑—ã–∫",
                opt_ru: "ru—Å—Å–∫–∏–π",
                opt_en: "English",
                opt_other: "–îru–≥–æ–π",
                label_edu: "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                opt_edu_school: "–°—Ä–µ–¥–Ω–µ–µ",
                opt_edu_student: "–°—Ç—É–¥–µ–Ω—Ç",
                opt_edu_higher: "–í—ã—Å—à–µ–µ",
                opt_edu_degree: "–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å",
                form_section_tech: "üëÅÔ∏è –ó—Ä–µ–Ω–∏–µ & –û–±–æru–¥–æ–≤–∞–Ω–∏–µ",
                label_vision: "–ó—Ä–µ–Ω–∏–µ",
                opt_vis_norm: "–ù–æ—Ä–º–∞",
                opt_vis_glass: "–û—á–∫–∏",
                opt_vis_lens: "–õ–∏–Ω–∑—ã",
                label_pathology: "–ü–∞—Ç–æ–ª–æ–≥–∏–∏",
                opt_path_none: "–ù–µ—Ç",
                opt_path_hemi: "–ì–µ–º–∏–∞–Ω–æ–ø—Å–∏—è",
                opt_path_scot: "–°–∫–æ—Ç–æ–º–∞",
                opt_path_color: "–î–∞–ª—å—Ç–æ–Ω–∏–∑–º",
                label_hand: "–í–µ–¥—É—â–∞—è ru–∫–∞",
                opt_hand_r: "–ü—Ä–∞–≤–∞—è",
                opt_hand_l: "–õ–µ–≤–∞—è",
                label_device: "Input Device",
                opt_dev_mouse: "–ú—ã—à—å",
                opt_dev_touch: "–¢–∞—á–ø–∞–¥",
                label_keyboard: "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞",
                opt_kb_int: "–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è",
                opt_kb_ext: "–í–Ω–µ—à–Ω—è—è",
                calib_title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã",
                calib_desc: "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –∑–∞—Ç–µ–º –Ω–∞—á–Ω—ë–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.",
                msg_press_btn: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏...",
                status_label: "–°—Ç–∞—Ç—É—Å:",
                points_label: "–ó–∞–ø–∏—Å–∞–Ω–æ —Ç–æ—á–µ–∫:",
                btn_camera: "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µru",
                final_title: "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
                final_desc: "–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ. –î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.",
                qc_passed: "‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã (QC Passed)",
                btn_download: "üì• –°–∫–∞—á–∞—Ç—å JSON",
                btn_restart: "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ",
                // pre-check
                label_light: "–û—Å–≤–µ—â–µ–Ω–∏–µ",
                label_face: "–õ–∏—Ü–æ",
                label_pose: "–ü–æ–∑–∞ –≥–æ–ª–æ–≤—ã",
                label_visibility: "–í–∏–¥–∏–º–æ—Å—Ç—å –ª–∏—Ü–∞",
                status_waiting: "–û–∂–∏–¥–∞–Ω–∏–µ...",
                guide_text: "–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ –ª–∏—Ü–æ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏",
                precheck_initial: "–ù–∞–∂–º–∏—Ç–µ \"–ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É\" —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µru",
                precheck_requesting: "‚è≥ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...",
                precheck_checking: "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è...",
                precheck_camera_error: "‚ùå –û—à–∏–±–∫–∞: ",
                precheck_all_good: "‚úÖ –°heck is passed! You can start calibration",
                btn_start_precheck: "üé• –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É",
                btn_start_calib: "‚úÖ –ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É",
                status_error: "‚ùå Error",
                // —Å—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (pre-check)
                status_too_dark: "–¢–µ–º–Ω–æ",
                status_too_bright: "–Ø—Ä–∫–æ",
                status_optimal: "–û—Ç–ª–∏—á–Ω–æ",
                status_normal: "–ù–æ—Ä–º–∞",
                status_not_found: "–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
                status_too_small: "–î–∞–ª–µ–∫–æ –æ—Ç –∫–∞–º–µ—Ä—ã",
                status_too_large: "–ë–ª–∏–∑–∫–æ –∫ –∫–∞–º–µ—Ä–µ",
                status_out_of_zone: "–í–Ω–µ –∑–æ–Ω—ã",
                status_tilted: "–ì–æ–ª–æ–≤–∞ –Ω–∞–∫–ª–æ–Ω–µ–Ω–∞",
                status_stable: "–°—Ç–∞–±–∏–ª—å–Ω–æ",
                status_unstable: "–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ",
                status_no_face: "–ù–µ—Ç –ª–∏—Ü–∞",
                status_all_good: "üéâ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞! –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É",
                status_needs_fix: "üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å",
                status_checking: "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è",
                status_partial_face: "–ß–∞—Å—Ç—å –ª–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞",
                status_off_center: "–ù–µ –ø–æ —Ü–µ–Ω—Çru",
                status_face_occluded: "–õ–∏—Ü–æ –∑–∞–∫—Ä—ã—Ç–æ",
                status_hair_occlusion: "–í–æ–ª–æ—Å—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç –ª–∏—Ü–æ",
                status_face_visible: "–õ–∏—Ü–æ –≤–∏–¥–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é",
                //–ø–æ–¥—Å–∫–∞–∑–∫–∏
                tip_light_dark: "–°–ª–∏—à–∫–æ–º —Ç–µ–º–Ω–æ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É –∏–ª–∏ –ø–æ–¥–æ–π—Ç–∏ –∫ –æ–∫–Ω—É",
                tip_light_bright: "–°–ª–∏—à–∫–æ–º —è—Ä–∫–æ, –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–µ—Ç –ø—Ä—è–º–æ –≤ –∫–∞–º–µru –∏–ª–∏ –æ—Ç–æ–π–¥–∏—Ç–µ –æ—Ç –æ–∫–Ω–∞",
                tip_face_not_found: "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞ru–∂–µ–Ω–æ, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–∞–¥—Ä–∞",
                tip_face_too_small: "–ü–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å –±–ª–∏–∂–µ –∫ –∫–∞–º–µ—Ä–µ, –ª–∏—Ü–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–Ω–æ",
                tip_face_too_large: "–í—ã —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ, –æ—Ç–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å –æ—Ç –∫–∞–º–µ—Ä—ã",
                tip_face_out_of_zone: "–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ –ª–∏—Ü–æ –ø–æ —Ü–µ–Ω—Çru –∫–∞–¥—Ä–∞",
                tip_face_tilted: "–î–µ—Ä–∂–∏—Ç–µ –≥–æ–ª–æ–≤—É –ø—Ä—è–º–æ, –Ω–µ –Ω–∞–∫–ª–æ–Ω—è–π—Ç–µ –µ—ë",
                tip_pose_no_face: "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞ru–∂–µ–Ω–æ, —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ—Å—å –ø–æ —Ü–µ–Ω—Çru –∫–∞–¥—Ä–∞",
                tip_pose_unstable: "–ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ –∫–∞–º–µru –∏ –Ω–µ –¥–≤–∏–≥–∞—Ç—å—Å—è",
                tip_pose_partial_face: "–ß–∞—Å—Ç—å –ª–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞. –†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ—Å—å —Ç–∞–∫, —á—Ç–æ–±—ã –≤—Å—ë –ª–∏—Ü–æ –±—ã–ª–æ –≤ –∫–∞–¥—Ä–µ",
                tip_pose_eyes_off_center: "–ì–ª–∞–∑–∞ –Ω–µ –ø–æ —Ü–µ–Ω—Çru —ç–∫—Ä–∞–Ω–∞. –°–º–µ—Å—Ç–∏—Ç–µ—Å—å —Ç–∞–∫, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ –∫–∞–º–µru",
                tip_pose_move_right: "–°–º–µ—Å—Ç–∏—Ç–µ—Å—å –Ω–µ–º–Ω–æ–≥–æ –≤–ø—Ä–∞–≤–æ",
                tip_pose_move_left: "–°–º–µ—Å—Ç–∏—Ç–µ—Å—å –Ω–µ–º–Ω–æ–≥–æ –≤–ª–µ–≤–æ", 
                tip_pose_move_up: "–ü–æ–¥–Ω–∏–º–∏—Ç–µ –∫–∞–º–µru –∏–ª–∏ –æ–ø—É—Å—Ç–∏—Ç–µ—Å—å –Ω–∏–∂–µ",
                tip_pose_move_down: "–û–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µru –∏–ª–∏ –ø–æ–¥–Ω–∏–º–∏—Ç–µ—Å—å –≤—ã—à–µ",
                tip_pose_turn_down: "–ù–∞–∫–ª–æ–Ω–∏—Ç–µ –≥–æ–ª–æ–≤—É –Ω–µ–º–Ω–æ–≥–æ –≤–Ω–∏–∑",
                tip_pose_turn_up: "–ù–∞–∫–ª–æ–Ω–∏—Ç–µ –≥–æ–ª–æ–≤—É –Ω–µ–º–Ω–æ–≥–æ –≤–≤–µ—Ä—Ö",
                tip_pose_tilt_right: "–ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –≥–æ–ª–æ–≤—É –≤–ª–µ–≤–æ",
                tip_pose_tilt_left: "–ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –≥–æ–ª–æ–≤—É –≤–ø—Ä–∞–≤–æ",
                tip_pose_straighten: "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ –≥–æ–ª–æ–≤—É, –Ω–µ –Ω–∞–∫–ª–æ–Ω—è–π—Ç–µ –µ—ë –≤–±–æ–∫",
                tip_eyes_closed: "–û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –∫–∞–º–µru",
                tip_face_occluded: "–£–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã, –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ –ª–∏—Ü–æ (ru–∫–∏, –≤–æ–ª–æ—Å—ã)",
                tip_hand_on_face: "–£–±–µ—Ä–∏—Ç–µ —Ä—É–∫—É –æ—Ç –ª–∏—Ü–∞",
                tip_hair_covers_face: "–£–±–µ—Ä–∏—Ç–µ –≤–æ–ª–æ—Å—ã —Å –ª–∏—Ü–∞, —á—Ç–æ–±—ã —â—ë–∫–∏ –∏ –ª–æ–± –±—ã–ª–∏ –≤–∏–¥–Ω—ã",
                tip_left_side_occluded: "–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ª–∏—Ü–∞ –∑–∞–∫—Ä—ã—Ç–∞ ‚Äî –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –≥–æ–ª–æ–≤—É –∏–ª–∏ —É–±–µ—Ä–∏—Ç–µ –ø–æ–º–µ—Ö—É",
                tip_right_side_occluded: "–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ª–∏—Ü–∞ –∑–∞–∫—Ä—ã—Ç–∞ ‚Äî –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –≥–æ–ª–æ–≤—É –∏–ª–∏ —É–±–µ—Ä–∏—Ç–µ –ø–æ–º–µ—Ö—É",
                tip_left_hand_on_face: "–£–±–µ—Ä–∏—Ç–µ –ª–µ–≤—É—é —Ä—É–∫—É –æ—Ç –ª–∏—Ü–∞",
                tip_right_hand_on_face: "–£–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤—É—é —Ä—É–∫—É –æ—Ç –ª–∏—Ü–∞",
                tip_forehead_covered: "–õ–æ–± –∑–∞–∫—Ä—ã—Ç ‚Äî —É–±–µ—Ä–∏—Ç–µ —Ä—É–∫—É –∏–ª–∏ –≤–æ–ª–æ—Å—ã —Å–æ –ª–±–∞",
                tip_chin_covered: "–ü–æ–¥–±–æ—Ä–æ–¥–æ–∫ –∑–∞–∫—Ä—ã—Ç ‚Äî —É–±–µ—Ä–∏—Ç–µ —Ä—É–∫—É –æ—Ç –ø–æ–¥–±–æ—Ä–æ–¥–∫–∞",
                tip_eyes_area_covered: "–û–±–ª–∞—Å—Ç—å –≥–ª–∞–∑ –∑–∞–∫—Ä—ã—Ç–∞ ‚Äî —É–±–µ—Ä–∏—Ç–µ –ø–æ–º–µ—Ö—É",
                tip_nose_covered: "–ù–æ—Å –∑–∞–∫—Ä—ã—Ç ‚Äî —É–±–µ—Ä–∏—Ç–µ —Ä—É–∫—É –æ—Ç –Ω–æ—Å–∞",
                tip_mouth_covered: "–†–æ—Ç –∑–∞–∫—Ä—ã—Ç ‚Äî —É–±–µ—Ä–∏—Ç–µ —Ä—É–∫—É –æ—Ç —Ä—Ç–∞",
                // Dynamic JS strings
                id_participant: "–í–∞—à ID —É—á–∞—Å—Ç–Ω–∏–∫–∞:",
                id_not_generated: "ID –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω",
                msg_init: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏... –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.",
                msg_face_ok: "–õ–∏—Ü–æ –Ω–∞–π–¥–µ–Ω–æ (OK)",
                msg_face_err: "–õ–∏—Ü–æ –ù–ï –Ω–∞–π–¥–µ–Ω–æ (–ü–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å)",
                msg_wait_stable: "–ñ–¥–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ª–∏—Ü–∞...",
                msg_face_locked: "–õ–∏—Ü–æ –∑–∞—Ö–≤–∞—á–µ–Ω–æ! –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫...",
                msg_no_face: "–ù–µ –≤–∏–∂—É –ª–∏—Ü–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.",
                // –¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è
                test_tracking_title: "–¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è",
                test_follow_shape: "–°–ª–µ–¥–∏—Ç–µ –≥–ª–∞–∑–∞–º–∏ –∑–∞ —Ñ–∏–≥—É—Ä–æ–π",
                test_progress: "–ü—Ä–æ–≥—Ä–µ—Å—Å:",
                test_complete: "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!"
            },
            en: {
                welcome_title: "Welcome",
                welcome_subtitle: "Attention and Emotion Assessment Platform",
                warning_title: "‚ö†Ô∏è Important:",
                warning_1: "You will need a webcam",
                warning_2: "Gaze data is processed on your device",
                warning_3: "We do not save video of your face",
                btn_start: "Start Research",
                consent_header: "Informed Consent",
                consent_1_title: "1. Research Goal",
                consent_1_text: "We are conducting scientific research on cognitive reactions. Your participation helps us understand perception.",
                consent_2_title: "2. Privacy",
                consent_2_text: "We collect anonymized data. Video stream is processed locally.",
                consent_link: "Full Consent Text",
                consent_checkbox: "I have read, I am 18+, and I agree.",
                btn_confirm: "Confirm and Continue",
                reg_title: "Participant Registration",
                reg_desc: "Please provide your Email.",
                email_label: "Email",
                btn_next: "Next",
                form_title: "Participant Survey",
                form_section_user: "üë§ About You",
                label_age: "Age",
                label_gender: "Gender",
                opt_select: "Select...",
                opt_m: "Male",
                opt_f: "Female",
                label_lang: "Native Language",
                opt_ru: "Russian",
                opt_en: "English",
                opt_other: "Other",
                label_edu: "Education",
                opt_edu_school: "Secondary",
                opt_edu_student: "Student",
                opt_edu_higher: "Higher",
                opt_edu_degree: "PhD / Degree",
                form_section_tech: "üëÅÔ∏è Vision & Hardware",
                label_vision: "Vision",
                opt_vis_norm: "Normal",
                opt_vis_glass: "Glasses",
                opt_vis_lens: "Contact Lenses",
                label_pathology: "Pathologies",
                opt_path_none: "None",
                opt_path_hemi: "Hemianopsia",
                opt_path_scot: "Scotoma",
                opt_path_color: "Color Blindness",
                label_hand: "Dominant Hand",
                opt_hand_r: "Right",
                opt_hand_l: "Left",
                label_device: "Input Device",
                opt_dev_mouse: "Mouse",
                opt_dev_touch: "Touchpad",
                label_keyboard: "Keyboard",
                opt_kb_int: "Internal",
                opt_kb_ext: "External",
                calib_title: "Camera Setup",
                calib_desc: "First we'll check conditions for participation, then start calibration.",
                msg_press_btn: "Preparing calibration...",
                status_label: "Status:",
                points_label: "Points recorded:",
                btn_camera: "Enable Camera",
                final_title: "Session Completed!",
                final_desc: "Thank you for participating. Data generated.",
                qc_passed: "‚úÖ Data Valid (QC Passed)",
                btn_download: "üì• Download JSON",
                btn_restart: "Start Over",
                // pre-check
                label_light: "Lighting",
                label_face: "Face",
                label_pose: "Head Pose",
                label_visibility: "Face Visibility",
                status_waiting: "Waiting...",
                guide_text: "Position your face inside the frame",
                precheck_initial: "Click \"Start Check\" to enable camera",
                precheck_requesting: "‚è≥ Requesting camera access...",
                precheck_checking: "‚è≥ Checking conditions...",
                precheck_camera_error: "‚ùå Error: ",
                precheck_all_good: "‚úÖ –°heck is passed! You can start calibration",
                btn_start_precheck: "üé• Start Check",
                btn_start_calib: "‚úÖ Start Calibration",
                status_error: "‚ùå Error",
                // —Å—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (pre-check)
                status_too_dark: "Too Dark",
                status_too_bright: "Too Bright",
                status_optimal: "Optimal",
                status_normal: "Normal",
                status_not_found: "Not Found",
                status_too_small: "Far from the camera",
                status_too_large: "Close to the camera",
                status_out_of_zone: "Out of frame",
                status_tilted: "Head tilted",
                status_stable: "Stable",
                status_unstable: "Unstable",
                status_no_face: "No Face",
                status_all_good: "üéâ All good! You can start calibration",
                status_off_center: "Off center",
                status_face_occluded: "Face Occluded",
                status_hair_occlusion: "Hair Covers Face",
                status_face_visible: "Face Fully Visible",
                //–ø–æ–¥—Å–∫–∞–∑–∫–∏
                tip_light_dark: "Too dark, turn on a lamp or move closer to a window",
                tip_light_bright: "Too bright, don't point light directly at the camera or move away from the window",
                tip_face_not_found: "Face not detected, make sure you're in the center of the frame",
                tip_face_too_small: "Move closer to the camera, your face must be fully visible",
                tip_face_too_large: "You're too close, move away from the camera",
                tip_face_out_of_zone: "Position your face in the center of the frame",
                tip_face_tilted: "Keep your head straight, don't tilt it",
                tip_pose_no_face: "Face not detected, position yourself in the center of the frame",
                tip_pose_unstable: "Try to look straight at the camera and don't move",
                tip_pose_partial_face: "Part of your face is not visible. Position yourself so your entire face is in frame",
                tip_pose_eyes_off_center: "Eyes are not centered on screen. Move so you're looking straight at the camera",
                tip_pose_move_right: "Move slightly to the right",
                tip_pose_move_left: "Move slightly to the left",
                tip_pose_move_up: "Raise the camera or lower yourself",
                tip_pose_move_down: "Lower the camera or raise yourself",
                tip_pose_turn_down: "Turn your head slightly to the top",
                tip_pose_turn_up: "Turn your head slightly to the bottom",
                tip_pose_tilt_right: "Move your head to the left",
                tip_pose_tilt_left: "Move your head to the right",
                tip_pose_straighten: "Straighten your head, don't tilt it sideways",
                tip_eyes_closed: "Open your eyes and look at the camera",
                tip_face_occluded: "Remove objects covering your face (hands, hair)",
                tip_hand_on_face: "Remove your hand from your face",
                tip_hair_covers_face: "Move hair away from your face so cheeks and forehead are visible",
                tip_left_side_occluded: "Left side of the face is covered ‚Äî turn your head or remove the obstruction",
                tip_right_side_occluded: "Right side of the face is covered ‚Äî turn your head or remove the obstruction",
                tip_left_hand_on_face: "Remove your left hand from your face",
                tip_right_hand_on_face: "Remove your right hand from your face",
                tip_forehead_covered: "Forehead is covered ‚Äî remove your hand or hair from forehead",
                tip_chin_covered: "Chin is covered ‚Äî remove your hand from chin",
                tip_eyes_area_covered: "Eyes area is covered ‚Äî remove the obstruction",
                tip_nose_covered: "Nose is covered ‚Äî remove your hand from nose",
                tip_mouth_covered: "Mouth is covered ‚Äî remove your hand from mouth",
                // Dynamic JS strings
                id_participant: "Your Participant ID:",
                id_not_generated: "ID not generated",
                msg_init: "Initializing AI... Allow camera access.",
                msg_face_ok: "Face Found (OK)",
                msg_face_err: "Face NOT Found (Move closer)",
                msg_wait_stable: "Waiting for face stabilization...",
                msg_face_locked: "Face locked! Calibration in 2s...",
                msg_no_face: "Cannot see face. Check lighting.",
               // –¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è
                test_tracking_title: "Tracking Test",
                test_follow_shape: "Follow the shape with your eyes",
                test_progress: "Progress:",
                test_complete: "Test complete!"
            }
        };

        let currentLang = 'ru';

        function setLanguage(lang) {
            currentLang = lang;
            
            // Update UI buttons
            document.getElementById('langRu').classList.toggle('active', lang === 'ru');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');

            // Update all text elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // Update ID text if generated
            if (sessionData.ids.participant) {
                document.getElementById('generatedIdPreview').innerText = `${translations[lang].id_participant} ${sessionData.ids.participant}`;
            } else {
                document.getElementById('idDisplay').innerText = translations[lang].id_not_generated;
            }

            if (isPrecheckRunning && precheckData) {
                checkAllIndicators(); 
            }
        }

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let sessionData = {
            ids: { session: null, participant: null },
            user: { interfaceLanguage: 'ru' },
            tech: {}, 
            precheck: {},
            eyeTracking: [],
            trackingTest: [], // –î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ —Å–ª–µ–∂–µ–Ω–∏—è
            gazeValidation: null, // –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ gaze
            events: [],
            qcSummary: null, // QC –æ—Ç—á—ë—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ —Å–µ—Å—Å–∏–∏
            startTime: Date.now()
        };

        window.lastFaceLandmarks = null;

        // === –ú–û–î–£–õ–ò –≠–ú–û–¶–ò–ô –ò –ú–ê–°–û–ö ===
        let emotionAnalyzer = null;      // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç–º–æ—Ü–∏–π
        let faceMaskCollector = null;    // –°–±–æ—Ä—â–∏–∫ –º–∞—Å–æ–∫ –ª–∏—Ü–∞
        let emotionMaskInitialized = false; // –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

        let isRecording = false;
        let faceDetected = false;
        let currentGaze = { x: null, y: null }; // –¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
        
        // === QC METRICS (real-time tracking) ===
        let qcMetrics = null; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏ru–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        let sessionStartTime = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏ –¥–ª—è QC
        
        // === GAZE VALIDATION ===
        let validationPoints = []; // –°–æ–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        let isValidating = false; // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (pre-check) ---
        let cameraStream = null;
        let isPrecheckRunning = false;
        let analysisFrameId = null;
        let successFrames = 0;
        const requiredSuccessFrames = 15;
        
        // –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä (–≤–º–µ—Å—Ç–æ –±—ç–∫–µ–Ω–¥–∞)
        let localAnalyzer = null;
        let faceSegmenter = null; // FaceSegmenter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –æ–±–ª–∞—Å—Ç–µ–π –ª–∏—Ü–∞
        let precheckFramesHistory = []; // –ò—Å—Ç–æ—Ä–∏—è –∫–∞–¥—Ä–æ–≤ –¥–ª—è QC
        
        // === CAMERA FPS MONITOR ===
        // –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ FPS –∫–∞–º–µ—Ä—ã
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestVideoFrameCallback –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è
        
        let cameraFpsState = {
            isRunning: false,
            frameCount: 0,
            lastTime: 0,
            currentFps: 0,
            fpsHistory: [],
            videoFrameCallbackId: null,
            video: null
        };
        
        /**
         * –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ FPS –∫–∞–º–µ—Ä—ã
         * @param {HTMLVideoElement} videoElement - —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–æ
         */
        function startCameraFpsMonitor(videoElement) {
            if (cameraFpsState.isRunning) return;
            
            cameraFpsState.video = videoElement;
            cameraFpsState.isRunning = true;
            cameraFpsState.frameCount = 0;
            cameraFpsState.lastTime = performance.now();
            cameraFpsState.fpsHistory = [];
            
            if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
                console.log('[CameraFPS] –ò—Å–ø–æ–ª—å–∑—É–µ–º requestVideoFrameCallback');
                startVideoFrameCallback();
            } else {
                console.log('[CameraFPS] requestVideoFrameCallback –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                startFallbackFpsMonitor();
            }
        }
        
        /**
         * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ FPS –∫–∞–º–µ—Ä—ã
         */
        function stopCameraFpsMonitor() {
            cameraFpsState.isRunning = false;
            
            if (cameraFpsState.videoFrameCallbackId && cameraFpsState.video) {
                if (cameraFpsState.video.cancelVideoFrameCallback) {
                    cameraFpsState.video.cancelVideoFrameCallback(cameraFpsState.videoFrameCallbackId);
                }
                cameraFpsState.videoFrameCallbackId = null;
            }
        }
        
        /**
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–π FPS –∑–∞ –≤—Ä–µ–º—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
         */
        function getAverageCameraFps() {
            if (cameraFpsState.fpsHistory.length === 0) return 0;
            return Math.round(cameraFpsState.fpsHistory.reduce((a, b) => a + b, 0) / cameraFpsState.fpsHistory.length);
        }
        
        /**
         * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ requestVideoFrameCallback
         */
        function startVideoFrameCallback() {
            const onFrame = (now, metadata) => {
                if (!cameraFpsState.isRunning) return;
                
                cameraFpsState.frameCount++;
                
                // –í—ã—á–∏—Å–ª—è–µ–º FPS –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                const elapsed = now - cameraFpsState.lastTime;
                if (elapsed >= 1000) {
                    cameraFpsState.currentFps = Math.round((cameraFpsState.frameCount * 1000) / elapsed);
                    cameraFpsState.fpsHistory.push(cameraFpsState.currentFps);
                    if (cameraFpsState.fpsHistory.length > 30) cameraFpsState.fpsHistory.shift();
                    
                    // –ü–µ—Ä–µ–¥–∞—ë–º FPS –≤ QCMetrics
                    if (qcMetrics && qcMetrics.isRunning()) {
                        qcMetrics.setCameraFps(cameraFpsState.currentFps);
                    }
                    
                    cameraFpsState.frameCount = 0;
                    cameraFpsState.lastTime = now;
                }
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
                cameraFpsState.videoFrameCallbackId = cameraFpsState.video.requestVideoFrameCallback(onFrame);
            };
            
            cameraFpsState.videoFrameCallbackId = cameraFpsState.video.requestVideoFrameCallback(onFrame);
        }
        
        /**
         * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è: fallback –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ currentTime
         */
        function startFallbackFpsMonitor() {
            let lastVideoTime = cameraFpsState.video.currentTime;
            let rafId = null;
            
            const checkFrame = () => {
                if (!cameraFpsState.isRunning) return;
                
                const now = performance.now();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ –∫–∞–¥—Ä –≤–∏–¥–µ–æ
                if (cameraFpsState.video.currentTime !== lastVideoTime) {
                    cameraFpsState.frameCount++;
                    lastVideoTime = cameraFpsState.video.currentTime;
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º FPS –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                const elapsed = now - cameraFpsState.lastTime;
                if (elapsed >= 1000) {
                    cameraFpsState.currentFps = Math.round((cameraFpsState.frameCount * 1000) / elapsed);
                    cameraFpsState.fpsHistory.push(cameraFpsState.currentFps);
                    if (cameraFpsState.fpsHistory.length > 30) cameraFpsState.fpsHistory.shift();
                    
                    // –ü–µ—Ä–µ–¥–∞—ë–º FPS –≤ QCMetrics
                    if (qcMetrics && qcMetrics.isRunning()) {
                        qcMetrics.setCameraFps(cameraFpsState.currentFps);
                    }
                    
                    cameraFpsState.frameCount = 0;
                    cameraFpsState.lastTime = now;
                }
                
                rafId = requestAnimationFrame(checkFrame);
            };
            
            rafId = requestAnimationFrame(checkFrame);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º rafId –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—á–µ—Ä–µ–∑ videoFrameCallbackId –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏)
            cameraFpsState.videoFrameCallbackId = rafId;
        }
        
        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π API)
        let cameraFpsMonitor = null;

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑
        async function sendFrameToBackend(videoElement) {
            /*
            {
                "frame": "..image/jpeg..", //string
                "timestamp": Date.now(), //number
                "resolution": {
                    "width": canvas.width, //number
                    "height": canvas.height //number
                },
                "sessionId": "..", //string
                "participantId": ".." //string
                }
            */
            try {
                // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = videoElement.videoWidth || 640;
                canvas.height = videoElement.videoHeight || 480;
                
                // –ó–µ—Ä–∫–∞–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º (–∫–∞–∫ –≤ –≤–∏–¥–µ–æ)
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvas.toDataURL('image/jpeg', BACKEND_CONFIG.COMPRESSION_QUALITY);
                
                // –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const payload = {
                    frame: imageData,
                    timestamp: Date.now(),
                    resolution: {
                        width: canvas.width,
                        height: canvas.height
                    },
                    sessionId: sessionData.ids.session,
                    participantId: sessionData.ids.participant
                };
                
                const response = await fetch(`${BACKEND_CONFIG.BASE_URL}${BACKEND_CONFIG.ENDPOINTS.ANALYZE_FRAME}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
        
                return await response.json();
        
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–¥—Ä–∞:', error);
                throw error;
            }
        }

        async function analyzeVideoFrame(videoElement) {
            /*
            {
                "illumination": {
                    "value": 75,  //"optimal": 30 ‚â§ value ‚â§ 80
                                 // "too_dark": value < 30
                                 // "too_bright": value > 80
                    "status": "optimal"  //"optimal" | "too_dark" | "too_bright"
                },
                "face": {
                    "detected": true, // boolean
                    "size": 35, // % –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞
                    "status": "optimal", // "optimal" (20-60) | "too_small" | "too_large"
                    "bbox": {
                    "x": 0.3, // –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ (0-1)
                    "y": 0.3, // –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É (0-1)
                    "width": 0.4, // –®–∏—Ä–∏–Ω–∞ (0-1)
                    "height": 0.4 // –í—ã—Å–æ—Ç–∞ (0-1)
                    }
                },
                "pose": {
                    "status": "stable", // "stable" | "unstable" | "no_face"
                    "isStable": true // boolean
                }
            */
            try {
                const results = await sendFrameToBackend(videoElement);
                
                return {
                    illumination: results.illumination,
                    face: results.face,
                    pose: results.pose,
                    timestamp: Date.now(),
                    frameSize: results.frameSize || {
                        width: videoElement.videoWidth || 640,
                        height: videoElement.videoHeight || 480
                    }
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ:', error);
                
                return {
                    error: true,
                    errorMessage: error.message || '–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                    illumination: { value: 0, status: "error" },
                    face: { detected: false, size: 0, status: "error" },
                    pose: { status: "error", isStable: false },
                    timestamp: Date.now(),
                    frameSize: { width: 640, height: 480 }
                };
            }
        }

        function nextStep(stepNumber) {
            // –ï—Å–ª–∏ —É—Ö–æ–¥–∏–º —Å–æ step5, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ—á–µ–∫
            if (document.getElementById('step5').classList.contains('active')) {
                stopPreCheckOnLeave();
            }

            if (stepNumber === 5) {
                resetIndicatorsToWaiting();
            }
            
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            const nextEl = document.getElementById('step' + stepNumber);
            if (nextEl) nextEl.classList.add('active');
        }

        function toggleConsent() {
            const chk = document.getElementById('consentCheck');
            document.getElementById('consentBtn').disabled = !chk.checked;
        }

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø ID ---
        function generateIdsAndProceed() {
            const sessionId = 'S-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const participantId = 'P-' + Math.random().toString(36).substr(2, 5).toUpperCase();
            
            sessionData.ids.session = sessionId;
            sessionData.ids.participant = participantId;
            sessionData.user.interfaceLanguage = currentLang; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫

            const idBadge = document.getElementById('idDisplay');
            idBadge.style.display = 'block';
            idBadge.innerText = `ID: ${participantId}`;
            
            document.getElementById('generatedIdPreview').innerText = `${translations[currentLang].id_participant} ${participantId}`;

            nextStep(3);
        }

        function copyIds() {
            const text = `Session: ${sessionData.ids.session}, Participant: ${sessionData.ids.participant}`;
            navigator.clipboard.writeText(text).then(() => alert('ID copied!'));
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø EMAIL (–ø—Ä–∏ blur) ---
        function validateEmailField() {
            const emailInput = document.getElementById('userEmail');
            const email = emailInput.value.trim();
            const validation = validateEmail(email);
            
            if (!validation.valid) {
                emailInput.setAttribute('aria-invalid', 'true');
                emailInput.classList.add('error');
                showFieldError(emailInput, validation.error);
            } else {
                emailInput.removeAttribute('aria-invalid');
                emailInput.classList.remove('error');
                hideFieldError(emailInput);
            }
        }
        
        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø EMAIL ---
        function validateEmail(email) {
            if (!email || email.trim() === '') {
                return { valid: false, error: 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è' };
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ emoji –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–¥–æ –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
            const emojiRegex = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u;
            if (emojiRegex.test(email)) {
                return { valid: false, error: 'Email –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å emoji' };
            }
            
            // –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email' };
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (email.includes('..')) {
                return { valid: false, error: 'Email –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–≤–æ–π–Ω—ã–µ —Ç–æ—á–∫–∏' };
            }
            
            if (email.includes(' ')) {
                return { valid: false, error: 'Email –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã' };
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if (/[–∞-—è—ë]/i.test(email)) {
                return { valid: false, error: 'Email –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü—É' };
            }
            
            return { valid: true };
        }

        // --- –°–ë–û–† –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –î–ê–ù–ù–´–• ---
        function collectTechDataAndProceed() {
            const emailInput = document.getElementById('userEmail');
            const email = emailInput.value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è email
            const emailValidation = validateEmail(email);
            if (!emailValidation.valid) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                emailInput.setAttribute('aria-invalid', 'true');
                emailInput.classList.add('error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                let errorMsg = document.getElementById('emailError');
                if (!errorMsg) {
                    errorMsg = document.createElement('div');
                    errorMsg.id = 'emailError';
                    errorMsg.className = 'error-message';
                    errorMsg.style.cssText = 'color: var(--error); font-size: 12px; margin-top: 5px;';
                    emailInput.parentElement.appendChild(errorMsg);
                }
                errorMsg.textContent = emailValidation.error;
                
                // –ë–ª–æ–∫–∏ru–µ–º –ø–µ—Ä–µ—Ö–æ–¥
                return;
            }
            
            // –£–±–∏—Ä–∞–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–æ
            emailInput.removeAttribute('aria-invalid');
            emailInput.classList.remove('error');
            const errorMsg = document.getElementById('emailError');
            if (errorMsg) errorMsg.remove();
            
            if (email) sessionData.user.email = email; 

            sessionData.tech.screen = {
                width: window.screen.width,
                height: window.screen.height,
                availWidth: window.screen.availWidth,
                availHeight: window.screen.availHeight,
                pixelRatio: window.devicePixelRatio || 1
            };

            sessionData.tech.browser = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cores: navigator.hardwareConcurrency || 'unknown',
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };

            // –ò–∑–º–µ—Ä—è–µ–º FPS —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
            measureRenderFPS().then(renderFps => {
                sessionData.tech.measuredFPS = renderFps;
                sessionData.tech.renderFPS = renderFps;
                nextStep(4);
            });
        }

        /**
         * –ò–∑–º–µ—Ä—è–µ—Ç FPS —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (requestAnimationFrame)
         * –≠—Ç–æ –ù–ï FPS –∫–∞–º–µ—Ä—ã, –∞ —á–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞/–±—Ä–∞—É–∑–µ—Ä–∞
         */
        function measureRenderFPS() {
            return new Promise(resolve => {
                let frames = 0;
                let startTime = performance.now();
                function loop() {
                    frames++;
                    const now = performance.now();
                    if (now - startTime >= 500) { 
                        const fps = Math.round(frames * 2); 
                        resolve(fps);
                    } else {
                        requestAnimationFrame(loop);
                    }
                }
                requestAnimationFrame(loop);
            });
        }

        /**
         * –ò–∑–º–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π FPS –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ –∫–∞–º–µ—Ä—ã
         * @param {HTMLVideoElement} videoElement - —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–æ
         * @param {number} durationMs - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤ –º—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2000)
         * @returns {Promise<{fps: number, frames: number}>}
         */
        function measureCameraFPS(videoElement, durationMs = 2000) {
            return new Promise(resolve => {
                let frameCount = 0;
                let lastTime = 0;
                const startTime = performance.now();
                
                function checkFrame(currentTime) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ –∫–∞–¥—Ä –≤–∏–¥–µ–æ
                    if (videoElement.currentTime !== lastTime) {
                        frameCount++;
                        lastTime = videoElement.currentTime;
                    }
                    
                    if (performance.now() - startTime < durationMs) {
                        requestAnimationFrame(checkFrame);
                    } else {
                        const elapsed = (performance.now() - startTime) / 1000;
                        const fps = Math.round(frameCount / elapsed);
                        resolve({ fps, frames: frameCount, duration: elapsed });
                    }
                }
                
                requestAnimationFrame(checkFrame);
            });
        }

        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function measureFPS() {
            return measureRenderFPS();
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ê–ù–ö–ï–¢–´ ---
        function checkForm() {
            const required = ['age', 'gender', 'inputDevice', 'keyboardType', 'vision'];
            let isValid = true;
            const errors = [];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            required.forEach(id => {
                const el = document.getElementById(id);
                if (!el || !el.value) {
                    isValid = false;
                    if (el) {
                        el.setAttribute('aria-invalid', 'true');
                        el.classList.add('error');
                    }
                } else {
                    if (el) {
                        el.removeAttribute('aria-invalid');
                        el.classList.remove('error');
                    }
                }
            });
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ (–¥–∏–∞–ø–∞–∑–æ–Ω 18-99)
            const ageInput = document.getElementById('age');
            if (ageInput && ageInput.value) {
                const age = parseInt(ageInput.value, 10);
                const ageValue = ageInput.value.trim();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∏—Å–ª–æ
                if (isNaN(age) || ageValue !== age.toString()) {
                    isValid = false;
                    ageInput.setAttribute('aria-invalid', 'true');
                    ageInput.classList.add('error');
                    showFieldError(ageInput, '–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º');
                }
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                else if (age < 18 || age > 99) {
                    isValid = false;
                    ageInput.setAttribute('aria-invalid', 'true');
                    ageInput.classList.add('error');
                    if (age < 18) {
                        showFieldError(ageInput, '–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 18 –ª–µ—Ç');
                    } else {
                        showFieldError(ageInput, '–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 99 –ª–µ—Ç');
                    }
                }
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
                else if (age < 0) {
                    isValid = false;
                    ageInput.setAttribute('aria-invalid', 'true');
                    ageInput.classList.add('error');
                    showFieldError(ageInput, '–í–æ–∑—Ä–∞—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
                }
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–ª—å
                else if (age === 0) {
                    isValid = false;
                    ageInput.setAttribute('aria-invalid', 'true');
                    ageInput.classList.add('error');
                    showFieldError(ageInput, '–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 18 –ª–µ—Ç');
                }
                // –í–∞–ª–∏–¥–Ω–æ
                else {
                    ageInput.removeAttribute('aria-invalid');
                    ageInput.classList.remove('error');
                    hideFieldError(ageInput);
                }
            }
            
            // –ë–ª–æ–∫–∏ru–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
            const formBtn = document.getElementById('formBtn');
            if (formBtn) {
                formBtn.disabled = !isValid;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –≤–∞–ª–∏–¥–Ω–∞
            if (isValid) {
                sessionData.user = {
                    ...sessionData.user,
                    age: document.getElementById('age').value,
                    gender: document.getElementById('gender').value,
                    education: document.getElementById('education').value,
                    language: document.getElementById('language').value,
                    vision: document.getElementById('vision').value,
                    visionIssues: document.getElementById('visionIssues').value,
                    hand: document.getElementById('hand').value,
                    inputDevice: document.getElementById('inputDevice').value,
                    keyboardType: document.getElementById('keyboardType').value
                };
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—è
        function showFieldError(field, message) {
            let errorMsg = field.parentElement.querySelector('.field-error');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.className = 'field-error';
                errorMsg.style.cssText = 'color: var(--error); font-size: 12px; margin-top: 5px;';
                field.parentElement.appendChild(errorMsg);
            }
            errorMsg.textContent = message;
        }
        
        // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—è
        function hideFieldError(field) {
            const errorMsg = field.parentElement.querySelector('.field-error');
            if (errorMsg) {
                errorMsg.remove();
            }
        }

        // –°–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–û–∂–∏–¥–∞–Ω–∏–µ"
        function resetIndicatorsToWaiting() {
            const indicators = document.querySelectorAll('.indicator');
            indicators.forEach(ind => {
                ind.classList.remove('passed', 'failed');
            });
            
            document.getElementById('LightProgress').style.width = '0%';
            document.getElementById('FaceProgress').style.width = '0%';
            document.getElementById('PoseProgress').style.width = '0%';
            
            document.getElementById('LightStatus').textContent = translations[currentLang].status_waiting;
            document.getElementById('FaceStatus').textContent = translations[currentLang].status_waiting;
            document.getElementById('PoseStatus').textContent = translations[currentLang].status_waiting;
            
            const cameraPreview = document.getElementById('cameraPreview');
            cameraPreview.className = 'camera-preview';
            
            const canvas = document.getElementById('overlayCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            indicatorsStatus = {
                illumination: null,
                face: null,
                pose: null
            };
            
            successFrames = 0;
            
            const guideText = document.querySelector('.guide-text');
            if (guideText) {
                guideText.textContent = translations[currentLang].guide_text;
            }
            
            const statusMessage = document.getElementById('statusMessage');
            const precheckStatus = document.querySelector('.precheck-status');
            if (statusMessage) {
                statusMessage.textContent = translations[currentLang].precheck_initial;
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
            }
            
            // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
            const startPrecheckBtn = document.getElementById('startPrecheckBtn');
            const startCalibBtn = document.getElementById('startCalibBtn');
            
            if (startPrecheckBtn) {
                startPrecheckBtn.style.display = 'block';
                startPrecheckBtn.disabled = false;
            }
            
            if (startCalibBtn) {
                startCalibBtn.style.display = 'none';
                startCalibBtn.disabled = true;
            }
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ—á–µ–∫ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –®–ê–ì–ê 5
        function stopPreCheckOnLeave() {
            if (isPrecheckRunning) {
                stopPreCheck();
            }

            if (emotionAnalyzer && emotionAnalyzer.isRunning) {
                emotionAnalyzer.stop();
                console.log('[Modules] EmotionAnalyzer –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—É—Ö–æ–¥ —Å —à–∞–≥–∞ 5)');
            }
    
            if (faceMaskCollector && faceMaskCollector.isRunning) {
                faceMaskCollector.stop();
                console.log('[Modules] FaceMaskCollector –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—É—Ö–æ–¥ —Å —à–∞–≥–∞ 5)');
            }

            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            isPrecheckRunning = false;
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmotionAnalyzer –∏ FaceMaskCollector
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PrecheckAnalyzer
         */
        async function initializeEmotionAndMaskModules(videoElement) {
            try {
                console.log('[Modules] ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–û–î–£–õ–ï–ô =====');
        
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Face Landmarker –¥–æ—Å—Ç—É–ø–µ–Ω
                if (!localAnalyzer || !localAnalyzer.faceLandmarker) {
                    console.error('[Modules] ‚ùå Face Landmarker –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω!');
                    console.error('[Modules] localAnalyzer:', localAnalyzer);
                    return;
                }
        
                faceLandmarkerInstance = localAnalyzer.faceLandmarker;
                console.log('[Modules] ‚úÖ Face Landmarker –ø–æ–ª—É—á–µ–Ω –∏–∑ PrecheckAnalyzer');
        
                // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø EMOTION ANALYZER ===
                console.log('[Modules] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmotionAnalyzer...');
        
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞—Å—Å EmotionAnalyzer –∑–∞–≥—Ä—É–∂–µ–Ω
                if (typeof EmotionAnalyzer === 'undefined') {
                    console.error('[Modules] ‚ùå –ö–ª–∞—Å—Å EmotionAnalyzer –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ js/emotions.js');
                    return;
                }
        
                emotionAnalyzer = new EmotionAnalyzer();
                const emotionInitSuccess = await emotionAnalyzer.initialize(faceLandmarkerInstance);
        
                if (emotionInitSuccess) {
                    console.log('[Modules] ‚úÖ EmotionAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π
                    emotionAnalyzer.start(videoElement);
                    console.log('[Modules] ‚ñ∂Ô∏è EmotionAnalyzer –∑–∞–ø—É—â–µ–Ω');
            
                    // –ü–†–û–í–ï–†–ö–ê: –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        const eventCount = emotionAnalyzer.getEvents().length;
                        console.log(`[Modules] EmotionAnalyzer —Å–æ–±—Ä–∞–ª ${eventCount} —Å–æ–±—ã—Ç–∏–π`);
                        if (eventCount === 0) {
                            console.warn('[Modules] ‚ö†Ô∏è EmotionAnalyzer –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ!');
                        }
                    }, 2000);
                } else {
                    console.error('[Modules] ‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ EmotionAnalyzer');
                }
        
                // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FACE MASK COLLECTOR ===
                console.log('[Modules] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FaceMaskCollector...');
        
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞—Å—Å FaceMaskCollector –∑–∞–≥—Ä—É–∂–µ–Ω
                if (typeof FaceMaskCollector === 'undefined') {
                    console.error('[Modules] ‚ùå –ö–ª–∞—Å—Å FaceMaskCollector –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ js/face-mask-collector.js');
                    return;
                }
        
                faceMaskCollector = new FaceMaskCollector();
                const maskInitSuccess = faceMaskCollector.initialize(faceLandmarkerInstance);
        
                if (maskInitSuccess) {
                    console.log('[Modules] ‚úÖ FaceMaskCollector –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä –º–∞—Å–æ–∫ (—Ñ–∞–∑–∞: precheck)
                    faceMaskCollector.start(videoElement, 'precheck');
                    console.log('[Modules] ‚ñ∂Ô∏è FaceMaskCollector –∑–∞–ø—É—â–µ–Ω (—Ñ–∞–∑–∞: precheck)');
            
                    // –ü–†–û–í–ï–†–ö–ê: –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        const maskCount = faceMaskCollector.getMasks().length;
                        console.log(`[Modules] FaceMaskCollector —Å–æ–±—Ä–∞–ª ${maskCount} –º–∞—Å–æ–∫`);
                        if (maskCount === 0) {
                            console.warn('[Modules] ‚ö†Ô∏è FaceMaskCollector –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ!');
                        }
                    }, 2000);
                } else {
                    console.error('[Modules] ‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FaceMaskCollector');
                }
        
                console.log('[Modules] ===== –í–°–ï –ú–û–î–£–õ–ò –ó–ê–ü–£–©–ï–ù–´ =====');
        
            } catch (error) {
                console.error('[Modules] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π:', error);
                console.error('[Modules] Stack trace:', error.stack);
            }
        }


        // pre-check
        async function startPreCheck() {
            console.log('–ó–∞–ø—É—Å–∫ pre-check –∫–∞–º–µ—Ä—ã...');

            if (isPrecheckRunning) {
                stopPreCheck();
                return;
            }

            const startPrecheckBtn = document.getElementById('startPrecheckBtn');
            const startCalibBtn = document.getElementById('startCalibBtn');
            const statusMessage = document.getElementById('statusMessage');
            const precheckStatus = document.querySelector('.precheck-status');
    
            startPrecheckBtn.style.display = 'none';
            startCalibBtn.style.display = 'block';
            startCalibBtn.disabled = true;
    
            statusMessage.textContent = translations[currentLang].precheck_requesting;
            precheckStatus.className = 'precheck-status waiting-bg';

             try {
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30, min: 15 }
                    }
                });
        
                const video = document.getElementById('precheckVideo');
                video.srcObject = cameraStream;
        
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        console.log(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–µ–æ: ${video.videoWidth}x${video.videoHeight}`);
                
                        const videoTrack = cameraStream.getVideoTracks()[0];
                        if (videoTrack) {
                            const settings = videoTrack.getSettings();
                            console.log('[Camera] –†–µ–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', settings);
                            console.log(`[Camera] –†–µ–∞–ª—å–Ω—ã–π frameRate: ${settings.frameRate || 'unknown'}`);
                    
                            sessionData.tech.camera = {
                                width: settings.width,
                                height: settings.height,
                                frameRate: settings.frameRate,
                                deviceId: settings.deviceId,
                                facingMode: settings.facingMode
                            };
                        }
                
                        const canvas = document.getElementById('overlayCanvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                
                        resolve();
                    };
                });
        
                // –ò–∑–º–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π FPS –∫–∞–º–µ—Ä—ã
                console.log('[Camera] –ò–∑–º–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π FPS –∫–∞–º–µ—Ä—ã...');
                const cameraFpsResult = await measureCameraFPS(video, 2000);
                console.log(`[Camera] –ò–∑–º–µ—Ä–µ–Ω–Ω—ã–π FPS: ${cameraFpsResult.fps}`);
        
                sessionData.tech.cameraFPS = cameraFpsResult.fps;
                sessionData.tech.cameraFPSDetails = cameraFpsResult;
        
                if (cameraFpsResult.fps < 15) {
                    console.warn(`[Camera] ‚ö†Ô∏è FPS –∫–∞–º–µ—Ä—ã (${cameraFpsResult.fps}) —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π!`);
                }
        
                statusMessage.textContent = translations[currentLang].precheck_checking;
        
                // === –í–ê–ñ–ù–û: –°–ù–ê–ß–ê–õ–ê –ó–ê–ü–£–°–ö–ê–ï–ú –ê–ù–ê–õ–ò–ó (—á—Ç–æ–±—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å PrecheckAnalyzer) ===
                console.log('[PreCheck] –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PrecheckAnalyzer...');
                startContinuousAnalysis();
        
                // === –ñ–î–Å–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò PrecheckAnalyzer (–¥–æ 10 —Å–µ–∫—É–Ω–¥) ===
                console.log('[PreCheck] –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PrecheckAnalyzer...');
                let attempts = 0;
                const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ (100 * 100ms)
        
                while ((!localAnalyzer || !localAnalyzer.faceLandmarker) && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
            
                    // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                    if (attempts % 10 === 0) {
                        console.log(`[PreCheck] –û–∂–∏–¥–∞–Ω–∏–µ... (${attempts / 10}s)`);
                    }
                }
        
                if (!localAnalyzer || !localAnalyzer.faceLandmarker) {
                    console.error('[PreCheck] ‚ùå PrecheckAnalyzer –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è –∑–∞ 10 —Å–µ–∫—É–Ω–¥!');
                    console.error('[PreCheck] localAnalyzer:', localAnalyzer);
                } else {
                    console.log('[PreCheck] ‚úÖ PrecheckAnalyzer –≥–æ—Ç–æ–≤');
            
                    // === –¢–ï–ü–ï–†–¨ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú EMOTION ANALYZER & FACE MASK COLLECTOR ===
                    await initializeEmotionAndMaskModules(video);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                statusMessage.textContent = translations[currentLang].precheck_camera_error + error.message;
                precheckStatus.className = 'precheck-status error-bg';
        
                startPrecheckBtn.style.display = 'block';
                startCalibBtn.style.display = 'none';
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmotionAnalyzer –∏ FaceMaskCollector
         * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–µ—á–µ–∫–∞
         */
        async function initializeEmotionAndMaskModules(videoElement) {
            try {
                console.log('[Modules] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmotionAnalyzer –∏ FaceMaskCollector...');
        
                // –ü–æ–ª—É—á–∞–µ–º Face Landmarker –∏–∑ localAnalyzer (–æ–Ω —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ PrecheckAnalyzer)
                if (!localAnalyzer) {
                    console.warn('[Modules] localAnalyzer –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Å–æ–∑–¥–∞—ë–º...');
                    localAnalyzer = new PrecheckAnalyzer({
                        onInitialized: () => console.log('[PreCheck] –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'),
                        onError: (err) => console.error('[PreCheck] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞:', err)
                    });
                }
        
                // –ñ–¥—ë–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Face Landmarker
                await new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (localAnalyzer.faceLandmarker) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
            
                    // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, 5000);
                });
        
                faceLandmarkerInstance = localAnalyzer.faceLandmarker;
        
                if (!faceLandmarkerInstance) {
                    console.error('[Modules] Face Landmarker –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω!');
                    return;
                }
        
                // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø EMOTION ANALYZER ===
                emotionAnalyzer = new EmotionAnalyzer();
                const emotionInitSuccess = await emotionAnalyzer.initialize(faceLandmarkerInstance);
        
                if (emotionInitSuccess) {
                    console.log('[Modules] ‚úÖ EmotionAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π (–Ω–∞—á–∏–Ω–∞—è —Å –ø—Ä–µ—á–µ–∫–∞)
                    emotionAnalyzer.start(videoElement);
                    console.log('[Modules] ‚ñ∂Ô∏è EmotionAnalyzer –∑–∞–ø—É—â–µ–Ω');
                } else {
                    console.error('[Modules] ‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ EmotionAnalyzer');
                }
        
                // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FACE MASK COLLECTOR ===
                faceMaskCollector = new FaceMaskCollector();
                const maskInitSuccess = faceMaskCollector.initialize(faceLandmarkerInstance);
        
                if (maskInitSuccess) {
                    console.log('[Modules] ‚úÖ FaceMaskCollector –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä –º–∞—Å–æ–∫ (—Ñ–∞–∑–∞: precheck)
                    faceMaskCollector.start(videoElement, 'precheck');
                    console.log('[Modules] ‚ñ∂Ô∏è FaceMaskCollector –∑–∞–ø—É—â–µ–Ω (—Ñ–∞–∑–∞: precheck)');
                } else {
                    console.error('[Modules] ‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FaceMaskCollector');
                }
        
                console.log('[Modules] ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã');
        
            } catch (error) {
                console.error('[Modules] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π:', error);
            }
        }


        function stopPreCheck() {
            isPrecheckRunning = false;
            if (analysisFrameId) {
                clearTimeout(analysisFrameId);
                analysisFrameId = null;
            }
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
            if (localAnalyzer) {
                localAnalyzer.reset();
            }
        }

        /**
         * –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–¥—Ä–∞ (–±–µ–∑ –±—ç–∫–µ–Ω–¥–∞)
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç PrecheckAnalyzer –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Å–≤–µ—â–µ–Ω–∏—è, –ª–∏—Ü–∞, –ø–æ–∑—ã –∏ —à–µ–∏
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç FaceSegmenter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –æ–±–ª–∞—Å—Ç–µ–π –ª–∏—Ü–∞
         */
        async function runLocalPrecheckAnalysis(videoElement) {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏ru–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω
            if (!localAnalyzer) {
                localAnalyzer = new PrecheckAnalyzer({
                    onInitialized: () => console.log('[PreCheck] –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'),
                    onError: (err) => console.error('[PreCheck] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞:', err)
                });
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏ru–µ–º FaceSegmenter –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω
            if (!faceSegmenter) {
                faceSegmenter = new FaceSegmenter({
                    segmentationType: 'selfie_multiclass',
                    onInitialized: () => console.log('[PreCheck] FaceSegmenter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'),
                    onError: (err) => console.error('[PreCheck] –û—à–∏–±–∫–∞ FaceSegmenter:', err)
                });
            }
            
            try {
                // –ê–Ω–∞–ª–∏–∑–∏ru–µ–º –∫–∞–¥—Ä –ª–æ–∫–∞–ª—å–Ω–æ
                const results = await localAnalyzer.analyzeFrame(videoElement);

                if (results.landmarks) {
                    window.lastFaceLandmarks = {
                        faceLandmarks: [results.landmarks],
                        timestamp: Date.now()
                    };
                } else {
                    window.lastFaceLandmarks = null;
                }
                
                // –ê–Ω–∞–ª–∏–∑–∏ru–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –æ–±–ª–∞—Å—Ç–µ–π –ª–∏—Ü–∞ —á–µ—Ä–µ–∑ FaceSegmenter
                let visibilityResults = null;
                try {
                    // –ü–µ—Ä–µ–¥–∞—ë–º landmarks –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Face Landmarker –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                    const faceLandmarks = results.landmarks || null;
                    visibilityResults = await faceSegmenter.segmentFrame(videoElement, faceLandmarks);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤ –æ–±—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    results.visibility = {
                        isComplete: visibilityResults.isComplete,
                        score: visibilityResults.score,
                        issues: visibilityResults.issues || [],
                        regions: visibilityResults.faceVisibility?.regions || {},
                        timestamp: visibilityResults.timestamp
                    };
                } catch (segmentError) {
                    console.warn('[PreCheck] –û—à–∏–±–∫–∞ FaceSegmenter:', segmentError);
                    results.visibility = {
                        isComplete: false,
                        score: 0,
                        issues: visibilityResults.issues || ['segmenter_error'],
                        error: true
                    };
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è QC-–º–µ—Ç—Ä–∏–∫
                precheckFramesHistory.push(results);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∫–∞–¥—Ä–æ–≤)
                if (precheckFramesHistory.length > 100) {
                    precheckFramesHistory.shift();
                }
                
                return results;
                
            } catch (error) {
                console.error('[PreCheck] –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:', error);
                window.lastFaceLandmarks = null;
                return {
                    error: true,
                    errorMessage: error.message,
                    illumination: { value: 0, status: 'error' },
                    face: { detected: false, size: 0, status: 'error' },
                    pose: { status: 'error', isStable: false },
                    neck: { visible: false, status: 'error' },
                    visibility: { isComplete: false, score: 0, issues: ['analysis_error'], error: true },
                    timestamp: Date.now()
                };
            }
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å ready: boolean –∏ —Å–ø–∏—Å–∫–æ–º –ø—Ä–æ–±–ª–µ–º
         */
        function checkCalibrationReadiness() {
            if (!localAnalyzer || !precheckData) {
                return { ready: false, issues: ['analyzer_not_ready'] };
            }
            return localAnalyzer.checkCalibrationReadiness(precheckData);
        }

        function startContinuousAnalysis() {
            isPrecheckRunning = true;
            successFrames = 0;
            precheckFramesHistory = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            
            const video = document.getElementById('precheckVideo');

            if (!emotionMaskInitialized && localAnalyzer && localAnalyzer.faceLandmarker) {
                initializeEmotionAndMaskModules().then(success => {
                    if (success) {
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–¥—É–ª–∏ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                        if (emotionAnalyzer) {
                            emotionAnalyzer.start(video);
                            console.log('[PreCheck] EmotionAnalyzer –∑–∞–ø—É—â–µ–Ω');
                        }
                
                        if (faceMaskCollector) {
                            faceMaskCollector.start(video, 'precheck');
                            console.log('[PreCheck] FaceMaskCollector –∑–∞–ø—É—â–µ–Ω (—Ñ–∞–∑–∞: precheck)');
                        }
                    }
                });

            } else if (emotionMaskInitialized) {
                // –ú–æ–¥—É–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º
                if (emotionAnalyzer && !emotionAnalyzer.isRunning) {
                    emotionAnalyzer.start(video);
                    console.log('[PreCheck] EmotionAnalyzer –∑–∞–ø—É—â–µ–Ω');
                }
        
                if (faceMaskCollector && !faceMaskCollector.isRunning) {
                    faceMaskCollector.start(video, 'precheck');
                    console.log('[PreCheck] FaceMaskCollector –∑–∞–ø—É—â–µ–Ω (—Ñ–∞–∑–∞: precheck)');
                }
            }
    
            async function analyzeFrame() {
                if (!isPrecheckRunning) return;
                
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –õ–û–ö–ê–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–º–µ—Å—Ç–æ –±—ç–∫–µ–Ω–¥–∞
                    const results = await runLocalPrecheckAnalysis(video);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    updateIndicators(results);
                    
                    precheckData = results;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                    checkAllIndicators();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–¥—Ä–∞:', error);
                }
                
                // –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–Ω–∞–ª–∏–∑–∞ (300–º—Å = ~3.3 FPS)
                if (isPrecheckRunning) {
                    analysisFrameId = setTimeout(analyzeFrame, BACKEND_CONFIG.SEND_INTERVAL);
                }
            }
    
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –∞–Ω–∞–ª–∏–∑–∞
            analyzeFrame();
        }

        function updateIndicators(data) {
            updateIlluminationIndicator(data.illumination);
            updateFaceIndicator(data.face);
            updatePoseIndicator(data.pose);
            updateVisibilityIndicator(data.visibility);

            if (data.face && data.face.detected && data.face.bbox) {
                drawFaceOverlay(data.face);
            }
        }

        function updateIlluminationIndicator(data) {
            const indicator = document.getElementById('LightIndicator');
            const progressBar = document.getElementById('LightProgress');
            const statusEl = document.getElementById('LightStatus');
            
            if (data.status === "error") {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.illumination = 'failed';
                return;
            }
            
            progressBar.style.width = data.value + '%';
            
            let statusText, indicatorClass;
            switch(data.status) {
                case 'too_dark':
                case 'too_bright':
                    statusText = data.status === 'too_dark' 
                        ? translations[currentLang].status_too_dark 
                        : translations[currentLang].status_too_bright;
                    indicatorClass = 'failed';
                    break;
                default: 
                    statusText = translations[currentLang].status_optimal;
                    indicatorClass = 'passed';
            }
            
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.illumination = indicatorClass;
        }

        function updateFaceIndicator(data) {
            const indicator = document.getElementById('FaceIndicator');
            const progressBar = document.getElementById('FaceProgress');
            const statusEl = document.getElementById('FaceStatus');
            
            if (data.status === "error") {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.face = 'failed';
                return;
            }
            
            let progressValue, statusText, indicatorClass;
            
            if (!data.detected) {
                progressValue = 0;
                statusText = translations[currentLang].status_not_found;
                indicatorClass = 'failed';
            } else {
                progressValue = Math.min(data.size / 40 * 100, 100);
                
                switch(data.status) {
                    case 'too_small':
                    case 'too_large':
                        statusText = data.status === 'too_small' 
                            ? translations[currentLang].status_too_small 
                            : translations[currentLang].status_too_large;
                        indicatorClass = 'failed';
                        break;
                    case 'out_of_zone':
                        statusText = translations[currentLang].status_out_of_zone;
                        indicatorClass = 'failed';
                        break;
                    case 'tilted':
                        statusText = translations[currentLang].status_tilted;
                        indicatorClass = 'failed';
                        break;
                    default: 
                        statusText = translations[currentLang].status_optimal;
                        indicatorClass = 'passed';
                }
            }
            
            progressBar.style.width = progressValue + '%';
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.face = indicatorClass;
        }

        function updatePoseIndicator(data) {
            const indicator = document.getElementById('PoseIndicator');
            const progressBar = document.getElementById('PoseProgress');
            const statusEl = document.getElementById('PoseStatus');
            
            if (data.status === "error") {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.pose = 'failed';
                return;
            }
            
            let progressValue, statusText, indicatorClass;
            
            switch(data.status) {
                case 'no_face':
                    progressValue = 0;
                    statusText = translations[currentLang].status_no_face;
                    indicatorClass = 'failed';
                    break;
                case 'partial_face':
                    progressValue = 30;
                    statusText = translations[currentLang].status_partial_face;
                    indicatorClass = 'failed';
                    break;
                case 'off_center':
                    progressValue = 50;
                    statusText = translations[currentLang].status_off_center;
                    indicatorClass = 'failed';
                    break;
                case 'tilted':
                    progressValue = 60;
                    statusText = translations[currentLang].status_tilted;
                    indicatorClass = 'failed';
                    break;
                case 'unstable':
                    progressValue = 70;
                    statusText = translations[currentLang].status_unstable;
                    indicatorClass = 'failed';
                    break;
                case 'stable':
                default:
                    progressValue = 100;
                    statusText = translations[currentLang].status_stable;
                    indicatorClass = 'passed';
            }
            
            progressBar.style.width = progressValue + '%';
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.pose = indicatorClass;
        }

        function updateVisibilityIndicator(data) {
            const indicator = document.getElementById('VisibilityIndicator');
            const progressBar = document.getElementById('VisibilityProgress');
            const statusEl = document.getElementById('VisibilityStatus');
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–∏–¥–∏–º–æ—Å—Ç–∏
            if (!data) {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_waiting;
                indicator.className = 'indicator';
                indicatorsStatus.visibility = null;
                return;
            }
            
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞
            if (data.error) {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.visibility = 'failed';
                return;
            }
            
            let progressValue, statusText, indicatorClass;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º score –∏–∑ FaceSegmenter (0-100)
            progressValue = data.score || 0;
            
            if (data.isComplete) {
                // –õ–∏—Ü–æ –≤–∏–¥–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
                statusText = translations[currentLang].status_face_visible;
                indicatorClass = 'passed';
            } else if (data.issues && data.issues.length > 0) {
                // –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–∏–¥–∏–º–æ—Å—Ç—å—é
                const issues = data.issues;
                
                if (issues.includes('hair_occlusion') || issues.includes('forehead_occluded')) {
                    statusText = translations[currentLang].status_hair_occlusion;
                    indicatorClass = 'failed';
                } else if (issues.includes('left_side_occluded') || issues.includes('right_side_occluded')) {
                    statusText = translations[currentLang].status_face_occluded;
                    indicatorClass = 'failed';
                } else if (issues.includes('left_cheek_occluded') || issues.includes('right_cheek_occluded')) {
                    statusText = translations[currentLang].status_partial_face;
                    indicatorClass = 'failed';
                } else if (issues.includes('insufficient_face_visibility') || issues.includes('low_skin_visibility')) {
                    statusText = translations[currentLang].status_partial_face;
                    indicatorClass = 'failed';
                } else if (issues.includes('hand_on_face')) {
                    statusText = translations[currentLang].tip_hand_on_face;
                    indicatorClass = 'failed';
                } else {
                    statusText = translations[currentLang].status_face_occluded;
                    indicatorClass = 'failed';
                }
            } else {
                // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                statusText = translations[currentLang].status_waiting;
                indicatorClass = '';
            }
            
            progressBar.style.width = progressValue + '%';
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.visibility = indicatorClass || null;
        }

        function drawFaceOverlay(faceData) {
            const canvas = document.getElementById('overlayCanvas');
            const ctx = canvas.getContext('2d');
            const video = document.getElementById('precheckVideo');
            
            if (!video.videoWidth || !video.videoHeight) return;
            
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (faceData.detected && faceData.bbox) {
                const bbox = faceData.bbox;
                
                // –ò–Ω–≤–µ—Ä—Ç–∏ru–µ–º X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –¥–ª—è –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                // –í–∏–¥–µ–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å transform: scaleX(-1), –ø–æ—ç—Ç–æ–º—É bbox —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –æ—Ç–∑–µ—Ä–∫–∞–ª–∏—Ç—å
                const mirroredX = 1 - bbox.x - bbox.width;
                
                const x = mirroredX * canvas.width;
                const y = bbox.y * canvas.height;
                const width = bbox.width * canvas.width;
                const height = bbox.height * canvas.height;
                
                let color, lineWidth;
                switch(faceData.status) {
                    case 'optimal':
                        color = '#10B981'; // green
                        lineWidth = 2;
                        break;
                    case 'too_small':
                    case 'too_large':
                    case 'out_of_zone':
                    case 'tilted':
                        color = '#EF4444'; // red
                        lineWidth = 3;
                        break;
                    default:
                        color = '#F59E0B'; // orange
                        lineWidth = 2;
                }
                
                // bounding box
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.strokeRect(x, y, width, height);
                
                ctx.fillStyle = color;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(
                    `${Math.round(faceData.size)}%`,
                    x + width + 5,
                    y + height / 2
                );
            }
        }

        // --- –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ ---
        function collectTips() {
            const tips = [];
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–≤–µ—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è failed)
            if (indicatorsStatus.illumination === 'failed' && precheckData.illumination) {
                if (precheckData.illumination.status === 'too_dark') {
                    tips.push(translations[currentLang].tip_light_dark);
                } else if (precheckData.illumination.status === 'too_bright') {
                    tips.push(translations[currentLang].tip_light_bright);
                }
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ª–∏—Ü–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è failed)
            if (indicatorsStatus.face === 'failed' && precheckData.face) {
                if (!precheckData.face.detected) {
                    tips.push(translations[currentLang].tip_face_not_found);
                } else if (precheckData.face.status === 'too_small') {
                    tips.push(translations[currentLang].tip_face_too_small);
                } else if (precheckData.face.status === 'too_large') {
                    tips.push(translations[currentLang].tip_face_too_large);
                } else if (precheckData.face.status === 'out_of_zone') {
                    tips.push(translations[currentLang].tip_face_out_of_zone);
                } else if (precheckData.face.status === 'tilted') {
                    tips.push(translations[currentLang].tip_face_tilted);
                }
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑—ã (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)
            if (indicatorsStatus.pose === 'failed' && precheckData.pose) {
                const pose = precheckData.pose;
                
                if (pose.status === 'no_face') {
                    tips.push(translations[currentLang].tip_pose_no_face);
                } else if (pose.status === 'partial_face') {
                    // –ß–∞—Å—Ç—å –ª–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞
                    tips.push(translations[currentLang].tip_pose_partial_face);
                } else if (pose.status === 'off_center') {
                    // –ì–ª–∞–∑–∞ –Ω–µ –ø–æ —Ü–µ–Ω—Çru —ç–∫—Ä–∞–Ω–∞
                    tips.push(translations[currentLang].tip_pose_eyes_off_center);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–º–µ—â–µ–Ω–∏—è
                    if (pose.eyesCentering && pose.eyesCentering.hint) {
                        pose.eyesCentering.hint.forEach(hint => {
                            if (hint === 'move_right') tips.push(translations[currentLang].tip_pose_move_right);
                            if (hint === 'move_left') tips.push(translations[currentLang].tip_pose_move_left);
                            if (hint === 'move_up') tips.push(translations[currentLang].tip_pose_move_up);
                            if (hint === 'move_down') tips.push(translations[currentLang].tip_pose_move_down);
                        });
                    }
                } else if (pose.status === 'tilted' || pose.isTilted) {
                    // –ì–æ–ª–æ–≤–∞ –Ω–∞–∫–ª–æ–Ω–µ–Ω–∞ ‚Äî –¥–∞—ë–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                    if (pose.issues) {
                        if (pose.issues.includes('yaw_exceeded')) {
                            // yaw > 0 ‚Äî –≥–æ–ª–æ–≤–∞ –ø–æ–≤—ë—Ä–Ω—É—Ç–∞ –≤–ø—Ä–∞–≤–æ, –Ω—É–∂–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ª–µ–≤–æ
                            if (pose.yaw > 0) {
                                tips.push(translations[currentLang].tip_pose_turn_down);
                            } else {
                                tips.push(translations[currentLang].tip_pose_turn_up);
                            }
                        }
                        if (pose.issues.includes('pitch_exceeded')) {
                            // pitch > 0 ‚Äî –≥–æ–ª–æ–≤–∞ –æ–ø—É—â–µ–Ω–∞, –Ω—É–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å
                            if (pose.pitch > 0) {
                                tips.push(translations[currentLang].tip_pose_tilt_right);
                            } else {
                                tips.push(translations[currentLang].tip_pose_tilt_left);
                            }
                        }
                        if (pose.issues.includes('roll_exceeded')) {
                            tips.push(translations[currentLang].tip_pose_straighten);
                        }
                    } else {
                        tips.push(translations[currentLang].tip_face_tilted);
                    }
                } else if (!pose.isStable) {
                    tips.push(translations[currentLang].tip_pose_unstable);
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–∞–∑ (–µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—ã)
            if (precheckData.eyes && !precheckData.eyes.bothOpen) {
                tips.push(translations[currentLang].tip_eyes_closed);
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ª–∏—Ü–∞ (FaceSegmenter)
            if (indicatorsStatus.visibility === 'failed' && precheckData.visibility) {
                const visibility = precheckData.visibility;
                
                if (visibility.issues && visibility.issues.length > 0) {
                    const issues = visibility.issues;
                    
                    // –í–æ–ª–æ—Å—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç –ª–∏—Ü–æ
                    if (issues.includes('hair_occlusion') || issues.includes('forehead_occluded')) {
                        tips.push(translations[currentLang].tip_hair_covers_face);
                    }
                    
                    // –õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ª–∏—Ü–∞ –∑–∞–∫—Ä—ã—Ç–∞
                    if (issues.includes('left_side_occluded') || issues.includes('left_cheek_occluded')) {
                        tips.push(translations[currentLang].tip_left_side_occluded);
                    }
                    
                    // –ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ª–∏—Ü–∞ –∑–∞–∫—Ä—ã—Ç–∞
                    if (issues.includes('right_side_occluded') || issues.includes('right_cheek_occluded')) {
                        tips.push(translations[currentLang].tip_right_side_occluded);
                    }
                    
                    // –û–±—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤–∏–¥–∏–º–æ—Å—Ç—å—é (ru–∫–∏, –ø—Ä–µ–¥–º–µ—Ç—ã)
                    if (issues.includes('face_occluded') || issues.includes('insufficient_face_visibility')) {
                        tips.push(translations[currentLang].tip_face_occluded);
                    }
                    
                    // ru–∫–∞ –Ω–∞ –ª–∏—Ü–µ
                    if (issues.includes('hand_on_face')) {
                        tips.push(translations[currentLang].tip_hand_on_face);
                    }
                }
            }
            
            return tips;
        }

        function checkAllIndicators() {
            const cameraPreview = document.getElementById('cameraPreview');
            const startCalibBtn = document.getElementById('startCalibBtn');
            const statusMessage = document.getElementById('statusMessage');
            const precheckStatus = document.querySelector('.precheck-status');
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ passed –∏–ª–∏ –µ—Å—Ç—å failed
            let allPassed = true;
            let hasFailed = false;
            
            Object.values(indicatorsStatus).forEach(status => {
                if (status === 'failed') {
                    hasFailed = true;
                    allPassed = false;
                } else if (status !== 'passed') {
                    allPassed = false;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–º–∫—É
            cameraPreview.className = 'camera-preview'; 
            
            if (hasFailed) {
                cameraPreview.classList.add('red-border');
            } else if (allPassed) {
                cameraPreview.classList.add('green-border');
            }
            
            if (allPassed) {
                successFrames++;
            } else {
                successFrames = 0;
            }
            
            const isConsistentSuccess = successFrames >= requiredSuccessFrames;
            
            // —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            let statusHTML = '';
            
            if (allPassed && isConsistentSuccess) {
                // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ
                statusHTML = translations[currentLang].status_all_good;
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status success-bg';
                startCalibBtn.disabled = false;
            } else if (hasFailed) {
                // –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
                const tips = collectTips();
                if (tips.length > 0) {
                    statusHTML = `
                        <div class="status-header">${translations[currentLang].status_needs_fix}</div>
                        <ul class="tips-list">
                            ${tips.map(tip => `<li class="tip-item">${tip}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    statusHTML = `<div class="status-header">${translations[currentLang].status_needs_fix}</div>`;
                }
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status error-bg';
                startCalibBtn.disabled = true;
            } else {
                // –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                statusHTML = translations[currentLang].status_checking;
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status waiting-bg';
                startCalibBtn.disabled = true;
            }
            
            statusMessage.innerHTML = statusHTML;
            
            startCalibBtn.style.display = 'block';
        }
        
        // –ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ WebGazer
        async function startWebGazerCalibration() {
            console.log('–ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ WebGazer...');

            if (faceMaskCollector && faceMaskCollector.isRunning) {
                faceMaskCollector.setPhase('calibration');
                console.log('[FaceMaskCollector] –§–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: calibration');
    }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ pre-check
            sessionData.precheck = {
                ...precheckData,
                timestamp: Date.now(),
                videoResolution: {
                    width: document.getElementById('precheckVideo')?.videoWidth,
                    height: document.getElementById('precheckVideo')?.videoHeight
                }
            };
            
            // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø QC METRICS ===
            qcMetrics = new QCMetrics({
                screenWidth: window.screen.width,
                screenHeight: window.screen.height
            });
            qcMetrics.start(); // –í–ê–ñ–ù–û: –∑–∞–ø—É—Å–∫–∞–µ–º —Ç—Ä–µ–∫–∏–Ω–≥!
            sessionStartTime = Date.now();
            console.log('[QC] QCMetrics –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω');
            
            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—É—é –æ–±–ª–∞—Å—Ç—å
            document.getElementById('precheckContainer').style.display = 'none';
            document.getElementById('calibArea').style.display = 'block';
            document.getElementById('startPrecheckBtn').style.display = 'none';
            document.getElementById('startCalibBtn').style.display = 'none';
            
            if (isPrecheckRunning) {
                stopPreCheck();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏ru–µ–º WebGazer
            await initWebGazer();
        }

        // --- WEBGAZER ---
        async function initWebGazer() {
            const btn = document.getElementById('startCalibBtn');
            const loading = document.getElementById('loadingMsg');
            const faceStatus = document.getElementById('faceStatusMsg');
            const customDot = document.getElementById('customGazeDot');
            
            if (btn) btn.style.display = 'none';
            loading.innerText = translations[currentLang].msg_init;
            faceStatus.style.display = 'block';

            try {
                await webgazer.setRegression('ridge')
                    .setGazeListener((data, clock) => {
                        const statusText = document.getElementById('faceStatusText');
                        if (data) {
                            faceDetected = true;
                            statusText.innerText = translations[currentLang].msg_face_ok;
                            statusText.className = "status-ok";

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
                            currentGaze.x = Math.round(data.x);
                            currentGaze.y = Math.round(data.y);
                            
                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞—à—É —Ç–æ—á–∫—É –≤–∑–≥–ª—è–¥–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏)
                            if (isRecording) {
                                customDot.style.display = 'block';
                                customDot.style.left = data.x + 'px';
                                customDot.style.top = data.y + 'px';
                            }
                        } else {
                            // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º faceDetected –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –Ω–∞–π–¥–µ–Ω–æ
                            statusText.innerText = translations[currentLang].msg_face_err;
                            statusText.className = "status-err";
                            currentGaze.x = null;
                            currentGaze.y = null;
                        }

                        if (data && isRecording) {
                            sessionData.eyeTracking.push({
                                x: Math.round(data.x),
                                y: Math.round(data.y),
                                t: Math.round(clock)
                            });
                            document.getElementById('pointsCounter').innerText = sessionData.eyeTracking.length;
                        }
                    })
                    .begin();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
            const calibScreen = document.getElementById('fullscreenCalibration');
            const point = document.getElementById('fullscreenCalibPoint');
            const instructionText = document.getElementById('calibInstructionText');
            const progressText = document.getElementById('calibProgressText');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —à–∞–ø–∫—É
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-bar').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
            calibScreen.classList.add('active');
            point.style.display = 'block';
            
            loading.style.display = 'none';
            
            instructionText.innerText = currentLang === 'ru' 
                ? 'üëÜ –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É, —Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–µ—ë' 
                : 'üëÜ Click on the red dot while looking at it';

            // 9 —Ç–æ—á–µ–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–æ –≤—Å–µ–º—É —ç–∫—Ä–∞–Ω—É (—Å–µ—Ç–∫–∞ 3x3)
            const positions = [
                { x: '10%', y: '10%' },   // –≤–µ—Ä—Ö-–ª–µ–≤–æ
                { x: '50%', y: '10%' },   // –≤–µ—Ä—Ö-—Ü–µ–Ω—Ç—Ä
                { x: '90%', y: '10%' },   // –≤–µ—Ä—Ö-–ø—Ä–∞–≤–æ
                { x: '10%', y: '50%' },   // —Ü–µ–Ω—Ç—Ä-–ª–µ–≤–æ
                { x: '50%', y: '50%' },   // —Ü–µ–Ω—Ç—Ä
                { x: '90%', y: '50%' },   // —Ü–µ–Ω—Ç—Ä-–ø—Ä–∞–≤–æ
                { x: '10%', y: '90%' },   // –Ω–∏–∑-–ª–µ–≤–æ
                { x: '50%', y: '90%' },   // –Ω–∏–∑-—Ü–µ–Ω—Ç—Ä
                { x: '90%', y: '90%' }    // –Ω–∏–∑-–ø—Ä–∞–≤–æ
            ];
            
            let i = 0;
            let clickCount = 0;
            
            const updatePoint = () => {
                point.style.left = positions[i].x;
                point.style.top = positions[i].y;
                progressText.innerText = currentLang === 'ru'
                    ? `–¢–æ—á–∫–∞ ${i + 1} –∏–∑ ${positions.length}`
                    : `Point ${i + 1} of ${positions.length}`;
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
            point.onclick = () => {
                clickCount++;
                
                // –ù—É–∂–Ω–æ 2 –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ª—É—á—à–µ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                if (clickCount >= 2) {
                    clickCount = 0;
                    i++;
                    
                    if (i >= positions.length) {
                        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                        point.onclick = null;
                        
                        instructionText.innerText = currentLang === 'ru'
                            ? '‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'
                            : '‚úÖ Calibration complete!';
                        progressText.innerText = '';
                        point.style.display = 'none';
                        
                        setTimeout(() => {
                            // –ü–æ—Å–ª–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ—á–Ω–æ—Å—Ç–∏
                            startGazeValidation();
                        }, 1500);
                        return;
                    }
                    
                    updatePoint();
                }
            };

            updatePoint();
            } catch (err) {
                console.error('[WebGazer] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
                loading.innerText = translations[currentLang].msg_no_face;
                faceStatus.style.display = 'none';
            }
        }
        
        // === GAZE VALIDATION: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ ===
        /**
         * –ó–∞–ø—É—Å–∫–∞–µ—Ç —ç—Ç–∞–ø –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ gaze
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 5 —Ç–æ—á–µ–∫, —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–∑–≥–ª—è–¥–∞, –≤—ã—á–∏—Å–ª—è–µ—Ç accuracy/precision
         */
        function startGazeValidation() {
            const calibScreen = document.getElementById('fullscreenCalibration');
            const point = document.getElementById('fullscreenCalibPoint');
            const instructionText = document.getElementById('calibInstructionText');
            const progressText = document.getElementById('calibProgressText');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ fullscreen)
            calibScreen.classList.add('active');
            point.style.display = 'block';
            point.style.backgroundColor = '#10B981'; // –ó–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            point.style.cursor = 'default'; // –ù–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è
            point.onclick = null; // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            
            instructionText.innerText = currentLang === 'ru'
                ? 'üëÅÔ∏è –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –∑–µ–ª—ë–Ω—É—é —Ç–æ—á–∫—É (–Ω–µ –∫–ª–∏–∫–∞–π—Ç–µ)'
                : 'üëÅÔ∏è Look at the green dot (don\'t click)';
            
            // 5 —Ç–æ—á–µ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–¥ru–≥–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞)
            const validationPositions = [
                { x: 25, y: 25 },   // –≤–µ—Ä—Ö-–ª–µ–≤–æ
                { x: 75, y: 25 },   // –≤–µ—Ä—Ö-–ø—Ä–∞–≤–æ
                { x: 50, y: 50 },   // —Ü–µ–Ω—Ç—Ä
                { x: 25, y: 75 },   // –Ω–∏–∑-–ª–µ–≤–æ
                { x: 75, y: 75 }    // –Ω–∏–∑-–ø—Ä–∞–≤–æ
            ];
            
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            
            let currentPoint = 0;
            validationPoints = []; // –°–±—Ä–æ—Å
            isValidating = true;
            
            const SAMPLES_PER_POINT = 30; // ~1 —Å–µ–∫—É–Ω–¥–∞ –ø—Ä–∏ 30 FPS
            const SAMPLE_INTERVAL = 33; // ~30 FPS
            let currentSamples = [];
            let sampleCount = 0;
            let samplingInterval = null;
            
            function showNextPoint() {
                if (currentPoint >= validationPositions.length) {
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                    finishValidation();
                    return;
                }
                
                const pos = validationPositions[currentPoint];
                const targetX = (pos.x / 100) * screenW;
                const targetY = (pos.y / 100) * screenH;
                
                point.style.left = pos.x + '%';
                point.style.top = pos.y + '%';
                
                progressText.innerText = currentLang === 'ru'
                    ? `–¢–æ—á–∫–∞ ${currentPoint + 1} –∏–∑ ${validationPositions.length}`
                    : `Point ${currentPoint + 1} of ${validationPositions.length}`;
                
                // –°–±—Ä–æ—Å —Å–µ–º–ø–ª–æ–≤
                currentSamples = [];
                sampleCount = 0;
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–±–æ—Ä–∞ (—á—Ç–æ–±—ã –≥–ª–∞–∑–∞ —É—Å–ø–µ–ª–∏ –ø–µ—Ä–µ–π—Ç–∏)
                setTimeout(() => {
                    // –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä —Å–µ–º–ø–ª–æ–≤
                    samplingInterval = setInterval(() => {
                        if (currentGaze.x !== null && currentGaze.y !== null) {
                            currentSamples.push({
                                gazeX: currentGaze.x,
                                gazeY: currentGaze.y,
                                targetX: targetX,
                                targetY: targetY,
                                t: Date.now()
                            });
                        }
                        sampleCount++;
                        
                        if (sampleCount >= SAMPLES_PER_POINT) {
                            clearInterval(samplingInterval);
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
                            validationPoints.push({
                                pointIndex: currentPoint,
                                targetX: targetX,
                                targetY: targetY,
                                samples: currentSamples,
                                timestamp: Date.now()
                            });
                            
                            currentPoint++;
                            showNextPoint();
                        }
                    }, SAMPLE_INTERVAL);
                }, 500); // 500ms –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º
            }
            
            function finishValidation() {
                isValidating = false;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                const metrics = calculateValidationMetrics(validationPoints);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ sessionData
                sessionData.gazeValidation = {
                    timestamp: Date.now(),
                    points: validationPoints,
                    metrics: metrics
                };
                
                console.log('[Validation] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:', metrics);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                instructionText.innerHTML = currentLang === 'ru'
                    ? `‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!<br><small>–¢–æ—á–Ω–æ—Å—Ç—å: ${metrics.accuracyPx.toFixed(0)}px | Precision: ${metrics.precisionPx.toFixed(0)}px</small>`
                    : `‚úÖ Validation complete!<br><small>Accuracy: ${metrics.accuracyPx.toFixed(0)}px | Precision: ${metrics.precisionPx.toFixed(0)}px</small>`;
                progressText.innerText = '';
                point.style.display = 'none';
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å —Ç–æ—á–∫–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                point.style.backgroundColor = '#DC2626';
                point.style.cursor = 'pointer';
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ç–µ—Å—Ç—É —Å–ª–µ–∂–µ–Ω–∏—è
                setTimeout(() => {
                    calibScreen.classList.remove('active');
                    isRecording = true;
                    startTrackingTest();
                }, 2000);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É
            showNextPoint();
        }
        
        /**
         * –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: accuracy, precision, bias
         */
        function calculateValidationMetrics(points) {
            if (!points || points.length === 0) {
                return {
                    accuracyPx: Infinity,
                    accuracyDeg: Infinity,
                    precisionPx: Infinity,
                    precisionDeg: Infinity,
                    biasX: 0,
                    biasY: 0,
                    validSamples: 0,
                    totalSamples: 0
                };
            }
            
            let allErrors = [];
            let allBiasX = [];
            let allBiasY = [];
            let totalSamples = 0;
            let validSamples = 0;
            
            points.forEach(pointData => {
                const samples = pointData.samples || [];
                totalSamples += samples.length;
                
                samples.forEach(s => {
                    if (s.gazeX !== null && s.gazeY !== null) {
                        validSamples++;
                        const errorX = s.gazeX - s.targetX;
                        const errorY = s.gazeY - s.targetY;
                        const error = Math.sqrt(errorX * errorX + errorY * errorY);
                        allErrors.push(error);
                        allBiasX.push(errorX);
                        allBiasY.push(errorY);
                    }
                });
            });
            
            if (allErrors.length === 0) {
                return {
                    accuracyPx: Infinity,
                    accuracyDeg: Infinity,
                    precisionPx: Infinity,
                    precisionDeg: Infinity,
                    biasX: 0,
                    biasY: 0,
                    validSamples: 0,
                    totalSamples: totalSamples
                };
            }
            
            // Accuracy = —Å—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ (mean error)
            const accuracyPx = allErrors.reduce((a, b) => a + b, 0) / allErrors.length;
            
            // Precision = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
            const mean = accuracyPx;
            const squaredDiffs = allErrors.map(e => Math.pow(e - mean, 2));
            const precisionPx = Math.sqrt(squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length);
            
            // Bias = —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (—Å—Ä–µ–¥–Ω–∏–π –≤–µ–∫—Ç–æ—Ä –æ—à–∏–±–∫–∏)
            const biasX = allBiasX.reduce((a, b) => a + b, 0) / allBiasX.length;
            const biasY = allBiasY.reduce((a, b) => a + b, 0) / allBiasY.length;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –≥—Ä–∞–¥—É—Å—ã (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ, –ø—Ä–∏ —Ç–∏–ø–∏—á–Ω–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ ~60—Å–º)
            // 1 –≥—Ä–∞–¥—É—Å ‚âà 35 –ø–∏–∫—Å–µ–ª–µ–π –ø—Ä–∏ 60—Å–º –∏ —Ç–∏–ø–∏—á–Ω–æ–º –º–æ–Ω–∏—Ç–æ—Ä–µ
            const PX_PER_DEGREE = 35;
            
            return {
                accuracyPx: accuracyPx,
                accuracyDeg: accuracyPx / PX_PER_DEGREE,
                precisionPx: precisionPx,
                precisionDeg: precisionPx / PX_PER_DEGREE,
                biasX: biasX,
                biasY: biasY,
                validSamples: validSamples,
                totalSamples: totalSamples,
                validPct: totalSamples > 0 ? (validSamples / totalSamples * 100).toFixed(1) : '0.0'
            };
        }
        
        // --- –¢–ï–°–¢ –°–õ–ï–ñ–ï–ù–ò–Ø –ó–ê –§–ò–ì–£–†–ê–ú–ò ---
        function startTrackingTest() {

            if (faceMaskCollector && faceMaskCollector.isRunning) {
                faceMaskCollector.setPhase('stimuli');
                console.log('[FaceMaskCollector] –§–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: stimuli');
            }

            const testArea = document.getElementById('trackingTestArea');
            const shape = document.getElementById('testShape');
            const progressText = document.getElementById('testProgressText');
            const progressFill = document.getElementById('testProgressFill');
            const customDot = document.getElementById('customGazeDot');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Ç–µ—Å—Ç–∞
            testArea.classList.add('active');
            
            // –†–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            
            // –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ñ–∏–≥—É—Ä
            const trajectories = [
                // 1. –öru–≥ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
                { shape: 'circle', duration: 4000, path: (t) => ({ 
                    x: 50 + (screenW - 100) * t, 
                    y: screenH / 2 
                })},
                // 2. –ö–≤–∞–¥—Ä–∞—Ç ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                { shape: 'square', duration: 4000, path: (t) => ({ 
                    x: screenW / 2, 
                    y: 50 + (screenH - 100) * t 
                })},
                // 3. –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ‚Äî –¥–∏–∞–≥–æ–Ω–∞–ª—å
                { shape: 'triangle', duration: 4000, path: (t) => ({ 
                    x: 50 + (screenW - 100) * t, 
                    y: 50 + (screenH - 100) * t 
                })},
                // 4. –öru–≥ ‚Äî –∫ru–≥–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                { shape: 'circle', duration: 5000, path: (t) => ({ 
                    x: screenW / 2 + Math.cos(t * 2 * Math.PI) * (screenW / 4), 
                    y: screenH / 2 + Math.sin(t * 2 * Math.PI) * (screenH / 4) 
                })},
                // 5. –ö–≤–∞–¥—Ä–∞—Ç ‚Äî –∑–∏–≥–∑–∞–≥
                { shape: 'square', duration: 5000, path: (t) => ({ 
                    x: 50 + (screenW - 100) * t, 
                    y: screenH / 2 + Math.sin(t * 4 * Math.PI) * (screenH / 4)
                })}
            ];
            
            let currentTrajectory = 0;
            const testStartTime = Date.now();
            
            // === QC: –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –ª–∏—Ü–∞ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ ===
            let qcAnalysisInterval = null;
            const video = document.getElementById('precheckVideo');
            
            // === CAMERA FPS MONITOR: –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∑–º–µ—Ä–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ FPS –∫–∞–º–µ—Ä—ã ===
            if (video && video.srcObject) {
                // –°–æ–∑–¥–∞—ë–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä FPS –∫–∞–º–µ—Ä—ã
                startCameraFpsMonitor(video);
                console.log('[TrackingTest] CameraFPSMonitor –∑–∞–ø—É—â–µ–Ω');
            }
            
            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –µ—â—ë –¥–æ—Å—Ç—É–ø–Ω–æ, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è QC
            if (video && video.srcObject && localAnalyzer) {
                qcAnalysisInterval = setInterval(async () => {
                    try {
                        const precheckResult = await localAnalyzer.analyzeFrame(video);
                        let segmenterResult = null;
                        if (faceSegmenter) {
                            segmenterResult = await faceSegmenter.segmentFrame(video, precheckResult.landmarks);
                        }
                        // –ü–µ—Ä–µ–¥–∞—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ QCMetrics –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ face/pose/illumination
                        if (qcMetrics && qcMetrics.isRunning()) {
                            qcMetrics.processFrame(precheckResult, segmenterResult);
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏ru–µ–º –æ—à–∏–±–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞
                    }
                }, 100); // ~10 FPS –¥–ª—è QC –∞–Ω–∞–ª–∏–∑–∞
            }
            
            function runTrajectory() {
                if (currentTrajectory >= trajectories.length) {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º QC –∞–Ω–∞–ª–∏–∑
                    if (qcAnalysisInterval) {
                        clearInterval(qcAnalysisInterval);
                        qcAnalysisInterval = null;
                    }
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CameraFPSMonitor
                    stopCameraFpsMonitor();
                    console.log(`[TrackingTest] CameraFPSMonitor –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°—Ä–µ–¥–Ω–∏–π FPS: ${getAverageCameraFps()}`);
                    finishTrackingTest();
                    return;
                }
                
                const traj = trajectories[currentTrajectory];
                shape.className = 'test-shape ' + traj.shape;
                
                const startTime = performance.now();
                
                function animate() {
                    const elapsed = performance.now() - startTime;
                    const t = Math.min(elapsed / traj.duration, 1);
                    
                    const pos = traj.path(t);
                    shape.style.left = pos.x + 'px';
                    shape.style.top = pos.y + 'px';
                    
                    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ñ–∏–≥—É—Ä—ã –ò –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
                    sessionData.trackingTest.push({
                        trajectory: currentTrajectory,
                        shape: traj.shape,
                        shapeX: Math.round(pos.x),
                        shapeY: Math.round(pos.y),
                        gazeX: currentGaze.x,
                        gazeY: currentGaze.y,
                        t: Date.now() - testStartTime
                    });
                    
                    // === QC METRICS: –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ –≤–∑–≥–ª—è–¥–∞ ===
                    if (qcMetrics && qcMetrics.isRunning()) {
                        // –ù–æ–≤–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞: addGazePoint(gazeData, poseData)
                        // gazeData = { x, y } - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
                        // poseData = { yaw, pitch } - —É–≥–ª—ã –≥–æ–ª–æ–≤—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                        const gazeData = currentGaze.x !== null ? { x: currentGaze.x, y: currentGaze.y } : null;
                        
                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∑—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ precheck –∞–Ω–∞–ª–∏–∑–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                        let poseData = null;
                        if (precheckData && precheckData.pose) {
                            poseData = {
                                yaw: precheckData.pose.yaw || 0,
                                pitch: precheckData.pose.pitch || 0
                            };
                        }
                        
                        qcMetrics.addGazePoint(gazeData, poseData);
                    }
                    // === END QC METRICS ===
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const totalProgress = ((currentTrajectory + t) / trajectories.length) * 100;
                    progressFill.style.width = totalProgress + '%';
                    
                    if (t < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        currentTrajectory++;
                        setTimeout(runTrajectory, 500);
                    }
                }
                
                animate();
            }
            
            runTrajectory();
        }
        
        function finishTrackingTest() {
            const testArea = document.getElementById('trackingTestArea');
            const progressText = document.getElementById('testProgressText');
            const customDot = document.getElementById('customGazeDot');
            
            progressText.innerText = translations[currentLang].test_complete;
            
            setTimeout(() => {
                testArea.classList.remove('active');
                customDot.style.display = 'none';
                
                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é, –ø–æ—Ç–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI
                finishSession();
            }, 1500);
        }

        async function finishSession() {
            isRecording = false;
    
            console.log('[finishSession] ===== –ù–ê–ß–ê–õ–û –ó–ê–í–ï–†–®–ï–ù–ò–Ø –°–ï–°–°–ò–ò =====');
    
            // === –û–°–¢–ê–ù–û–í–ö–ê EMOTION ANALYZER & FACE MASK COLLECTOR ===
            console.log('[finishSession] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª–µ–π...');
    
            if (emotionAnalyzer) {
                console.log('[finishSession] EmotionAnalyzer —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', {
                    isRunning: emotionAnalyzer.isRunning,
                    eventsCount: emotionAnalyzer.getEvents().length
                });
        
                if (emotionAnalyzer.isRunning) {
                    emotionAnalyzer.stop();
                    console.log('[finishSession] ‚è∏Ô∏è EmotionAnalyzer –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }
            } else {
                console.warn('[finishSession] ‚ö†Ô∏è EmotionAnalyzer –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)!');
            }
    
            if (faceMaskCollector) {
                console.log('[finishSession] FaceMaskCollector —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', {
                    isRunning: faceMaskCollector.isRunning,
                    masksCount: faceMaskCollector.getMasks().length
                });
        
                if (faceMaskCollector.isRunning) {
                    faceMaskCollector.stop();
                    console.log('[finishSession] ‚è∏Ô∏è FaceMaskCollector –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }
            } else {
                console.warn('[finishSession] ‚ö†Ô∏è FaceMaskCollector –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)!');
            }
    
            // === –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• –ú–û–î–£–õ–ï–ô –í sessionData ===
            console.log('[finishSession] –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π...');
    
            if (emotionAnalyzer) {
                try {
                    const emotionData = emotionAnalyzer.exportToJSON();
                    console.log('[finishSession] –î–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–π:', {
                        totalEvents: emotionData.events?.length || 0,
                        metadata: emotionData.metadata
                    });
            
                    sessionData.emotions = emotionData;
                    console.log('[finishSession] ‚úÖ –î–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–π —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                } catch (error) {
                    console.error('[finishSession] ‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —ç–º–æ—Ü–∏–π:', error);
                }
            } else {
                console.warn('[finishSession] ‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ —ç–º–æ—Ü–∏–π (–º–æ–¥—É–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)');
            }
    
            if (faceMaskCollector) {
                try {
                    const maskData = faceMaskCollector.exportToJSON();
                    console.log('[finishSession] –î–∞–Ω–Ω—ã–µ –º–∞—Å–æ–∫:', {
                        totalMasks: maskData.masks?.length || 0,
                        metadata: maskData.metadata
                    });
            
                    sessionData.faceMasks = maskData;
                    console.log('[finishSession] ‚úÖ –î–∞–Ω–Ω—ã–µ –º–∞—Å–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
            
                    // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞–º—è—Ç–∏
                    const memoryUsage = faceMaskCollector.getMemoryUsage();
                    console.log(`[finishSession] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–∞–º—è—Ç–∏: ${memoryUsage.bufferSizeMB} MB (${memoryUsage.bufferLength} –º–∞—Å–æ–∫)`);
                } catch (error) {
                    console.error('[finishSession] ‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–∞—Å–æ–∫:', error);
                }
            } else {
                console.warn('[finishSession] ‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–∞—Å–æ–∫ (–º–æ–¥—É–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)');
            }
    
            // –ü–†–û–í–ï–†–ö–ê: –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ sessionData
            console.log('[finishSession] –ü—Ä–æ–≤–µ—Ä–∫–∞ sessionData:', {
                hasEmotions: !!sessionData.emotions,
                hasFaceMasks: !!sessionData.faceMasks,
                emotionEventsCount: sessionData.emotions?.events?.length || 0,
                faceMasksCount: sessionData.faceMasks?.masks?.length || 0
            });
    
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebGazer
            try {
                webgazer.pause();
            } catch (e) {
                console.warn('[finishSession] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ WebGazer:', e);
            }
    
            const webgazerContainer = document.getElementById('webgazerVideoContainer');
            if (webgazerContainer) webgazerContainer.style.display = 'none';
            document.getElementById('customGazeDot').style.display = 'none';
    
            // === QC METRICS: –ø–æ–ª—É—á–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç ===
            if (qcMetrics) {
                try {
                    if (qcMetrics.flush) {
                        // –¢–∞–π–º–∞—É—Ç –Ω–∞ flush —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–Ω—É—Ç—å
                        await Promise.race([
                            qcMetrics.flush(),
                            new Promise((_, reject) => setTimeout(() => reject('flush timeout'), 2000))
                        ]).catch(e => console.warn('[QC] Flush timeout or error:', e));
                    }
                    const qcSummary = qcMetrics.getSummary();
                    sessionData.qcSummary = qcSummary;
                    console.log('[QC] Summary:', qcSummary);
            
                    updateFinalStepWithQC(qcSummary);
                } catch (e) {
                    console.warn('[finishSession] –û—à–∏–±–∫–∞ QC metrics:', e);
                }
            }
    
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å active —Å–æ step5
            document.getElementById('step5').classList.remove('active');
    
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.querySelector('.container').style.display = 'block';
            document.querySelector('.top-bar').style.display = 'flex';
    
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥
            nextStep(6);
    
            console.log('[finishSession] ===== –ö–û–ù–ï–¶ –ó–ê–í–ï–†–®–ï–ù–ò–Ø –°–ï–°–°–ò–ò =====');
            console.log('[finishSession] –ò—Ç–æ–≥–æ–≤—ã–π sessionData (–∫—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è):', {
                ids: sessionData.ids,
                hasEmotions: !!sessionData.emotions,
                hasFaceMasks: !!sessionData.faceMasks,
                hasQC: !!sessionData.qcSummary
            });
        }

        // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —à–∞–≥–∞ 6 –Ω–∞ –æ—Å–Ω–æ–≤–µ QC ===
        function updateFinalStepWithQC(qcSummary) {
            const qcStatusEl = document.getElementById('qcStatusBlock');
            if (!qcStatusEl || !qcSummary) return;
            
            // getSummary() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—è –Ω–∞–ø—Ä—è–º—É—é, –Ω–µ –≤–æ –≤–ª–æ–∂–µ–Ω–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ metrics
            const passed = qcSummary.overallPass;
            const totalFrames = qcSummary.totalFrames || 0;
            const validGazePct = qcSummary.gazeValidPct || 0;
            const faceOkPct = qcSummary.faceOkPct || 0;
            const durationMs = qcSummary.durationMs || 0;
            
            if (passed) {
                qcStatusEl.innerHTML = `
                    <div style="background: #F0FDF4; padding: 15px; border-radius: 8px; border: 1px solid #BBF7D0; color: #166534; margin-bottom: 20px;">
                        <strong>‚úÖ ${currentLang === 'ru' ? '–î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã (QC Passed)' : 'Data Valid (QC Passed)'}</strong>
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                            ${currentLang === 'ru' ? '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å' : 'Duration'}: ${Math.round(durationMs / 1000)}s | 
                            ${currentLang === 'ru' ? '–í–∞–ª–∏–¥–Ω—ã—Ö' : 'Valid'}: ${validGazePct.toFixed(1)}% | 
                            ${currentLang === 'ru' ? '–õ–∏—Ü–æ OK' : 'Face OK'}: ${faceOkPct.toFixed(1)}%
                        </div>
                    </div>
                `;
            } else {
                // –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º –∏–∑ –æ–±—ä–µ–∫—Ç–∞ checks
                const issues = [];
                if (qcSummary.checks) {
                    if (!qcSummary.checks.duration) issues.push('short_duration');
                    if (!qcSummary.checks.faceVisible) issues.push('low_face_visible');
                    if (!qcSummary.checks.faceOk) issues.push('low_face_ok_pct');
                    if (!qcSummary.checks.poseOk) issues.push('low_pose_ok_pct');
                    if (!qcSummary.checks.illuminationOk) issues.push('low_illumination_ok_pct');
                    if (!qcSummary.checks.eyesOpen) issues.push('low_eyes_open_pct');
                    if (!qcSummary.checks.occlusion) issues.push('high_occlusion_pct');
                    if (!qcSummary.checks.gazeValid) issues.push('low_gaze_valid_pct');
                    if (!qcSummary.checks.gazeOnScreen) issues.push('high_offscreen');
                    if (!qcSummary.checks.lowFps) issues.push('low_fps_time');
                }
                
                const issueTexts = {
                    'insufficient_data': currentLang === 'ru' ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö' : 'Insufficient data',
                    'low_gaze_valid_pct': currentLang === 'ru' ? '–ú–∞–ª–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ—á–µ–∫ –≤–∑–≥–ª—è–¥–∞' : 'Low valid gaze percentage',
                    'low_face_ok_pct': currentLang === 'ru' ? '–õ–∏—Ü–æ —á–∞—Å—Ç–æ —Ç–µ—Ä—è–ª–æ—Å—å' : 'Face frequently lost',
                    'high_offscreen': currentLang === 'ru' ? '–í–∑–≥–ª—è–¥ —á–∞—Å—Ç–æ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞' : 'Gaze often offscreen',
                    'short_duration': currentLang === 'ru' ? '–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è —Å–µ—Å—Å–∏—è' : 'Session too short',
                    'low_face_visible': currentLang === 'ru' ? '–õ–∏—Ü–æ –ø–ª–æ—Ö–æ –≤–∏–¥–Ω–æ' : 'Face poorly visible',
                    'low_pose_ok_pct': currentLang === 'ru' ? '–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –ø–æ–∑–∞ –≥–æ–ª–æ–≤—ã' : 'Unstable head pose',
                    'low_illumination_ok_pct': currentLang === 'ru' ? '–ü–ª–æ—Ö–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ' : 'Poor lighting',
                    'low_eyes_open_pct': currentLang === 'ru' ? '–ì–ª–∞–∑–∞ —á–∞—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—ã' : 'Eyes often closed',
                    'high_occlusion_pct': currentLang === 'ru' ? '–õ–∏—Ü–æ —á–∞—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç–æ' : 'Face often occluded',
                    'low_fps_time': currentLang === 'ru' ? '–ù–∏–∑–∫–∏–π FPS –∫–∞–º–µ—Ä—ã' : 'Low camera FPS'
                };
                const issuesList = issues.map(issue => issueTexts[issue] || issue).join(', ');
                
                qcStatusEl.innerHTML = `
                    <div style="background: #FEF2F2; padding: 15px; border-radius: 8px; border: 1px solid #FECACA; color: #991B1B; margin-bottom: 20px;">
                        <strong>‚ö†Ô∏è ${currentLang === 'ru' ? '–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ –Ω–æ—Ä–º—ã' : 'Data quality below threshold'}</strong>
                        <div style="font-size: 12px; margin-top: 8px;">
                            ${currentLang === 'ru' ? '–ü—Ä–æ–±–ª–µ–º—ã' : 'Issues'}: ${issuesList || 'N/A'}
                        </div>
                        <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">
                            ${currentLang === 'ru' ? '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å' : 'Duration'}: ${Math.round(durationMs / 1000)}s | 
                            ${currentLang === 'ru' ? '–í–∞–ª–∏–¥–Ω—ã—Ö' : 'Valid'}: ${validGazePct.toFixed(1)}% | 
                            ${currentLang === 'ru' ? '–õ–∏—Ü–æ OK' : 'Face OK'}: ${faceOkPct.toFixed(1)}%
                        </div>
                    </div>
                `;
            }
        }

        function downloadData() {
            const fileName = `session_${sessionData.ids.session}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sessionData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", fileName);
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', function() {
            if (emotionAnalyzer && emotionAnalyzer.isRunning) {
                emotionAnalyzer.stop();
            }
            if (faceMaskCollector && faceMaskCollector.isRunning) {
                faceMaskCollector.stop();
            }
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (isPrecheckRunning) {
                stopPreCheck();
            }
            if (webgazer) {
                webgazer.end();
            }
        });
    </script>
</body>
</html>

