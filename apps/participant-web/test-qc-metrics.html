<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>QC Metrics Test</title>
    <script src="js/qc-metrics.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #166534; }
        .fail { background: #991B1B; }
        .info { background: #1e40af; }
        pre { background: #0f0f1a; padding: 10px; border-radius: 5px; overflow-x: auto; }
        h2 { color: #4ECDC4; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ QC Metrics Module Test</h1>
    
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        let testsPassed = 0;
        let testsFailed = 0;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            
            if (type === 'pass') testsPassed++;
            if (type === 'fail') testsFailed++;
        }
        
        function assert(condition, testName, details = '') {
            if (condition) {
                log(`‚úÖ ${testName}`, 'pass');
            } else {
                log(`‚ùå ${testName}<br><small>${details}</small>`, 'fail');
            }
        }
        
        // ========== –¢–ï–°–¢–´ ==========
        
        log('<h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è</h2>');
        
        assert(typeof QCMetrics !== 'undefined', 'QCMetrics –∫–ª–∞—Å—Å –¥–æ—Å—Ç—É–ø–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ');
        assert(typeof QCMetrics === 'function', 'QCMetrics —è–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º');
        
        // ========== –¢–ï–°–¢ 2: –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ ==========
        log('<h2>2. –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞</h2>');
        
        let qc;
        try {
            qc = new QCMetrics({
                screenWidth: 1920,
                screenHeight: 1080
            });
            assert(true, '–≠–∫–∑–µ–º–ø–ª—è—Ä QCMetrics —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ');
        } catch (e) {
            assert(false, '–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞', e.message);
        }
        
        assert(typeof qc.addGazePoint === 'function', '–ú–µ—Ç–æ–¥ addGazePoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        assert(typeof qc.getSummary === 'function', '–ú–µ—Ç–æ–¥ getSummary —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        assert(typeof qc.reset === 'function', '–ú–µ—Ç–æ–¥ reset —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        
        // ========== –¢–ï–°–¢ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –≤–∑–≥–ª—è–¥–∞ ==========
        log('<h2>3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –≤–∑–≥–ª—è–¥–∞</h2>');
        
        qc.reset();
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º 100 —Ç–æ—á–µ–∫ –≤–∑–≥–ª—è–¥–∞ (80% –≤–∞–ª–∏–¥–Ω—ã—Ö)
        for (let i = 0; i < 100; i++) {
            const isValid = i < 80; // 80 –≤–∞–ª–∏–¥–Ω—ã—Ö, 20 –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö
            const x = isValid ? Math.random() * 1920 : null;
            const y = isValid ? Math.random() * 1080 : null;
            qc.addGazePoint(x, y, i * 50, isValid); // –∫–∞–∂–¥—ã–µ 50–º—Å
        }
        
        const summary1 = qc.getSummary();
        log(`<pre>${JSON.stringify(summary1, null, 2)}</pre>`, 'info');
        
        assert(summary1.metrics.totalPoints === 100, '–í—Å–µ–≥–æ —Ç–æ—á–µ–∫ = 100', `–ü–æ–ª—É—á–µ–Ω–æ: ${summary1.metrics.totalPoints}`);
        assert(summary1.metrics.validGazePoints === 80, '–í–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ—á–µ–∫ = 80', `–ü–æ–ª—É—á–µ–Ω–æ: ${summary1.metrics.validGazePoints}`);
        assert(summary1.metrics.validGazePercent === 80, '–ü—Ä–æ—Ü–µ–Ω—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö = 80%', `–ü–æ–ª—É—á–µ–Ω–æ: ${summary1.metrics.validGazePercent}`);
        
        // ========== –¢–ï–°–¢ 4: QC Pass/Fail –ª–æ–≥–∏–∫–∞ ==========
        log('<h2>4. QC Pass/Fail –ª–æ–≥–∏–∫–∞</h2>');
        
        // –¢–µ—Å—Ç —Å —Ö–æ—Ä–æ—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ–ª–∂–µ–Ω pass)
        qc.reset();
        for (let i = 0; i < 200; i++) {
            qc.addGazePoint(
                Math.random() * 1920, 
                Math.random() * 1080, 
                i * 50, 
                true
            );
        }
        const goodSummary = qc.getSummary();
        assert(goodSummary.passed === true, '–•–æ—Ä–æ—à–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Üí passed = true', `passed: ${goodSummary.passed}, issues: ${goodSummary.issues.join(', ')}`);
        
        // –¢–µ—Å—Ç —Å –ø–ª–æ—Ö–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ–ª–∂–µ–Ω fail)
        qc.reset();
        for (let i = 0; i < 50; i++) {
            // –¢–æ–ª—å–∫–æ 30% –≤–∞–ª–∏–¥–Ω—ã—Ö
            const isValid = i < 15;
            qc.addGazePoint(
                isValid ? Math.random() * 1920 : null,
                isValid ? Math.random() * 1080 : null,
                i * 50,
                isValid
            );
        }
        const badSummary = qc.getSummary();
        assert(badSummary.passed === false, '–ü–ª–æ—Ö–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Üí passed = false', `passed: ${badSummary.passed}`);
        assert(badSummary.issues.length > 0, '–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ issues', `issues: ${badSummary.issues.join(', ')}`);
        
        // ========== –¢–ï–°–¢ 5: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö ==========
        log('<h2>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ insufficient_data</h2>');
        
        qc.reset();
        for (let i = 0; i < 10; i++) { // –¢–æ–ª—å–∫–æ 10 —Ç–æ—á–µ–∫
            qc.addGazePoint(Math.random() * 1920, Math.random() * 1080, i * 50, true);
        }
        const fewPointsSummary = qc.getSummary();
        assert(
            fewPointsSummary.issues.includes('insufficient_data'), 
            '–ú–∞–ª–æ —Ç–æ—á–µ–∫ ‚Üí insufficient_data issue',
            `issues: ${fewPointsSummary.issues.join(', ')}`
        );
        
        // ========== –¢–ï–°–¢ 6: Offscreen gaze ==========
        log('<h2>6. –ü—Ä–æ–≤–µ—Ä–∫–∞ offscreen gaze</h2>');
        
        qc.reset();
        for (let i = 0; i < 100; i++) {
            // 50% –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞
            const x = i < 50 ? Math.random() * 1920 : 2500; // –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
            const y = i < 50 ? Math.random() * 1080 : -100; // –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
            qc.addGazePoint(x, y, i * 50, true);
        }
        const offscreenSummary = qc.getSummary();
        log(`<pre>onScreenPercent: ${offscreenSummary.metrics.onScreenPercent}%</pre>`, 'info');
        assert(
            offscreenSummary.metrics.onScreenPercent < 60,
            '–ü–æ–ª–æ–≤–∏–Ω–∞ offscreen ‚Üí onScreenPercent < 60%',
            `onScreenPercent: ${offscreenSummary.metrics.onScreenPercent}`
        );
        
        // ========== –¢–ï–°–¢ 7: Dropout tracking ==========
        log('<h2>7. Dropout tracking</h2>');
        
        qc.reset();
        // –°–∏–º—É–ª–∏—Ä—É–µ–º dropout: 20 –≤–∞–ª–∏–¥–Ω—ã—Ö, 30 null, 50 –≤–∞–ª–∏–¥–Ω—ã—Ö
        for (let i = 0; i < 100; i++) {
            const isDropout = i >= 20 && i < 50;
            const x = isDropout ? null : Math.random() * 1920;
            const y = isDropout ? null : Math.random() * 1080;
            qc.addGazePoint(x, y, i * 50, !isDropout);
        }
        const dropoutSummary = qc.getSummary();
        log(`<pre>dropoutCount: ${dropoutSummary.metrics.dropoutCount}, maxDropoutMs: ${dropoutSummary.metrics.maxDropoutMs}</pre>`, 'info');
        assert(
            dropoutSummary.metrics.dropoutCount >= 1,
            '–û–±–Ω–∞—Ä—É–∂–µ–Ω dropout —Å–µ–≥–º–µ–Ω—Ç',
            `dropoutCount: ${dropoutSummary.metrics.dropoutCount}`
        );
        
        // ========== –ò–¢–û–ì–ò ==========
        log('<h2>üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>');
        log(`<strong>–ü—Ä–æ–π–¥–µ–Ω–æ: ${testsPassed}</strong> | <strong style="color: #f87171;">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${testsFailed}</strong>`, 
            testsFailed === 0 ? 'pass' : 'fail');
        
        if (testsFailed === 0) {
            log('üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! QC Metrics —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.', 'pass');
        } else {
            log('‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–∫—É.', 'fail');
        }
    </script>
</body>
</html>
