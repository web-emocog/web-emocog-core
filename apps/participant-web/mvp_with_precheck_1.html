<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoCog Research (Multilingual)</title>
    
    <!-- CDN WebGazer -->
    <script src="https://cdn.jsdelivr.net/npm/webgazer@3.3.0/dist/webgazer.min.js"></script>
    
    <style>
        /* CSS - –°—Ç–∏–ª–∏ */
        :root {
            --primary: #2563EB;
            --primary-hover: #1D4ED8;
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #111827;
            --text-secondary: #4B5563;
            --border: #E5E7EB;
            --input-bg: #F9FAFB;
            --header-bg: #FFFFFF;
            --success: #16a34a;
            --warning: #f59e0b;
            --error: #dc2626;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding-top: 70px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: var(--header-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .id-badge {
            font-family: 'Monaco', monospace; font-size: 12px; background: #EFF6FF;
            color: var(--primary); padding: 6px 12px; border-radius: 6px;
            border: 1px solid #BFDBFE; display: none; cursor: pointer; margin-right: 15px;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ */
        .lang-switch {
            display: flex; gap: 5px; font-size: 13px; font-weight: 600;
        }
        .lang-btn {
            cursor: pointer; padding: 4px 8px; border-radius: 4px; color: var(--text-secondary);
            transition: all 0.2s;
        }
        .lang-btn.active {
            background-color: var(--primary); color: white;
        }

        .container {
            background-color: var(--card-bg); width: 100%; max-width: 680px;
            padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-top: 20px; margin-bottom: 40px; position: relative;
        }

        .step { display: none; animation: fadeIn 0.4s ease; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 28px; margin-bottom: 10px; text-align: center; }
        h2 { font-size: 24px; margin-bottom: 20px; text-align: center; }
        h3 { font-size: 14px; margin-top: 25px; margin-bottom: 15px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            background-color: var(--primary); color: white; border: none; padding: 16px 28px;
            border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;
            transition: all 0.2s; margin-top: 20px;
        }
        .btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { background-color: #E5E7EB; color: #9CA3AF; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: transparent; color: var(--text-secondary); margin-top: 10px; border: 1px solid var(--border); }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
        .form-group select, .form-group input {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 15px; background-color: var(--input-bg); box-sizing: border-box;
        }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }

        .consent-box { background: #F8FAFC; padding: 20px; border-radius: 12px; height: 200px; overflow-y: auto; font-size: 14px; margin-bottom: 20px; border: 1px solid var(--border); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; border: 2px solid var(--border); border-radius: 12px; }

        /* –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ */
        .calibration-area {
            height: 350px; background: #F8FAFC; border: 2px dashed var(--border);
            border-radius: 12px; position: relative; overflow: hidden;
        }
        
        .calib-point {
            width: 30px; height: 30px; background-color: #DC2626;
            position: absolute; transition: all 0.5s ease; cursor: pointer; z-index: 20;
            filter: drop-shadow(0 0 6px rgba(220, 38, 38, 0.6));
        }
        .calib-point.circle { border-radius: 50%; clip-path: none; }
        .calib-point.square { border-radius: 4px; clip-path: none; transform: rotate(45deg); }
        .calib-point.star {
            border-radius: 0; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            background-color: #DC2626;
        }

        #webgazerVideoContainer {
            position: fixed !important; top: 70px !important; left: 10px !important;
            width: 160px !important; height: 120px !important;
            border-radius: 8px; border: 2px solid var(--primary); opacity: 0.8; z-index: 50;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ç–æ—á–∫—É WebGazer (–æ–Ω–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –º—ã—à—å—é) */
        #webgazerGazeDot {
            display: none !important;
        }
        
        /* –ù–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∑–≥–ª—è–¥–∞ */
        #customGazeDot {
            position: fixed;
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 0, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            display: none;
        }

        .face-status { font-weight: bold; margin-top: 10px; font-size: 14px; }
        .status-ok { color: var(--success); }
        .status-err { color: var(--error); }

        /* –¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ —Ñ–∏–≥—É—Ä–∞–º–∏ */
        .tracking-test-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a2e;
            z-index: 2000;
            display: none;
        }
        
        .tracking-test-area.active {
            display: block;
        }
        
        .test-shape {
            position: absolute;
            width: 50px;
            height: 50px;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .test-shape.circle {
            background: #FF6B6B;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
        }
        
        .test-shape.square {
            background: #4ECDC4;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.6);
        }
        
        .test-shape.triangle {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid #FFE66D;
            background: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 230, 109, 0.6));
        }
        
        .test-progress {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            z-index: 2001;
            text-align: center;
        }
        
        .test-progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 10px;
        }
        
        .test-progress-fill {
            height: 100%;
            background: #4ECDC4;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* Fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ */
        .fullscreen-calibration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a2e;
            z-index: 2000;
            display: none;
        }
        
        .fullscreen-calibration.active {
            display: block;
        }
        
        .fullscreen-calib-point {
            width: 40px;
            height: 40px;
            background-color: #DC2626;
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2001;
            filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.8));
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        
        .fullscreen-calib-point:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .calib-instruction {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 2002;
        }
        
        .calib-progress {
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        /* pre-check */
        .precheck-container {
            margin: 25px 0;
        }

        .camera-preview {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 360px;
            margin: 0 auto 25px;
            border-radius: 12px;
            overflow: hidden;
            background: #1a1a2e;
            border: 3px solid #E5E7EB;
            transition: border-color 0.3s ease;
        }

        .camera-preview.green-border {
            border-color: var(--success) !important;
        }

        .camera-preview.red-border {
            border-color: var(--error) !important;
        }

        #precheckVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .face-guide {
            position: absolute;
            top: 20%;
            left: 20%;
            right: 20%;
            bottom: 20%;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            pointer-events: none;
            transition: border-color 0.3s ease;
        }

        .guide-text {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (pre-check) */
        .indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .indicator .icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #9CA3AF;
        }

        .indicator .label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
            margin-bottom: 6px;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: #9CA3AF;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .indicator .status {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
            text-align: center;
            min-height: 16px;
            color: #9CA3AF;
        }

        /* –°—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (pre-check) */
        .indicator.passed .progress-bar {
            background-color: rgba(16, 163, 74, 0.7);
        }

        .indicator.passed .icon {
            color: var(--success);
        }

        .indicator.passed .status {
            color: var(--success);
        }

        .indicator.failed .progress-bar {
            background-color: rgba(239, 68, 68, 0.7);
        }

        .indicator.failed .icon {
            color: var(--error);
        }

        .indicator.failed .status {
            color: var(--error);
        }

        /* –°—Ç–∞—Ç—É—Å –ø—Ä–µ—á–µ–∫–∞ - –±–ª–æ–∫ */
        .precheck-status {
            text-align: center;
            margin: 20px 0;
            padding: 18px;
            border-radius: 8px;
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            animation: fadeIn 0.4s ease;
            transition: all 0.3s ease;
        }

        .precheck-status.success-bg {
            background: #F0F9FF;
            border-color: #BBF7D0;
            color: #166534;
        }

        .precheck-status.error-bg {
            background: #FEF2F2;
            border-color: #FECACA;
            color: #991B1B;
        }

        .precheck-status.waiting-bg {
            background: #FFFBEB;
            border-color: #FDE68A;
            color: #92400E;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å–Ω–æ–≥–æ –±–ª–æ–∫–∞ */
        .precheck-status .status-message {
            font-size: 15px;
            font-weight: 500;
            margin: 0;
            line-height: 1.4;
            color: inherit;
        }

        .precheck-status .status-message.success,
        .precheck-status .status-message.error,
        .precheck-status .status-message.waiting {
            background: transparent !important;
            border: none !important;
            color: inherit !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        .status-header {
            text-align: center;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 16px;
            display: block;
            color: inherit;
        }

        .tips-list {
            text-align: left;
            margin: 10px 0 0 0;
            padding-left: 20px;
            color: inherit;
        }

        .tip-item {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 6px;
            color: inherit;
        }

        .precheck-status.error-bg .tip-item {
            color: #991B1B;
        }

        .precheck-status.error-bg .tips-subtitle {
            text-align: left;
            color: #991B1B;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .precheck-status.success-bg .tip-item {
            color: #166534;
        }

        .precheck-status.waiting-bg .tip-item {
            color: #92400E;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ */
        .tips-list {
            text-align: left;
            margin: 10px 0 0 0;
            padding-left: 20px;
            color: inherit;
            list-style-type: none;
        }

        .tip-item {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
            color: inherit;
            position: relative;
            padding-left: 16px;
        }

        .tip-item::before {
            content: "";
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .precheck-status.error-bg .tip-item::before {
            background-color: #991B1B; /* –ö—Ä–∞—Å–Ω—ã–π */
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-buttons .btn {
            flex: 1;
            margin-top: 0;
        }
    </style>
</head>
<body>

    <!-- Fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ -->
    <div id="fullscreenCalibration" class="fullscreen-calibration">
        <div class="calib-instruction">
            <span id="calibInstructionText">üëÜ –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É, —Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–µ—ë</span>
            <div class="calib-progress">
                <span id="calibProgressText">–¢–æ—á–∫–∞ 1 –∏–∑ 9</span>
            </div>
        </div>
        <div id="fullscreenCalibPoint" class="fullscreen-calib-point"></div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Ç–µ—Å—Ç–∞ —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ —Ñ–∏–≥—É—Ä–∞–º–∏ (fullscreen) -->
    <div id="trackingTestArea" class="tracking-test-area">
        <div class="test-progress">
            <span id="testProgressText">–°–ª–µ–¥–∏—Ç–µ –≥–ª–∞–∑–∞–º–∏ –∑–∞ —Ñ–∏–≥—É—Ä–æ–π</span>
            <div class="test-progress-bar">
                <div class="test-progress-fill" id="testProgressFill" style="width: 0%"></div>
            </div>
        </div>
        <div id="testShape" class="test-shape circle"></div>
    </div>

    <!-- –ù–∞—à–∞ —Ç–æ—á–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∑–≥–ª—è–¥–∞ -->
    <div id="customGazeDot"></div>

    <!-- –®–∞–ø–∫–∞ -->
    <div class="top-bar">
        <div style="font-weight: bold; color: var(--text-main);">EmoCog Research</div>
        <div style="display: flex; align-items: center;">
            <div id="idDisplay" class="id-badge" onclick="copyIds()" title="Copy ID">ID: ...</div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
            <div class="lang-switch">
                <div class="lang-btn active" id="langRu" onclick="setLanguage('ru')">RU</div>
                <div style="color:#E5E7EB">|</div>
                <div class="lang-btn" id="langEn" onclick="setLanguage('en')">EN</div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- –®–ê–ì 1: –õ—ç–Ω–¥–∏–Ω–≥ -->
        <div id="step1" class="step active">
            <h1 data-i18n="welcome_title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
            <p style="text-align: center;" data-i18n="welcome_subtitle">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ –≤–Ω–∏–º–∞–Ω–∏—è –∏ —ç–º–æ—Ü–∏–π</p>
            
            <div style="background: #FEF2F2; padding: 15px; border-radius: 8px; border: 1px solid #FECACA; margin: 20px 0;">
                <strong style="color: #991B1B;" data-i18n="warning_title">‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong>
                <ul style="margin: 10px 0 0 20px; color: #7F1D1D; font-size: 14px;">
                    <li data-i18n="warning_1">–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–µ–±-–∫–∞–º–µ—Ä–∞</li>
                    <li data-i18n="warning_2">–î–∞–Ω–Ω—ã–µ –æ –≤–∑–≥–ª—è–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</li>
                    <li data-i18n="warning_3">–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ –≤–∞—à–µ–≥–æ –ª–∏—Ü–∞</li>
                </ul>
            </div>

            <button class="btn" onclick="nextStep(2)" data-i18n="btn_start">–ù–∞—á–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</button>
        </div>

        <!-- –®–ê–ì 2: –°–æ–≥–ª–∞—Å–∏–µ -->
        <div id="step2" class="step">
            <h2 data-i18n="consent_header">–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ</h2>
            <div class="consent-box">
                <h4 data-i18n="consent_1_title">1. –¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h4>
                <p data-i18n="consent_1_text">–ú—ã –ø—Ä–æ–≤–æ–¥–∏–º –Ω–∞—É—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π. –í–∞—à–µ —É—á–∞—Å—Ç–∏–µ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –ª—é–¥–∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
                <h4 data-i18n="consent_2_title">2. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</h4>
                <p data-i18n="consent_2_text">–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
                <p><a href="https://docs.google.com/document/d/1ILmtItogsXz78ozzsKLNkmWnRVm990MvSryaDPSbxzg/edit?usp=sharing" target="_blank" data-i18n="consent_link">–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—Å–∏—è</a></p>
            </div>
            <label class="checkbox-wrapper">
                <input type="checkbox" id="consentCheck" onchange="toggleConsent()">
                <span data-i18n="consent_checkbox">–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞), –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç, –∏ —è —Å–æ–≥–ª–∞—Å–µ–Ω(–∞).</span>
            </label>
            <button class="btn" id="consentBtn" disabled onclick="generateIdsAndProceed()" data-i18n="btn_confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>

        <!-- –®–ê–ì 3: Email -->
        <div id="step3" class="step">
            <h2 data-i18n="reg_title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <p data-i18n="reg_desc">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Email –¥–ª—è —Å–≤—è–∑–∏.</p>
            
            <div class="form-group">
                <label data-i18n="email_label">Email</label>
                <input type="email" id="userEmail" placeholder="name@example.com">
            </div>
            
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                <span id="generatedIdPreview"></span>
            </div>

            <button class="btn" onclick="collectTechDataAndProceed()" data-i18n="btn_next">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–ê–ì 4: –ê–Ω–∫–µ—Ç–∞ -->
         <div id="step4" class="step">
            <h2 data-i18n="form_title">–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <form id="userForm" onchange="checkForm()">
                <h3 data-i18n="form_section_user">üë§ –û –≤–∞—Å</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_age">–í–æ–∑—Ä–∞—Å—Ç</label>
                        <input type="number" id="age" min="18" max="99">
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_gender">–ü–æ–ª</label>
                        <select id="gender">
                            <option value="" disabled selected data-i18n="opt_select">–í—ã–±—Ä–∞—Ç—å...</option>
                            <option value="m" data-i18n="opt_m">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="f" data-i18n="opt_f">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_lang">–†–æ–¥–Ω–æ–π —è–∑—ã–∫</label>
                        <select id="language">
                            <option value="ru" data-i18n="opt_ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en" data-i18n="opt_en">English</option>
                            <option value="other" data-i18n="opt_other">–î—Ä—É–≥–æ–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_edu">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</label>
                        <select id="education">
                            <option value="student" data-i18n="opt_edu_school">–°—Ä–µ–¥–Ω–µ–µ</option>
                            <option value="student" data-i18n="opt_edu_student">–°—Ç—É–¥–µ–Ω—Ç</option>
                            <option value="higher" data-i18n="opt_edu_higher">–í—ã—Å—à–µ–µ</option>
                            <option value="degree" data-i18n="opt_edu_degree">–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å</option>
                        </select>
                    </div>
                </div>

                <h3 data-i18n="form_section_tech">üëÅÔ∏è –ó—Ä–µ–Ω–∏–µ –∏ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_vision">–ó—Ä–µ–Ω–∏–µ</label>
                        <select id="vision">
                            <option value="normal" data-i18n="opt_vis_norm">–ù–æ—Ä–º–∞</option>
                            <option value="glasses" data-i18n="opt_vis_glass">–û—á–∫–∏</option>
                            <option value="lenses" data-i18n="opt_vis_lens">–õ–∏–Ω–∑—ã</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_pathology">–ü–∞—Ç–æ–ª–æ–≥–∏–∏</label>
                        <select id="visionIssues">
                            <option value="none" data-i18n="opt_path_none">–ù–µ—Ç</option>
                            <option value="hemianopsia" data-i18n="opt_path_hemi">–ì–µ–º–∏–∞–Ω–æ–ø—Å–∏—è</option>
                            <option value="scotoma" data-i18n="opt_path_scot">–°–∫–æ—Ç–æ–º–∞</option>
                            <option value="colorblind" data-i18n="opt_path_color">–î–∞–ª—å—Ç–æ–Ω–∏–∑–º</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_hand">–í–µ–¥—É—â–∞—è —Ä—É–∫–∞</label>
                        <select id="hand">
                            <option value="right" data-i18n="opt_hand_r">–ü—Ä–∞–≤–∞—è</option>
                            <option value="left" data-i18n="opt_hand_l">–õ–µ–≤–∞—è</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_device">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–≤–æ–¥–∞</label>
                        <select id="inputDevice">
                            <option value="mouse" data-i18n="opt_dev_mouse">–ú—ã—à—å</option>
                            <option value="touchpad" data-i18n="opt_dev_touch">–¢–∞—á–ø–∞–¥</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="label_keyboard">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞</label>
                         <select id="keyboardType">
                            <option value="internal" data-i18n="opt_kb_int">–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è</option>
                            <option value="external" data-i18n="opt_kb_ext">–í–Ω–µ—à–Ω—è—è</option>
                        </select>
                    </div>
                </div>
            </form>
            <button class="btn" id="formBtn" disabled onclick="nextStep(5)" data-i18n="btn_next">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–ê–ì 5: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã (pre-check) -->
        <div id="step5" class="step">
            <h2 data-i18n="calib_title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–º–µ—Ä—ã</h2>
            <p style="text-align: center;" data-i18n="calib_desc">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –∫–∞–º–µ—Ä—É –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –∑–∞—Ç–µ–º –Ω–∞—á–Ω—ë–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.</p>
            
            <!-- pre-check –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
            <div class="precheck-container" id="precheckContainer">
                <!-- –≤–∏–¥–µ–æ –ø—Ä–µ–≤—å—é -->
                <div class="camera-preview" id="cameraPreview">
                    <video id="precheckVideo" autoplay muted playsinline></video>
                    <canvas id="overlayCanvas"></canvas>
                    <div class="face-guide"></div>
                    <div class="guide-text" data-i18n="guide_text">–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ –ª–∏—Ü–æ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏</div>
                </div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
                <div class="indicators">
                    <div class="indicator" id="LightIndicator">
                        <div class="icon">üí°</div>
                        <div class="label" data-i18n="label_light">–û—Å–≤–µ—â–µ–Ω–∏–µ</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="LightProgress"></div>
                        </div>
                        <div class="status" id="LightStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                    
                    <div class="indicator" id="FaceIndicator">
                        <div class="icon">üë§</div>
                        <div class="label" data-i18n="label_face">–õ–∏—Ü–æ</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="FaceProgress"></div>
                        </div>
                        <div class="status" id="FaceStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                    
                    <div class="indicator" id="PoseIndicator">
                        <div class="icon">üéØ</div>
                        <div class="label" data-i18n="label_pose">–ü–æ–∑–∞ –≥–æ–ª–æ–≤—ã</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="PoseProgress"></div>
                        </div>
                        <div class="status" id="PoseStatus" data-i18n="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="precheck-status">
                    <p class="status-message" id="statusMessage" data-i18n="precheck_initial">
                        –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É" —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                    </p>
                </div>
            </div>
            
            <!-- –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å (—Å–∫—Ä—ã—Ç–∞ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ) -->
            <div id="calibArea" style="display: none;">
                <div class="calibration-area">
                    <div class="calib-point circle" id="calibPoint" style="top: 50%; left: 50%; display: none;"></div>
                    
                    <div id="loadingMsg" style="position: absolute; top: 40%; width: 100%; text-align: center; color: var(--text-secondary);">
                        <div style="margin-bottom: 10px;" data-i18n="msg_press_btn">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏...</div>
                    </div>
                    
                    <div id="faceStatusMsg" style="position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 12px; display:none;">
                        <span data-i18n="status_label">–°—Ç–∞—Ç—É—Å:</span> <span id="faceStatusText">...</span> <br>
                        <span data-i18n="points_label">–ó–∞–ø–∏—Å–∞–Ω–æ —Ç–æ—á–µ–∫:</span> <span id="pointsCounter">0</span>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-buttons">
                <button class="btn" id="startPrecheckBtn" onclick="startPreCheck()" data-i18n="btn_start_precheck">
                    üé• –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                </button>
                <button class="btn" id="startCalibBtn" style="display: none;" onclick="startWebGazerCalibration()" data-i18n="btn_start_calib">
                    ‚úÖ –ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                </button>
            </div>
        </div>

        <!-- –®–ê–ì 6: –§–∏–Ω–∞–ª -->
        <div id="step6" class="step">
            <h2 data-i18n="final_title">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p data-i18n="final_desc">–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ. –î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.</p>
            <div style="background: #F0FDF4; padding: 15px; border-radius: 8px; border: 1px solid #BBF7D0; color: #166534; margin-bottom: 20px;">
                <span data-i18n="qc_passed">‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã (QC Passed)</span>
            </div>
            <button class="btn" onclick="downloadData()" data-i18n="btn_download">üì• –°–∫–∞—á–∞—Ç—å JSON</button>
            <button class="btn btn-secondary" onclick="location.reload()" data-i18n="btn_restart">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>

    </div>

    <script>
        const BACKEND_CONFIG = {
            BASE_URL: 'http://localhost:5000', 
            ENDPOINTS: {
                ANALYZE_FRAME: '/api/analyze-frame'
            },
            SEND_INTERVAL: 300, // –æ—Ç–ø–∞—Ä–≤–ª—è–µ–º –∫–∞–¥—Ä—ã –∫–∞–∂–¥—ã–µ 300–º—Å
            MAX_FRAME: 60, // –º–∞–∫—Å–∏–º—É–º 60 –∫–∞–¥—Ä–æ–≤
            COMPRESSION_QUALITY: 0.7 // –∫–∞—á–µ—Å—Ç–≤–æ JPEG –¥–ª—è —Å–∂–∞—Ç–∏—è
        };

        // --- –°–õ–û–í–ê–†–¨ (TRANSLATIONS) ---
        const translations = {
            ru: {
                welcome_title: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
                welcome_subtitle: "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ –≤–Ω–∏–º–∞–Ω–∏—è –∏ —ç–º–æ—Ü–∏–π",
                warning_title: "‚ö†Ô∏è –í–∞–∂–Ω–æ:",
                warning_1: "–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–µ–±-–∫–∞–º–µ—Ä–∞",
                warning_2: "–î–∞–Ω–Ω—ã–µ –æ –≤–∑–≥–ª—è–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ",
                warning_3: "–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ –≤–∞—à–µ–≥–æ –ª–∏—Ü–∞",
                btn_start: "–ù–∞—á–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ",
                consent_header: "–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ",
                consent_1_title: "1. –¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
                consent_1_text: "–ú—ã –ø—Ä–æ–≤–æ–¥–∏–º –Ω–∞—É—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π. –í–∞—à–µ —É—á–∞—Å—Ç–∏–µ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –ª—é–¥–∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.",
                consent_2_title: "2. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å",
                consent_2_text: "–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.",
                consent_link: "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—Å–∏—è",
                consent_checkbox: "–Ø –ø—Ä–æ—á–∏—Ç–∞–ª(–∞), –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç, –∏ —è —Å–æ–≥–ª–∞—Å–µ–Ω(–∞).",
                btn_confirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                reg_title: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞",
                reg_desc: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Email –¥–ª—è —Å–≤—è–∑–∏.",
                email_label: "Email",
                btn_next: "–î–∞–ª–µ–µ",
                form_title: "–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞",
                form_section_user: "üë§ –û –≤–∞—Å",
                label_age: "–í–æ–∑—Ä–∞—Å—Ç",
                label_gender: "–ü–æ–ª",
                opt_select: "–í—ã–±—Ä–∞—Ç—å...",
                opt_m: "–ú—É–∂—Å–∫–æ–π",
                opt_f: "–ñ–µ–Ω—Å–∫–∏–π",
                label_lang: "–†–æ–¥–Ω–æ–π —è–∑—ã–∫",
                opt_ru: "–†—É—Å—Å–∫–∏–π",
                opt_en: "English",
                opt_other: "–î—Ä—É–≥–æ–π",
                label_edu: "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                opt_edu_school: "–°—Ä–µ–¥–Ω–µ–µ",
                opt_edu_student: "–°—Ç—É–¥–µ–Ω—Ç",
                opt_edu_higher: "–í—ã—Å—à–µ–µ",
                opt_edu_degree: "–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å",
                form_section_tech: "üëÅÔ∏è –ó—Ä–µ–Ω–∏–µ –∏ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                label_vision: "–ó—Ä–µ–Ω–∏–µ",
                opt_vis_norm: "–ù–æ—Ä–º–∞",
                opt_vis_glass: "–û—á–∫–∏",
                opt_vis_lens: "–õ–∏–Ω–∑—ã",
                label_pathology: "–ü–∞—Ç–æ–ª–æ–≥–∏–∏",
                opt_path_none: "–ù–µ—Ç",
                opt_path_hemi: "–ì–µ–º–∏–∞–Ω–æ–ø—Å–∏—è",
                opt_path_scot: "–°–∫–æ—Ç–æ–º–∞",
                opt_path_color: "–î–∞–ª—å—Ç–æ–Ω–∏–∑–º",
                label_hand: "–í–µ–¥—É—â–∞—è —Ä—É–∫–∞",
                opt_hand_r: "–ü—Ä–∞–≤–∞—è",
                opt_hand_l: "–õ–µ–≤–∞—è",
                label_device: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–≤–æ–¥–∞",
                opt_dev_mouse: "–ú—ã—à—å",
                opt_dev_touch: "–¢–∞—á–ø–∞–¥",
                label_keyboard: "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞",
                opt_kb_int: "–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è",
                opt_kb_ext: "–í–Ω–µ—à–Ω—è—è",
                calib_title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã",
                calib_desc: "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –∑–∞—Ç–µ–º –Ω–∞—á–Ω—ë–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.",
                msg_press_btn: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏...",
                status_label: "–°—Ç–∞—Ç—É—Å:",
                points_label: "–ó–∞–ø–∏—Å–∞–Ω–æ —Ç–æ—á–µ–∫:",
                btn_camera: "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É",
                final_title: "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
                final_desc: "–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ. –î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.",
                qc_passed: "‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã (QC Passed)",
                btn_download: "üì• –°–∫–∞—á–∞—Ç—å JSON",
                btn_restart: "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ",
                // pre-check
                label_light: "–û—Å–≤–µ—â–µ–Ω–∏–µ",
                label_face: "–õ–∏—Ü–æ",
                label_pose: "–ü–æ–∑–∞ –≥–æ–ª–æ–≤—ã",
                status_waiting: "–û–∂–∏–¥–∞–Ω–∏–µ...",
                guide_text: "–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ –ª–∏—Ü–æ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏",
                precheck_initial: "–ù–∞–∂–º–∏—Ç–µ \"–ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É\" —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É",
                precheck_requesting: "‚è≥ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...",
                precheck_checking: "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è...",
                precheck_camera_error: "‚ùå –û—à–∏–±–∫–∞: ",
                precheck_all_good: "‚úÖ –í—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É",
                btn_start_precheck: "üé• –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É",
                btn_start_calib: "‚úÖ –ù–∞—á–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É",
                // —Å—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (pre-check)
                status_too_dark: "–¢–µ–º–Ω–æ",
                status_too_bright: "–Ø—Ä–∫–æ",
                status_optimal: "–û—Ç–ª–∏—á–Ω–æ",
                status_normal: "–ù–æ—Ä–º–∞",
                status_not_found: "–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
                status_too_small: "–î–∞–ª–µ–∫–æ –æ—Ç –∫–∞–º–µ—Ä—ã",
                status_too_large: "–ë–ª–∏–∑–∫–æ –∫ –∫–∞–º–µ—Ä–µ",
                status_stable: "–°—Ç–∞–±–∏–ª—å–Ω–æ",
                status_unstable: "–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ",
                status_no_face: "–ù–µ—Ç –ª–∏—Ü–∞",
                status_all_good: "üéâ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞! –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É",
                status_needs_fix: "üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å",
                status_checking: "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è",
                //–ø–æ–¥—Å–∫–∞–∑–∫–∏
                tip_light_dark: "–°–ª–∏—à–∫–æ–º —Ç–µ–º–Ω–æ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É –∏–ª–∏ –ø–æ–¥–æ–π—Ç–∏ –∫ –æ–∫–Ω—É",
                tip_light_bright: "–°–ª–∏—à–∫–æ–º —è—Ä–∫–æ, –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–µ—Ç –ø—Ä—è–º–æ –≤ –∫–∞–º–µ—Ä—É –∏–ª–∏ –æ—Ç–æ–π–¥–∏—Ç–µ –æ—Ç –æ–∫–Ω–∞",
                tip_face_not_found: "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–∞–¥—Ä–∞",
                tip_face_too_small: "–í—ã —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ, –ø–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å –±–ª–∏–∂–µ –∫ –∫–∞–º–µ—Ä–µ",
                tip_face_too_large: "–í—ã —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ, –æ—Ç–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å –æ—Ç –∫–∞–º–µ—Ä—ã",
                tip_pose_no_face: "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ—Å—å –ø–æ —Ü–µ–Ω—Ç—Ä—É –∫–∞–¥—Ä–∞",
                tip_pose_unstable: "–ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ –∫–∞–º–µ—Ä—É –∏ –Ω–µ –¥–≤–∏–≥–∞—Ç—å—Å—è",
                // Dynamic JS strings
                id_participant: "–í–∞—à ID —É—á–∞—Å—Ç–Ω–∏–∫–∞:",
                id_not_generated: "ID –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω",
                msg_init: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏... –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.",
                msg_face_ok: "–õ–∏—Ü–æ –Ω–∞–π–¥–µ–Ω–æ (OK)",
                msg_face_err: "–õ–∏—Ü–æ –ù–ï –Ω–∞–π–¥–µ–Ω–æ (–ü–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å)",
                msg_wait_stable: "–ñ–¥–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ª–∏—Ü–∞...",
                msg_face_locked: "–õ–∏—Ü–æ –∑–∞—Ö–≤–∞—á–µ–Ω–æ! –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫...",
                msg_no_face: "–ù–µ –≤–∏–∂—É –ª–∏—Ü–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.",
                status_error: "‚ùå –û—à–∏–±–∫–∞",
                // –¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è
                test_tracking_title: "–¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è",
                test_follow_shape: "–°–ª–µ–¥–∏—Ç–µ –≥–ª–∞–∑–∞–º–∏ –∑–∞ —Ñ–∏–≥—É—Ä–æ–π",
                test_progress: "–ü—Ä–æ–≥—Ä–µ—Å—Å:",
                test_complete: "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!"
            },
            en: {
                welcome_title: "Welcome",
                welcome_subtitle: "Attention and Emotion Assessment Platform",
                warning_title: "‚ö†Ô∏è Important:",
                warning_1: "You will need a webcam",
                warning_2: "Gaze data is processed on your device",
                warning_3: "We do not save video of your face",
                btn_start: "Start Research",
                consent_header: "Informed Consent",
                consent_1_title: "1. Research Goal",
                consent_1_text: "We are conducting scientific research on cognitive reactions. Your participation helps us understand perception.",
                consent_2_title: "2. Privacy",
                consent_2_text: "We collect anonymized data. Video stream is processed locally.",
                consent_link: "Full Consent Text",
                consent_checkbox: "I have read, I am 18+, and I agree.",
                btn_confirm: "Confirm and Continue",
                reg_title: "Participant Registration",
                reg_desc: "Please provide your Email.",
                email_label: "Email",
                btn_next: "Next",
                form_title: "Participant Survey",
                form_section_user: "üë§ About You",
                label_age: "Age",
                label_gender: "Gender",
                opt_select: "Select...",
                opt_m: "Male",
                opt_f: "Female",
                label_lang: "Native Language",
                opt_ru: "Russian",
                opt_en: "English",
                opt_other: "Other",
                label_edu: "Education",
                opt_edu_school: "Secondary",
                opt_edu_student: "Student",
                opt_edu_higher: "Higher",
                opt_edu_degree: "PhD / Degree",
                form_section_tech: "üëÅÔ∏è Vision & Hardware",
                label_vision: "Vision",
                opt_vis_norm: "Normal",
                opt_vis_glass: "Glasses",
                opt_vis_lens: "Contact Lenses",
                label_pathology: "Pathologies",
                opt_path_none: "None",
                opt_path_hemi: "Hemianopsia",
                opt_path_scot: "Scotoma",
                opt_path_color: "Color Blindness",
                label_hand: "Dominant Hand",
                opt_hand_r: "Right",
                opt_hand_l: "Left",
                label_device: "Input Device",
                opt_dev_mouse: "Mouse",
                opt_dev_touch: "Touchpad",
                label_keyboard: "Keyboard",
                opt_kb_int: "Internal",
                opt_kb_ext: "External",
                calib_title: "Camera Setup",
                calib_desc: "First we'll check conditions for participation, then start calibration.",
                msg_press_btn: "Preparing calibration...",
                status_label: "Status:",
                points_label: "Points recorded:",
                btn_camera: "Enable Camera",
                final_title: "Session Completed!",
                final_desc: "Thank you for participating. Data generated.",
                qc_passed: "‚úÖ Data Valid (QC Passed)",
                btn_download: "üì• Download JSON",
                btn_restart: "Start Over",
                // pre-check
                label_light: "Lighting",
                label_face: "Face",
                label_pose: "Head Pose",
                status_waiting: "Waiting...",
                guide_text: "Position your face inside the frame",
                precheck_initial: "Click \"Start Check\" to enable camera",
                precheck_requesting: "‚è≥ Requesting camera access...",
                precheck_checking: "‚è≥ Checking conditions...",
                precheck_camera_error: "‚ùå Error: ",
                precheck_all_good: "‚úÖ –°heck is passed! You can start calibration",
                btn_start_precheck: "üé• Start Check",
                btn_start_calib: "‚úÖ Start Calibration",
                status_error: "‚ùå Error",
                // —Å—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (pre-check)
                status_too_dark: "Too Dark",
                status_too_bright: "Too Bright",
                status_optimal: "Optimal",
                status_normal: "Normal",
                status_not_found: "Not Found",
                status_too_small: "Far from the camera",
                status_too_large: "Close to the camera",
                status_stable: "Stable",
                status_unstable: "Unstable",
                status_no_face: "No Face",
                status_all_good: "üéâ All good! You can start calibration",
                status_needs_fix: "üî¥ Needs fixing",
                status_checking: "‚è≥ Checking conditions",
                //–ø–æ–¥—Å–∫–∞–∑–∫–∏
                tip_light_dark: "Too dark, turn on a lamp or move closer to a window",
                tip_light_bright: "Too bright, don't point light directly at the camera or move away from the window",
                tip_face_not_found: "Face not detected, make sure you're in the center of the frame",
                tip_face_too_small: "You're too far away, move closer to the camera",
                tip_face_too_large: "You're too close, move away from the camera",
                tip_pose_no_face: "Face not detected, position yourself in the center of the frame",
                tip_pose_unstable: "Try to look straight at the camera and don't move",
                // Dynamic JS strings
                id_participant: "Your Participant ID:",
                id_not_generated: "ID not generated",
                msg_init: "Initializing AI... Allow camera access.",
                msg_face_ok: "Face Found (OK)",
                msg_face_err: "Face NOT Found (Move closer)",
                msg_wait_stable: "Waiting for face stabilization...",
                msg_face_locked: "Face locked! Calibration in 2s...",
                msg_no_face: "Cannot see face. Check lighting.",
               // –¢–µ—Å—Ç —Å–ª–µ–∂–µ–Ω–∏—è
                test_tracking_title: "Tracking Test",
                test_follow_shape: "Follow the shape with your eyes",
                test_progress: "Progress:",
                test_complete: "Test complete!"
            }
        };

        let currentLang = 'ru';

        function setLanguage(lang) {
            currentLang = lang;
            
            // Update UI buttons
            document.getElementById('langRu').classList.toggle('active', lang === 'ru');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');

            // Update all text elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // Update ID text if generated
            if (sessionData.ids.participant) {
                document.getElementById('generatedIdPreview').innerText = `${translations[lang].id_participant} ${sessionData.ids.participant}`;
            } else {
                document.getElementById('idDisplay').innerText = translations[lang].id_not_generated;
            }

            if (isPrecheckRunning && precheckData) {
                checkAllIndicators(); 
            }
        }

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let sessionData = {
            ids: { session: null, participant: null },
            user: { interfaceLanguage: 'ru' },
            tech: {}, 
            precheck: {},
            eyeTracking: [],
            trackingTest: [], // –î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ —Å–ª–µ–∂–µ–Ω–∏—è
            events: [],
            startTime: Date.now()
        };

        let isRecording = false;
        let faceDetected = false;
        let currentGaze = { x: null, y: null }; // –¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
        
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (pre-check) ---
        let cameraStream = null;
        let isPrecheckRunning = false;
        let analysisFrameId = null;
        let successFrames = 0;
        const requiredSuccessFrames = 15;

        let precheckData = {
            illumination: null,
            face: null,
            pose: null,
            overall: false
        };

        let indicatorsStatus = {
            illumination: null,
            face: null,
            pose: null
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑
        async function sendFrameToBackend(videoElement) {
            /*
            {
                "frame": "..image/jpeg..", //string
                "timestamp": Date.now(), //number
                "resolution": {
                    "width": canvas.width, //number
                    "height": canvas.height //number
                },
                "sessionId": "..", //string
                "participantId": ".." //string
                }
            */
            try {
                // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = videoElement.videoWidth || 640;
                canvas.height = videoElement.videoHeight || 480;
                
                // –ó–µ—Ä–∫–∞–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º (–∫–∞–∫ –≤ –≤–∏–¥–µ–æ)
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvas.toDataURL('image/jpeg', BACKEND_CONFIG.COMPRESSION_QUALITY);
                
                // –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const payload = {
                    frame: imageData,
                    timestamp: Date.now(),
                    resolution: {
                        width: canvas.width,
                        height: canvas.height
                    },
                    sessionId: sessionData.ids.session,
                    participantId: sessionData.ids.participant
                };
                
                const response = await fetch(`${BACKEND_CONFIG.BASE_URL}${BACKEND_CONFIG.ENDPOINTS.ANALYZE_FRAME}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
        
                return await response.json();
        
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–¥—Ä–∞:', error);
                throw error;
            }
        }

        async function analyzeVideoFrame(videoElement) {
            /*
            {
                "illumination": {
                    "value": 75,  //"optimal": 30 ‚â§ value ‚â§ 80
                                 // "too_dark": value < 30
                                 // "too_bright": value > 80
                    "status": "optimal"  //"optimal" | "too_dark" | "too_bright"
                },
                "face": {
                    "detected": true, // boolean
                    "size": 35, // % –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞
                    "status": "optimal", // "optimal" (20-60) | "too_small" | "too_large"
                    "bbox": {
                    "x": 0.3, // –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ (0-1)
                    "y": 0.3, // –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É (0-1)
                    "width": 0.4, // –®–∏—Ä–∏–Ω–∞ (0-1)
                    "height": 0.4 // –í—ã—Å–æ—Ç–∞ (0-1)
                    }
                },
                "pose": {
                    "status": "stable", // "stable" | "unstable" | "no_face"
                    "isStable": true // boolean
                }
            }
            */
            try {
                const results = await sendFrameToBackend(videoElement);
                
                return {
                    illumination: results.illumination,
                    face: results.face,
                    pose: results.pose,
                    timestamp: Date.now(),
                    frameSize: results.frameSize || {
                        width: videoElement.videoWidth || 640,
                        height: videoElement.videoHeight || 480
                    }
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ:', error);
                
                return {
                    error: true,
                    errorMessage: error.message || '–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                    illumination: { value: 0, status: "error" },
                    face: { detected: false, size: 0, status: "error" },
                    pose: { status: "error", isStable: false },
                    timestamp: Date.now(),
                    frameSize: { width: 640, height: 480 }
                };
            }
        }

        function nextStep(stepNumber) {
            // –ï—Å–ª–∏ —É—Ö–æ–¥–∏–º —Å–æ step5, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ—á–µ–∫
            if (document.getElementById('step5').classList.contains('active')) {
                stopPreCheckOnLeave();
            }

            if (stepNumber === 5) {
                resetIndicatorsToWaiting();
            }
            
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            const nextEl = document.getElementById('step' + stepNumber);
            if (nextEl) nextEl.classList.add('active');
        }

        function toggleConsent() {
            const chk = document.getElementById('consentCheck');
            document.getElementById('consentBtn').disabled = !chk.checked;
        }

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø ID ---
        function generateIdsAndProceed() {
            const sessionId = 'S-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const participantId = 'P-' + Math.random().toString(36).substr(2, 5).toUpperCase();
            
            sessionData.ids.session = sessionId;
            sessionData.ids.participant = participantId;
            sessionData.user.interfaceLanguage = currentLang; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫

            const idBadge = document.getElementById('idDisplay');
            idBadge.style.display = 'block';
            idBadge.innerText = `ID: ${participantId}`;
            
            document.getElementById('generatedIdPreview').innerText = `${translations[currentLang].id_participant} ${participantId}`;

            nextStep(3);
        }

        function copyIds() {
            const text = `Session: ${sessionData.ids.session}, Participant: ${sessionData.ids.participant}`;
            navigator.clipboard.writeText(text).then(() => alert('ID copied!'));
        }

        // --- –°–ë–û–† –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –î–ê–ù–ù–´–• ---
        function collectTechDataAndProceed() {
            const email = document.getElementById('userEmail').value;
            if (email) sessionData.user.email = email; 

            sessionData.tech.screen = {
                width: window.screen.width,
                height: window.screen.height,
                availWidth: window.screen.availWidth,
                availHeight: window.screen.availHeight,
                pixelRatio: window.devicePixelRatio || 1
            };

            sessionData.tech.browser = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cores: navigator.hardwareConcurrency || 'unknown',
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };

            measureFPS().then(fps => {
                sessionData.tech.measuredFPS = fps;
                nextStep(4);
            });
        }

        function measureFPS() {
            return new Promise(resolve => {
                let frames = 0;
                let startTime = performance.now();
                function loop() {
                    frames++;
                    const now = performance.now();
                    if (now - startTime >= 500) { 
                        const fps = Math.round(frames * 2); 
                        resolve(fps);
                    } else {
                        requestAnimationFrame(loop);
                    }
                }
                requestAnimationFrame(loop);
            });
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ê–ù–ö–ï–¢–´ ---
        function checkForm() {
            const required = ['age', 'gender', 'inputDevice', 'keyboardType', 'vision'];
            let isValid = true;
            required.forEach(id => {
                const el = document.getElementById(id);
                if (!el || !el.value) isValid = false;
            });
            document.getElementById('formBtn').disabled = !isValid;

            if (isValid) {
                sessionData.user = {
                    ...sessionData.user,
                    age: document.getElementById('age').value,
                    gender: document.getElementById('gender').value,
                    education: document.getElementById('education').value,
                    language: document.getElementById('language').value,
                    vision: document.getElementById('vision').value,
                    visionIssues: document.getElementById('visionIssues').value,
                    hand: document.getElementById('hand').value,
                    inputDevice: document.getElementById('inputDevice').value,
                    keyboardType: document.getElementById('keyboardType').value
                };
            }
        }

        // –°–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–û–∂–∏–¥–∞–Ω–∏–µ"
        function resetIndicatorsToWaiting() {
            const indicators = document.querySelectorAll('.indicator');
            indicators.forEach(ind => {
                ind.classList.remove('passed', 'failed');
            });
            
            document.getElementById('LightProgress').style.width = '0%';
            document.getElementById('FaceProgress').style.width = '0%';
            document.getElementById('PoseProgress').style.width = '0%';
            
            document.getElementById('LightStatus').textContent = translations[currentLang].status_waiting;
            document.getElementById('FaceStatus').textContent = translations[currentLang].status_waiting;
            document.getElementById('PoseStatus').textContent = translations[currentLang].status_waiting;
            
            const cameraPreview = document.getElementById('cameraPreview');
            cameraPreview.className = 'camera-preview';
            
            const canvas = document.getElementById('overlayCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            indicatorsStatus = {
                illumination: null,
                face: null,
                pose: null
            };
            
            successFrames = 0;
            
            const guideText = document.querySelector('.guide-text');
            if (guideText) {
                guideText.textContent = translations[currentLang].guide_text;
            }
            
            const statusMessage = document.getElementById('statusMessage');
            const precheckStatus = document.querySelector('.precheck-status');
            if (statusMessage) {
                statusMessage.textContent = translations[currentLang].precheck_initial;
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
            }
            
            // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
            const startPrecheckBtn = document.getElementById('startPrecheckBtn');
            const startCalibBtn = document.getElementById('startCalibBtn');
            
            if (startPrecheckBtn) {
                startPrecheckBtn.style.display = 'block';
                startPrecheckBtn.disabled = false;
            }
            
            if (startCalibBtn) {
                startCalibBtn.style.display = 'none';
                startCalibBtn.disabled = true;
            }
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ—á–µ–∫ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –®–ê–ì–ê 5
        function stopPreCheckOnLeave() {
            if (isPrecheckRunning) {
                stopPreCheck();
            }
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            isPrecheckRunning = false;
        }

        // pre-check
        async function startPreCheck() {
            console.log('–ó–∞–ø—É—Å–∫ pre-check –∫–∞–º–µ—Ä—ã...');
    
            if (isPrecheckRunning) {
                stopPreCheck();
                return;
            }
    
            const startPrecheckBtn = document.getElementById('startPrecheckBtn');
            const startCalibBtn = document.getElementById('startCalibBtn');
            const statusMessage = document.getElementById('statusMessage');
            const precheckStatus = document.querySelector('.precheck-status');
            
            startPrecheckBtn.style.display = 'none';
            startCalibBtn.style.display = 'block';
            startCalibBtn.disabled = true;
            
            statusMessage.textContent = translations[currentLang].precheck_requesting;
            precheckStatus.className = 'precheck-status waiting-bg';
    
            try {
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true 
                });
                
                const video = document.getElementById('precheckVideo');
                video.srcObject = cameraStream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        console.log(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–µ–æ: ${video.videoWidth}x${video.videoHeight}`);
                        
                        // —Ä–∞–∑–º–µ—Ä—ã canvas –¥–ª—è overlay
                        const canvas = document.getElementById('overlayCanvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        resolve();
                    };
                });
                
                statusMessage.textContent = translations[currentLang].precheck_checking;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
                startContinuousAnalysis();
        
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                statusMessage.textContent = translations[currentLang].precheck_camera_error + error.message;
                precheckStatus.className = 'precheck-status error-bg';
                
                startPrecheckBtn.style.display = 'block';
                startCalibBtn.style.display = 'none';
                
            }
        }

        function stopPreCheck() {
            isPrecheckRunning = false;
            if (analysisFrameId) {
                cancelAnimationFrame(analysisFrameId);
                analysisFrameId = null;
            }
        }

        function startContinuousAnalysis() {
            isPrecheckRunning = true;
            successFrames = 0;
            
            const video = document.getElementById('precheckVideo');
    
            async function analyzeFrame() {
                if (!isPrecheckRunning) return;
                
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–¥—Ä –≤ –±—ç–∫
                    const results = await analyzeVideoFrame(video);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    updateIndicators(results);
                    
                    precheckData = results;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                    checkAllIndicators();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–¥—Ä–∞:', error);
                }
                
                analysisFrameId = setTimeout(analyzeFrame, BACKEND_CONFIG.SEND_INTERVAL);
            }
    
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –∞–Ω–∞–ª–∏–∑–∞
            analyzeFrame();
        }

        function updateIndicators(data) {
            updateIlluminationIndicator(data.illumination);
            updateFaceIndicator(data.face);
            updatePoseIndicator(data.pose);

            if (data.face && data.face.detected && data.face.bbox) {
                drawFaceOverlay(data.face);
            }
        }

        function updateIlluminationIndicator(data) {
            const indicator = document.getElementById('LightIndicator');
            const progressBar = document.getElementById('LightProgress');
            const statusEl = document.getElementById('LightStatus');
            
            if (data.status === "error") {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.illumination = 'failed';
                return;
            }
            
            progressBar.style.width = data.value + '%';
            
            let statusText, indicatorClass;
            switch(data.status) {
                case 'too_dark':
                case 'too_bright':
                    statusText = data.status === 'too_dark' 
                        ? translations[currentLang].status_too_dark 
                        : translations[currentLang].status_too_bright;
                    indicatorClass = 'failed';
                    break;
                default: 
                    statusText = translations[currentLang].status_optimal;
                    indicatorClass = 'passed';
            }
            
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.illumination = indicatorClass;
        }

        function updateFaceIndicator(data) {
            const indicator = document.getElementById('FaceIndicator');
            const progressBar = document.getElementById('FaceProgress');
            const statusEl = document.getElementById('FaceStatus');
            
            if (data.status === "error") {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.face = 'failed';
                return;
            }
            
            let progressValue, statusText, indicatorClass;
            
            if (!data.detected) {
                progressValue = 0;
                statusText = translations[currentLang].status_not_found;
                indicatorClass = 'failed';
            } else {
                progressValue = Math.min(data.size / 40 * 100, 100);
                
                switch(data.status) {
                    case 'too_small':
                    case 'too_large':
                        statusText = data.status === 'too_small' 
                            ? translations[currentLang].status_too_small 
                            : translations[currentLang].status_too_large;
                        indicatorClass = 'failed';
                        break;
                    default: 
                        statusText = translations[currentLang].status_optimal;
                        indicatorClass = 'passed';
                }
            }
            
            progressBar.style.width = progressValue + '%';
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.face = indicatorClass;
        }

        function updatePoseIndicator(data) {
            const indicator = document.getElementById('PoseIndicator');
            const progressBar = document.getElementById('PoseProgress');
            const statusEl = document.getElementById('PoseStatus');
            
            if (data.status === "error") {
                progressBar.style.width = '0%';
                statusEl.textContent = translations[currentLang].status_error;
                indicator.className = 'indicator failed';
                indicatorsStatus.pose = 'failed';
                return;
            }
            
            let progressValue, statusText, indicatorClass;
            
            if (data.status === 'no_face') {
                progressValue = 0;
                statusText = translations[currentLang].status_no_face;
                indicatorClass = 'failed';
            } else {
                progressValue = data.isStable ? 100 : 50;
                statusText = data.isStable 
                    ? translations[currentLang].status_stable 
                    : translations[currentLang].status_unstable;
                indicatorClass = data.isStable ? 'passed' : 'failed';
            }
            
            progressBar.style.width = progressValue + '%';
            statusEl.textContent = statusText;
            indicator.className = `indicator ${indicatorClass}`;
            indicatorsStatus.pose = indicatorClass;
        }

        function drawFaceOverlay(faceData) {
            const canvas = document.getElementById('overlayCanvas');
            const ctx = canvas.getContext('2d');
            const video = document.getElementById('precheckVideo');
            
            if (!video.videoWidth || !video.videoHeight) return;
            
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (faceData.detected && faceData.bbox) {
                const bbox = faceData.bbox;
                const x = bbox.x * canvas.width;
                const y = bbox.y * canvas.height;
                const width = bbox.width * canvas.width;
                const height = bbox.height * canvas.height;
                
                let color, lineWidth;
                switch(faceData.status) {
                    case 'optimal':
                        color = '#10B981'; // green
                        lineWidth = 2;
                        break;
                    case 'too_small':
                    case 'too_large':
                        color = '#EF4444'; // red
                        lineWidth = 3;
                        break;
                    default:
                        color = '#F59E0B'; // orange
                        lineWidth = 2;
                }
                
                // bounding box
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.strokeRect(x, y, width, height);
                
                ctx.fillStyle = color;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(
                    `${Math.round(faceData.size)}%`,
                    x + width + 5,
                    y + height / 2
                );
                
                ctx.fillStyle = color;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(
                    `${Math.round(faceData.size)}%`,
                    x + width + 5,
                    y + height / 2
                );
            }
        }

        // --- –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ ---
        function collectTips() {
            const tips = [];
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–≤–µ—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è failed)
            if (indicatorsStatus.illumination === 'failed' && precheckData.illumination) {
                if (precheckData.illumination.status === 'too_dark') {
                    tips.push(translations[currentLang].tip_light_dark);
                } else if (precheckData.illumination.status === 'too_bright') {
                    tips.push(translations[currentLang].tip_light_bright);
                    }
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ª–∏—Ü–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è failed)
            if (indicatorsStatus.face === 'failed' && precheckData.face) {
                if (!precheckData.face.detected) {
                    tips.push(translations[currentLang].tip_face_not_found);
                } else if (precheckData.face.status === 'too_small') {
                    tips.push(translations[currentLang].tip_face_too_small);
                } else if (precheckData.face.status === 'too_large') {
                    tips.push(translations[currentLang].tip_face_too_large);
                }
            }
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è failed)
            if (indicatorsStatus.pose === 'failed' && precheckData.pose) {
                if (precheckData.pose.status === 'no_face') {
                    tips.push(translations[currentLang].tip_pose_no_face);
                } else {
                    tips.push(translations[currentLang].tip_pose_unstable);
                }
            }
            
            return tips;
        }

        function checkAllIndicators() {
            const cameraPreview = document.getElementById('cameraPreview');
            const startCalibBtn = document.getElementById('startCalibBtn');
            const statusMessage = document.getElementById('statusMessage');
            const precheckStatus = document.querySelector('.precheck-status');
            
            // –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ passed –∏–ª–∏ –µ—Å—Ç—å failed
            let allPassed = true;
            let hasFailed = false;
            
            Object.values(indicatorsStatus).forEach(status => {
                if (status === 'failed') {
                    hasFailed = true;
                    allPassed = false;
                } else if (status !== 'passed') {
                    allPassed = false;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–º–∫—É
            cameraPreview.className = 'camera-preview'; 
            
            if (hasFailed) {
                cameraPreview.classList.add('red-border');
            } else if (allPassed) {
                cameraPreview.classList.add('green-border');
            }
            
            if (allPassed) {
                successFrames++;
            } else {
                successFrames = 0;
            }
            
            const isConsistentSuccess = successFrames >= requiredSuccessFrames;
            
            // —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            let statusHTML = '';
            
            if (allPassed && isConsistentSuccess) {
                statusHTML = translations[currentLang].status_all_good;
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status success-bg';
                startCalibBtn.disabled = false;
            } else if (hasFailed) {
                const tips = collectTips();
                if (tips.length > 0) {
                    statusHTML = `
                        <div class="status-header">${translations[currentLang].status_needs_fix}</div>
                        <ul class="tips-list">
                            ${tips.map(tip => `<li class="tip-item">${tip}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    statusHTML = `<div class="status-header">${translations[currentLang].status_needs_fix}</div>`;
                }
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status error-bg';
                startCalibBtn.disabled = true;
            } else {
                statusHTML = translations[currentLang].status_checking;
                statusMessage.className = 'status-message';
                precheckStatus.className = 'precheck-status waiting-bg';
                startCalibBtn.disabled = true;
            }
            
            statusMessage.innerHTML = statusHTML;
            
            startCalibBtn.style.display = 'block';
        }
        
        // –ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ WebGazer
        async function startWebGazerCalibration() {
            console.log('–ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ WebGazer...');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ pre-check
            sessionData.precheck = {
                ...precheckData,
                timestamp: Date.now(),
                videoResolution: {
                    width: document.getElementById('precheckVideo')?.videoWidth,
                    height: document.getElementById('precheckVideo')?.videoHeight
                }
            };
            
            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—É—é –æ–±–ª–∞—Å—Ç—å
            document.getElementById('precheckContainer').style.display = 'none';
            document.getElementById('calibArea').style.display = 'block';
            document.getElementById('startPrecheckBtn').style.display = 'none';
            document.getElementById('startCalibBtn').style.display = 'none';
            
            if (isPrecheckRunning) {
                stopPreCheck();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebGazer
            await initWebGazer();
        }

        // --- WEBGAZER ---
        async function initWebGazer() {
            const btn = document.getElementById('startCalibBtn');
            const loading = document.getElementById('loadingMsg');
            const faceStatus = document.getElementById('faceStatusMsg');
            const customDot = document.getElementById('customGazeDot');
            
            if (btn) btn.style.display = 'none';
            loading.innerText = translations[currentLang].msg_init;
            faceStatus.style.display = 'block';

            try {
                await webgazer.setRegression('ridge')
                    .setGazeListener((data, clock) => {
                        const statusText = document.getElementById('faceStatusText');
                        if (data) {
                            faceDetected = true;
                            statusText.innerText = translations[currentLang].msg_face_ok;
                            statusText.className = "status-ok";

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
                            currentGaze.x = Math.round(data.x);
                            currentGaze.y = Math.round(data.y);
                            
                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞—à—É —Ç–æ—á–∫—É –≤–∑–≥–ª—è–¥–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏)
                            if (isRecording) {
                                customDot.style.display = 'block';
                                customDot.style.left = data.x + 'px';
                                customDot.style.top = data.y + 'px';
                            }
                        } else {
                            // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º faceDetected –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –Ω–∞–π–¥–µ–Ω–æ
                            statusText.innerText = translations[currentLang].msg_face_err;
                            statusText.className = "status-err";
                            currentGaze.x = null;
                            currentGaze.y = null;
                        }

                        if (data && isRecording) {
                            sessionData.eyeTracking.push({
                                x: Math.round(data.x),
                                y: Math.round(data.y),
                                t: Math.round(clock)
                            });
                            document.getElementById('pointsCounter').innerText = sessionData.eyeTracking.length;
                        }
                    })
                    .begin();

                // –ù–ï –æ—Ç–∫–ª—é—á–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –ø–æ –º—ã—à–∏ - –æ–Ω–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏!
                // webgazer.removeMouseEventListeners();
                
                webgazer.showVideo(true);
                webgazer.showFaceOverlay(true);
                webgazer.showFaceFeedbackBox(true);
                webgazer.showPredictionPoints(false);

                loading.innerText = translations[currentLang].msg_wait_stable;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏–¥–µ–æ-–ø–æ—Ç–æ–∫–∞ –≤–º–µ—Å—Ç–æ faceDetected
                waitForVideoAndStart();

            } catch (e) {
                alert("Camera Access Error: " + e.message);
                console.error(e);
                btn.style.display = 'block';
            }
        }

        function waitForVideoAndStart() {
            const loading = document.getElementById('loadingMsg');
            let attempts = 0;
            
            const checkInterval = setInterval(() => {
                attempts++;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏–¥–µ–æ-—ç–ª–µ–º–µ–Ω—Ç–∞ WebGazer
                const videoElement = document.getElementById('webgazerVideoFeed');
                const videoReady = videoElement && videoElement.readyState >= 2;
                
                if (videoReady || faceDetected) {
                    clearInterval(checkInterval);
                    faceDetected = true;
                    loading.innerText = translations[currentLang].msg_face_locked;
                    setTimeout(runCalibrationRoutine, 2000);
                } 
                
                if (attempts > 150) {
                    clearInterval(checkInterval);
                    loading.innerText = translations[currentLang].msg_no_face;
                    // –í—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(runCalibrationRoutine, 3000);
                }
            }, 100);
        }

        function runCalibrationRoutine() {
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-bar').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fullscreen –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
            const calibScreen = document.getElementById('fullscreenCalibration');
            const point = document.getElementById('fullscreenCalibPoint');
            const instructionText = document.getElementById('calibInstructionText');
            const progressText = document.getElementById('calibProgressText');
            
            calibScreen.classList.add('active');
            
            instructionText.innerText = currentLang === 'ru' 
                ? 'üëÜ –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É, —Å–º–æ—Ç—Ä—è –Ω–∞ –Ω–µ—ë' 
                : 'üëÜ Click on the red dot while looking at it';

            // 9 —Ç–æ—á–µ–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–æ –≤—Å–µ–º—É —ç–∫—Ä–∞–Ω—É (—Å–µ—Ç–∫–∞ 3x3)
            const positions = [
                { x: '10%', y: '10%' },   // –≤–µ—Ä—Ö-–ª–µ–≤–æ
                { x: '50%', y: '10%' },   // –≤–µ—Ä—Ö-—Ü–µ–Ω—Ç—Ä
                { x: '90%', y: '10%' },   // –≤–µ—Ä—Ö-–ø—Ä–∞–≤–æ
                { x: '10%', y: '50%' },   // —Ü–µ–Ω—Ç—Ä-–ª–µ–≤–æ
                { x: '50%', y: '50%' },   // —Ü–µ–Ω—Ç—Ä
                { x: '90%', y: '50%' },   // —Ü–µ–Ω—Ç—Ä-–ø—Ä–∞–≤–æ
                { x: '10%', y: '90%' },   // –Ω–∏–∑-–ª–µ–≤–æ
                { x: '50%', y: '90%' },   // –Ω–∏–∑-—Ü–µ–Ω—Ç—Ä
                { x: '90%', y: '90%' }    // –Ω–∏–∑-–ø—Ä–∞–≤–æ
            ];

            let i = 0;
            let clickCount = 0;
            
            const updatePoint = () => {
                point.style.left = positions[i].x;
                point.style.top = positions[i].y;
                progressText.innerText = currentLang === 'ru'
                    ? `–¢–æ—á–∫–∞ ${i + 1} –∏–∑ ${positions.length}`
                    : `Point ${i + 1} of ${positions.length}`;
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
            point.onclick = () => {
                clickCount++;
                
                // –ù—É–∂–Ω–æ 2 –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ª—É—á—à–µ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                if (clickCount >= 2) {
                    clickCount = 0;
                    i++;
                    
                    if (i >= positions.length) {
                        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                        point.onclick = null;
                        instructionText.innerText = currentLang === 'ru'
                            ? '‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç...'
                            : '‚úÖ Calibration done! Starting test...';
                        progressText.innerText = '';
                        isRecording = true;
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
                        setTimeout(() => {
                            calibScreen.classList.remove('active');
                            startTrackingTest();
                        }, 1500);
                        return;
                    }
                    
                    updatePoint();
                }
            };

            updatePoint();
        }

        // --- –¢–ï–°–¢ –°–õ–ï–ñ–ï–ù–ò–Ø –ó–ê –§–ò–ì–£–†–ê–ú–ò ---
        function startTrackingTest() {
            const testArea = document.getElementById('trackingTestArea');
            const shape = document.getElementById('testShape');
            const progressText = document.getElementById('testProgressText');
            const progressFill = document.getElementById('testProgressFill');
            const customDot = document.getElementById('customGazeDot');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-bar').style.display = 'none';
            testArea.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫—É –≤–∑–≥–ª—è–¥–∞
            customDot.style.display = 'block';
            customDot.style.zIndex = '3000';
            
            progressText.innerText = translations[currentLang].test_follow_shape;
            
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            
            // –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ñ–∏–≥—É—Ä
            const trajectories = [
                // 1. –ö—Ä—É–≥ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
                { shape: 'circle', duration: 4000, path: (t) => ({ 
                    x: 50 + (screenW - 100) * t, 
                    y: screenH / 2 
                })},
                // 2. –ö–≤–∞–¥—Ä–∞—Ç ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                { shape: 'square', duration: 4000, path: (t) => ({ 
                    x: screenW / 2, 
                    y: 50 + (screenH - 100) * t 
                })},
                // 3. –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ‚Äî –¥–∏–∞–≥–æ–Ω–∞–ª—å
                { shape: 'triangle', duration: 4000, path: (t) => ({ 
                    x: 50 + (screenW - 100) * t, 
                    y: 50 + (screenH - 100) * t 
                })},
                // 4. –ö—Ä—É–≥ ‚Äî –∫—Ä—É–≥–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                { shape: 'circle', duration: 5000, path: (t) => ({ 
                    x: screenW / 2 + Math.cos(t * 2 * Math.PI) * (screenW / 4), 
                    y: screenH / 2 + Math.sin(t * 2 * Math.PI) * (screenH / 4) 
                })},
                // 5. –ö–≤–∞–¥—Ä–∞—Ç ‚Äî –∑–∏–≥–∑–∞–≥
                { shape: 'square', duration: 5000, path: (t) => ({ 
                    x: 50 + (screenW - 100) * t, 
                    y: screenH / 2 + Math.sin(t * 4 * Math.PI) * (screenH / 4)
                })}
            ];
            
            let currentTrajectory = 0;
            const testStartTime = Date.now();
            
            function runTrajectory() {
                if (currentTrajectory >= trajectories.length) {
                    finishTrackingTest();
                    return;
                }
                
                const traj = trajectories[currentTrajectory];
                shape.className = 'test-shape ' + traj.shape;
                
                const startTime = performance.now();
                
                function animate() {
                    const elapsed = performance.now() - startTime;
                    const t = Math.min(elapsed / traj.duration, 1);
                    
                    const pos = traj.path(t);
                    shape.style.left = pos.x + 'px';
                    shape.style.top = pos.y + 'px';
                    
                    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ñ–∏–≥—É—Ä—ã –ò –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∑–≥–ª—è–¥–∞
                    sessionData.trackingTest.push({
                        trajectory: currentTrajectory,
                        shape: traj.shape,
                        shapeX: Math.round(pos.x),
                        shapeY: Math.round(pos.y),
                        gazeX: currentGaze.x,
                        gazeY: currentGaze.y,
                        t: Date.now() - testStartTime
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const totalProgress = ((currentTrajectory + t) / trajectories.length) * 100;
                    progressFill.style.width = totalProgress + '%';
                    
                    if (t < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        currentTrajectory++;
                        setTimeout(runTrajectory, 500);
                    }
                }
                
                animate();
            }
            
            runTrajectory();
        }
        
        function finishTrackingTest() {
            const testArea = document.getElementById('trackingTestArea');
            const progressText = document.getElementById('testProgressText');
            const customDot = document.getElementById('customGazeDot');
            
            progressText.innerText = translations[currentLang].test_complete;
            
            setTimeout(() => {
                testArea.classList.remove('active');
                document.querySelector('.container').style.display = 'block';
                document.querySelector('.top-bar').style.display = 'flex';
                customDot.style.display = 'none';
                
                finishSession();
            }, 1500);
        }

        function finishSession() {
            isRecording = false;
            webgazer.pause();
            document.getElementById('webgazerVideoContainer').style.display = 'none';
            document.getElementById('customGazeDot').style.display = 'none';
            nextStep(6);
        }

        function downloadData() {
            const fileName = `session_${sessionData.ids.session}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sessionData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", fileName);
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (isPrecheckRunning) {
                stopPreCheck();
            }
            if (webgazer) {
                webgazer.end();
            }
        });
    </script>
</body>
</html>

