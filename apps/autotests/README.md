# Автотестер HTML страницы

Автоматизированный набор тестов для проверки валидации и отказоустойчивости многошаговой формы на HTML странице.

## Что умеет

Автотестер проверяет 44 сценария:

- **Smoke тесты (11)** - базовая функциональность: открытие страницы, навигация, видимость элементов
- **Validation тесты (33)** - валидация и защита от некорректных данных:
  - Согласие: блокировка без галочки
  - Email: 11 различных невалидных форматов
  - Анкета: обязательные поля, диапазоны возраста (18-99), типы данных
  - Отказоустойчивость: вредный ввод, спецсимволы, XSS-попытки

Все тесты автоматически запускаются при каждом изменении кода.

## Быстрый старт

### Установка

```bash
npm install
```

### Запуск тестов

```bash
# Все тесты в headless режиме
npm test

# С видимым браузером
npm run test:headed

# Интерактивный режим
npm run test:ui
```

### Запуск отдельных тестов

```bash
# Только smoke тесты
npx playwright test smoke.spec.ts

# Только validation тесты
npx playwright test forbidden.spec.ts

# Конкретный тест
npx playwright test -g "Email: пустое поле"
```

### Просмотр результатов

После запуска тестов открывается HTML отчет:

```bash
npx playwright show-report
```

При падении тестов автоматически сохраняются:
- Скриншоты: `test-results/*/test-failed-*.png`
- Видео: `test-results/*/video.webm`
- Trace: `test-results/*/trace.zip` (открывается через `npx playwright show-trace <path>`)

## Настройка

### Путь к HTML файлу

По умолчанию используется `mvp_with_precheck_1.html` в корне проекта. Чтобы указать другой путь:

```bash
HTML_PATH=/path/to/file.html npm test
```

### Режим браузера

По умолчанию браузер запускается в headless режиме. Чтобы видеть браузер:

```bash
HEADLESS=false npm test
```

Или используйте `npm run test:headed`.

## Добавление новых тестов

Новые тестовые кейсы добавляются через YAML файл `tests/cases/forbidden.yml` без изменения кода.

Формат кейса:

```yaml
- name: "Название теста"
  startStep: step3  # С какого шага начать (опционально)
  actions:
    - action: fill
      target: "#userEmail"
      value: "invalid"
    - action: blur
      target: "#userEmail"
    - action: click
      target: "#step3NextBtn"
  expect:
    stayOnStep: "step3"           # Остаться на шаге
    buttonDisabled: "#formBtn"    # Кнопка disabled
    fieldError:                   # Ошибка на поле
      selector: "#userEmail"
      ariaInvalid: true
    noConsoleErrors: true         # Нет ошибок в консоли
```

Поддерживаемые действия:
- `fill` - заполнить поле
- `select` - выбрать опцию
- `click` - кликнуть
- `check` / `uncheck` - чекбокс
- `blur` - убрать фокус
- `waitFor` - подождать элемент
- `press` - нажать клавишу
- `fillLongString` - заполнить длинной строкой

Ожидаемые результаты:
- `stayOnStep` - остаться на указанном шаге
- `buttonDisabled` / `buttonEnabled` - состояние кнопки
- `errorMessage` - сообщение об ошибке
- `fieldError` - ошибка на поле (с `selector`, `ariaInvalid`, `hasClass`)
- `noConsoleErrors` - нет ошибок в консоли

## Изменения в HTML странице

В HTML страницу добавлена реальная валидация, которая блокирует прохождение формы с некорректными данными.

### Валидация возраста

- Проверка диапазона: возраст должен быть от 18 до 99 лет
- Проверка на целое число (дробные числа отклоняются)
- Проверка на отрицательные числа и ноль
- Визуальные индикаторы ошибок: красная рамка, сообщение под полем
- Кнопка "Далее" блокируется при невалидном возрасте

Поле возраста автоматически валидируется при вводе (`oninput`) и потере фокуса (`onblur`).

### Валидация email

- Проверка формата: должен содержать `@` и точку в домене
- Проверка на пустое поле
- Проверка на пробелы и двойные точки
- Проверка на emoji и кириллицу
- Визуальные индикаторы ошибок
- Переход на следующий шаг блокируется при невалидном email

Email валидируется при потере фокуса (`onblur`) и при попытке перехода дальше.

### Визуальные улучшения

- Поля с ошибками получают красную рамку и фон
- Атрибут `aria-invalid="true"` для доступности
- Сообщения об ошибках отображаются под полями
- Стили ошибок: `.error` класс и `[aria-invalid="true"]` селектор

### Технические детали

Изменены функции:
- `checkForm()` - добавлена валидация возраста с проверкой диапазона
- `validateEmail()` - новая функция валидации email
- `validateEmailField()` - валидация email при blur
- `showFieldError()` / `hideFieldError()` - показ/скрытие ошибок

Добавлены обработчики:
- `onblur="checkForm()"` и `oninput="checkForm()"` на поле возраста
- `onblur="validateEmailField()"` на поле email

Добавлена проверка `disabled` на кнопке формы перед переходом: `if (!document.getElementById('formBtn').disabled) nextStep(5);`

## Результаты

Все 44 теста проходят успешно. Форма теперь реально защищена от некорректных данных:
- Нельзя пройти дальше с невалидным возрастом (отрицательный, меньше 18, больше 99, ноль, дробное)
- Нельзя пройти дальше с невалидным email
- Визуальные индикаторы помогают пользователю понять проблему
- Все проверки работают автоматически

## Устранение проблем

Если тесты падают нестабильно, увеличьте таймауты в `playwright.config.ts`:
- `timeout` - таймаут на тест (по умолчанию 30 секунд)
- `navigationTimeout` - таймаут навигации (по умолчанию 30 секунд)

Если HTML файл не находится, убедитесь что он в корне проекта или укажите путь через `HTML_PATH`.

Для отладки используйте `npm run test:ui` - интерактивный режим позволяет пошагово выполнять тесты и смотреть что происходит.

